name: Debug-Fixed-RDP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: 1. 初始化环境
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        
    - name: 2. 下载谷歌远程桌面
      run: |
        Invoke-WebRequest https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi -OutFile crd.msi
        Start-Process msiexec.exe -ArgumentList "/i crd.msi /qn" -Wait
        
    - name: 3. 授权并启动 (修复引号报错)
      # 【关键修改】通过环境变量传递 Secrets，绝对不会报语法错误
      env:
        RAW_CODE: ${{ secrets.CRD_CODE }}
        MY_PIN: ${{ secrets.PIN }}
      run: |
        # 从环境变量读取，不经过代码解析，安全
        $cmd = $env:RAW_CODE
        $pin = $env:MY_PIN
        
        if (-not $cmd) {
            Write-Error "CRD_CODE 为空！请检查 Secrets！"
            exit 1
        }

        # 强制拼接 PIN 码，防止卡住
        if ($cmd -notmatch "--pin") {
            $finalCmd = "$cmd --pin=$pin"
        } else {
            $finalCmd = $cmd
        }
        
        Write-Host "正在执行授权..."
        # 运行命令
        Invoke-Expression $finalCmd

    - name: 4. 成功！保持连接
      run: |
        Write-Host "==================================================="
        Write-Host "运行成功！"
        Write-Host "请访问 https://remotedesktop.google.com/access"
        Write-Host "PIN码: ${{ secrets.PIN }}"
        Write-Host "==================================================="
        while ($true) {
          Start-Sleep -Seconds 60
        }
