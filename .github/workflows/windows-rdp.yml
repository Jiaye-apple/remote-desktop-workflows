name: Ultimate-Fix-RDP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360
    
    steps:
    - name: 1. 初始化环境
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        
    - name: 2. 下载安装谷歌远程桌面
      run: |
        Invoke-WebRequest https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi -OutFile crd.msi
        Start-Process msiexec.exe -ArgumentList "/i crd.msi /qn" -Wait
        
    - name: 3. 智能提取验证码并启动 (核弹级修复)
      env:
        # 读取你填的一长串复杂代码
        RAW_INPUT: ${{ secrets.CRD_CODE }}
      run: |
        $raw = $env:RAW_INPUT
        if (-not $raw) {
            Write-Error "CRD_CODE 是空的！请去 Secrets 填入谷歌的授权代码！"
            exit 1
        }

        # 【核心逻辑】不运行你的烂代码，而是用正则提取出 4/ 开头的验证码
        # 只要你的代码里包含 "4/xxxx...", 我就能把它挖出来
        if ($raw -match '(4/[a-zA-Z0-9_-]+)') {
            $authCode = $matches[1]
            Write-Host "成功提取验证码: $authCode"
        } else {
            Write-Error "无法识别验证码！请确认你复制的是完整的谷歌 PowerShell 代码！"
            exit 1
        }

        # 定义固定 PIN 码 (防止 Secret 没填导致报错)
        $fixedPin = "123456"
        
        # 定义谷歌程序的标准路径
        $exePath = "C:\Program Files (x86)\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
        
        # 组装一条绝对干净、没有语法错误的命令
        $args = "--code=$authCode --redirect-url=https://remotedesktop.google.com/_/oauthredirect --name=Github-Runner --pin=$fixedPin"
        
        Write-Host "正在执行纯净启动命令..."
        
        # 启动！
        & $exePath --code=$authCode --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="Github-Runner" --pin=$fixedPin

    - name: 4. 成功！保持连接
      run: |
        Write-Host "==================================================="
        Write-Host "【运行成功】"
        Write-Host "现在请去 https://remotedesktop.google.com/access"
        Write-Host "连接设备名: Github-Runner"
        Write-Host "PIN码 (固定): 123456"
        Write-Host "==================================================="
        while ($true) {
          Start-Sleep -Seconds 60
        }
