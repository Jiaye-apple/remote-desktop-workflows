name: Chrome-RDP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 360 # 挂机6小时
    
    steps:
    - name: 初始化设置
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        
    - name: 安装谷歌远程桌面
      run: |
        # 1. 下载安装包
        Invoke-WebRequest https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi -OutFile crd.msi
        
        # 2. 静默安装
        Start-Process msiexec.exe -ArgumentList "/i crd.msi /qn" -Wait
        
        # 3. 运行你填入的 CRD_CODE 进行授权
        $codeCommand = '${{ secrets.CRD_CODE }}'
        
        if (-not $codeCommand) {
            Write-Error "CRD_CODE 为空！请检查 GitHub Secrets 设置！"
            exit 1
        }
        
        # 执行授权命令
        Invoke-Expression $codeCommand

    - name: 成功！保持运行
      run: |
        Write-Host "==================================================="
        Write-Host "恭喜！环境已启动。"
        Write-Host "现在请去 https://remotedesktop.google.com/access"
        Write-Host "连接那台叫 'windows-latest' 的电脑，输入PIN码: ${{ secrets.PIN }}"
        Write-Host "==================================================="
        
        # 防止进程结束
        while ($true) {
          Start-Sleep -Seconds 60
        }
