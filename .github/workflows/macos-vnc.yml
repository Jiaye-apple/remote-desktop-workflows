name: Mac-Screenshot-Fix
on: workflow_dispatch

jobs:
  debug-job:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 2. å¯åŠ¨æˆªå±æœåŠ¡å™¨ (ä¿®å¤äº† pip æŠ¥é”™)
      - name: Start Screenshot Server
        run: |
          echo "æ­£åœ¨å®‰è£…ä¾èµ–..."
          # ã€å…³é”®ä¿®å¤ã€‘åŠ ä¸Š --break-system-packages å¼ºåˆ¶å®‰è£…ï¼Œå¿½ç•¥æŠ¥é”™
          pip3 install flask --break-system-packages
          
          # å†™å…¥ Python è„šæœ¬
          cat << 'EOF' > screen_server.py
          from flask import Flask, send_file
          import subprocess
          import time
          
          app = Flask(__name__)
          
          @app.route('/')
          def index():
              # è‡ªåŠ¨åˆ·æ–°ç½‘é¡µ (æ¯ 2 ç§’)
              return '''
              <html>
                <head>
                    <meta http-equiv="refresh" content="2">
                    <style>body{background:#222;color:#fff;text-align:center;margin:0;padding:20px;}</style>
                </head>
                <body>
                  <h1>macOS å®æ—¶æ¡Œé¢ (åªè¯»æ¨¡å¼)</h1>
                  <p>Electron è¿è¡Œåï¼Œä½ ä¼šåœ¨è¿™é‡Œçœ‹åˆ°ç”»é¢ ğŸ‘‡</p>
                  <img src="/shot" style="max-width:90%; border:4px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
                </body>
              </html>
              '''
          
          @app.route('/shot')
          def shot():
              # æˆªå±å¹¶ä¿å­˜
              subprocess.run(['screencapture', '-x', 'screen.png'])
              return send_file('screen.png')
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          
          # åå°å¯åŠ¨
          python3 screen_server.py &
          echo "âœ… æˆªå±æœåŠ¡å™¨å·²å¯åŠ¨ (ç«¯å£ 8080)"

      # 3. å¯åŠ¨ Cloudflare (å…è´¹éš§é“ï¼Œçœ‹ç”»é¢ç”¨)
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          
          echo "æ­£åœ¨ç”Ÿæˆé“¾æ¥..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸ‰ ç”»é¢ç›‘æ§é“¾æ¥å·²ç”Ÿæˆï¼å¤åˆ¶ä¸‹é¢çš„é“¾æ¥åˆ°æµè§ˆå™¨æ‰“å¼€ï¼š"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "æ— éœ€å¯†ç ï¼Œç›´æ¥è®¿é—®å³å¯çœ‹åˆ°æ¡Œé¢ï¼"
          echo "========================================================"

      # 4. (å¯é€‰) è‡ªåŠ¨ä¸‹è½½å¹¶è¿è¡Œä½ çš„ Electron é¡¹ç›®
      # å¦‚æœä½ æƒ³è®©è„šæœ¬è‡ªåŠ¨å¸®ä½ è·‘é¡¹ç›®ï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸‹è½½å‘½ä»¤
      # - name: Run My App
      #   run: ...

      - name: Keep Alive
        run: sleep 21600
