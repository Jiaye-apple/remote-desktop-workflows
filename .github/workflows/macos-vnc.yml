name: New-User-Login
on: workflow_dispatch

jobs:
  debug:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ã€æ ¸å¿ƒã€‘åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ç®¡ç†å‘˜è´¦æˆ· (ç»•è¿‡ runner è´¦æˆ·é™åˆ¶)
      - name: Create New Admin User
        run: |
          echo "æ­£åœ¨åˆ›å»ºæ–°ç”¨æˆ· macadmin..."
          # åˆ›å»ºç”¨æˆ·
          sudo dscl . -create /Users/macadmin
          sudo dscl . -create /Users/macadmin UserShell /bin/bash
          sudo dscl . -create /Users/macadmin RealName "Mac Admin"
          sudo dscl . -create /Users/macadmin UniqueID 505
          sudo dscl . -create /Users/macadmin PrimaryGroupID 20
          sudo dscl . -create /Users/macadmin NFSHomeDirectory /Users/macadmin
          
          # è®¾ç½®å¯†ç ä¸º 123456
          sudo dscl . -passwd /Users/macadmin 123456
          
          # èµ‹äºˆç®¡ç†å‘˜æƒé™
          sudo dscl . -append /Groups/admin GroupMembership macadmin
          echo "âœ… æ–°ç”¨æˆ· macadmin åˆ›å»ºæˆåŠŸï¼Œå¯†ç  123456"

      # 2. å¼€å¯ VNC å¹¶å…è®¸æ–°ç”¨æˆ·ç™»å½•
      - name: Start VNC Server
        run: |
          echo "æ­£åœ¨é…ç½® VNC..."
          # å…è®¸ macadmin ç”¨æˆ·è¿›è¡Œè¿œç¨‹ç™»å½•
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -users macadmin -privs -all -restart -agent -menu
          echo "âœ… VNC å·²å…è®¸ macadmin ç™»å½•"

      # 3. å®‰è£…å¹¶å¯åŠ¨ noVNC
      - name: Start noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          git clone https://github.com/novnc/websockify noVNC/utils/websockify
          ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

      # 4. å¯åŠ¨ Cloudflare éš§é“
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "ç”Ÿæˆé“¾æ¥ä¸­..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸ”— åªèƒ½ç”¨ä¸‹é¢è¿™ç»„è´¦å·ç™»å½•ï¼Œåˆ«ç”¨ runner äº†ï¼"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "ğŸ‘¤ ç”¨æˆ·å: macadmin"
          echo "ğŸ”‘ å¯†  ç : 123456"
          echo "========================================================"

      - name: Keep Alive
        run: sleep 21600
