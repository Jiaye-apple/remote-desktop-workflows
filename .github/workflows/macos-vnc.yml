# 2. å¯åŠ¨ç›‘æ§ (ä¸“é—¨é’ˆå¯¹ macOS ä¼˜åŒ–çš„é¥æ§ç‰ˆæœ¬)
      - name: Start Remote Monitor
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request, jsonify
          import subprocess
          import os

          app = Flask(__name__)

          # è·å– macOS å½“å‰å±å¹•åˆ†è¾¨ç‡ï¼Œç¡®ä¿ç‚¹å‡»ä½ç½®ç²¾å‡†
          def get_screen_resolution():
              try:
                  cmd = "system_profiler SPDisplaysDataType | grep Resolution"
                  res = subprocess.check_output(cmd, shell=True).decode()
                  # æå–æ•°å­—ï¼Œä¾‹å¦‚ "2560 x 1600"
                  parts = res.split(':')[-1].strip().split('x')
                  return int(parts[0]), int(parts[1])
              except:
                  return 1280, 960  # é»˜è®¤ä¿åº•åˆ†è¾¨ç‡

          @app.route('/')
          def index():
              return '''
              <html>
              <head>
                  <title>macOS Remote Controller</title>
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <style>
                      body { background: #121212; color: #fff; font-family: sans-serif; margin: 0; text-align: center; }
                      .header { background: #333; padding: 10px; font-weight: bold; border-bottom: 2px solid #007bff; }
                      .screen-container { position: relative; display: inline-block; margin-top: 15px; border: 3px solid #444; cursor: crosshair; }
                      #screen { max-width: 95vw; max-height: 75vh; display: block; }
                      .dock { margin-top: 15px; padding: 15px; background: #222; display: flex; justify-content: center; gap: 10px; }
                      input { padding: 8px; border-radius: 4px; border: none; width: 200px; }
                      button { padding: 8px 15px; border-radius: 4px; border: none; background: #007bff; color: white; cursor: pointer; }
                      button.green { background: #28a745; }
                  </style>
              </head>
              <body>
                  <div class="header">macOS è¿œç¨‹æ§åˆ¶é¢æ¿ (GitHub Actions)</div>
                  <div class="screen-container">
                      <img id="screen" src="/shot" onclick="doClick(event)">
                  </div>
                  <div class="dock">
                      <input type="text" id="textInput" placeholder="è¾“å…¥æ–‡å­—...">
                      <button class="green" onclick="sendText()">è¾“å…¥æ–‡æœ¬</button>
                      <button onclick="sendKey('36')">å›è½¦(Enter)</button>
                      <button onclick="sendKey('48')">Tab</button>
                      <button style="background:#dc3545;" onclick="location.reload()">æ‰‹åŠ¨åˆ·æ–°</button>
                  </div>
                  <p style="color:#888; font-size:12px;">æ“ä½œæç¤ºï¼šç›´æ¥ç‚¹å‡»ç”»é¢å³å¯ç§»åŠ¨å¹¶ç‚¹å‡»é¼ æ ‡</p>

                  <script>
                      // è‡ªåŠ¨åˆ·æ–°ç”»é¢ (1.5ç§’ä¸€æ¬¡)
                      setInterval(() => {
                          document.getElementById("screen").src = "/shot?t=" + new Date().getTime();
                      }, 1500);

                      function doClick(e) {
                          const img = document.getElementById("screen");
                          const rect = img.getBoundingClientRect();
                          const x = (e.clientX - rect.left) / rect.width;
                          const y = (e.clientY - rect.top) / rect.height;
                          fetch(`/control?type=click&x_ratio=${x}&y_ratio=${y}`);
                      }

                      function sendText() {
                          const txt = document.getElementById("textInput").value;
                          if(!txt) return;
                          fetch(`/control?type=type&content=${encodeURIComponent(txt)}`);
                          document.getElementById("textInput").value = "";
                      }

                      function sendKey(code) {
                          fetch(`/control?type=key&code=${code}`);
                      }
                  </script>
              </body>
              </html>
              '''

          @app.route('/shot')
          def shot():
              # macOS åŸç”Ÿé™éŸ³æˆªå›¾
              subprocess.run(['screencapture', '-x', 'screen.png'])
              return send_file('screen.png')

          @app.route('/control')
          def control():
              ctrl_type = request.args.get('type')
              w, h = get_screen_resolution()

              if ctrl_type == 'click':
                  x = int(float(request.args.get('x_ratio')) * w)
                  y = int(float(request.args.get('y_ratio')) * h)
                  # ä½¿ç”¨ cliclick æ¨¡æ‹Ÿç‚¹å‡»
                  subprocess.run(['cliclick', f'c:{x},{y}'])
              
              elif ctrl_type == 'type':
                  content = request.args.get('content').replace('"', '\\"')
                  # ä½¿ç”¨ AppleScript (osascript) æ¨¡æ‹Ÿé”®ç›˜è¾“å…¥
                  subprocess.run(['osascript', '-e', f'tell application "System Events" to keystroke "{content}"'])
              
              elif ctrl_type == 'key':
                  code = request.args.get('code')
                  # ä½¿ç”¨ AppleScript å‘é€ç‰¹å®šæŒ‰é”®ç  (36æ˜¯å›è½¦, 48æ˜¯Tab)
                  subprocess.run(['osascript', '-e', f'tell application "System Events" to key code {code}'])
              
              return jsonify(status="success")

          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          python3 remote_server.py &
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 5
          echo "========================================="
          echo "ğŸ® è¿œç¨‹é¥æ§é“¾æ¥å·²å°±ç»ªï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================="
