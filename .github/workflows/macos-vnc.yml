name: Mac-Debug-NoToken
on: workflow_dispatch

jobs:
  build:
    runs-on: macos-latest
    # è®¾ç½®æœ€å¤§è¿è¡Œæ—¶é—´ï¼ˆGitHub é™åˆ¶ï¼‰
    timeout-minutes: 360 
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. å¼€å¯ Mac è‡ªå¸¦çš„å±å¹•å…±äº« (VNC)
      - name: Start VNC Server
        run: |
          echo "æ­£åœ¨å¼€å¯ VNC æœåŠ¡..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # è®¾ç½®å¯†ç ä¸º secret
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw secret
          echo "âœ… VNC å¯åŠ¨æˆåŠŸï¼Œå¯†ç : secret"

      # 2. å®‰è£… noVNC (æŠŠ VNC è½¬æˆç½‘é¡µè§†é¢‘æµ)
      - name: Install noVNC
        run: |
          brew install novnc
          # å¯åŠ¨è½¬æ¢å™¨ï¼šæŠŠå†…éƒ¨çš„ 5900(VNC) è½¬å‘åˆ° 6080(ç½‘é¡µ)
          /usr/local/opt/novnc/bin/novnc_proxy --vnc localhost:5900 --listen 6080 &
          echo "âœ… noVNC è½¬æ¢æœåŠ¡å·²å¯åŠ¨"

      # 3. å¯åŠ¨ Cloudflare éš§é“ (ä¸éœ€è¦ Tokenï¼Œç›´æ¥ç©¿é€ 6080 ç«¯å£)
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          # å…³é”®ç‚¹ï¼šè¿™é‡Œç©¿é€çš„æ˜¯ http ç«¯å£ï¼Œè€Œä¸æ˜¯ tcp
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "æ­£åœ¨è¯·æ±‚ Cloudflare åˆ†é…å…è´¹ç½‘å€..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸ‰ æˆåŠŸï¼è¯·å¤åˆ¶ä¸‹é¢çš„é“¾æ¥ï¼Œç›´æ¥åœ¨æµè§ˆå™¨æ‰“å¼€ï¼š"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "ğŸ”‘ ç½‘é¡µä¸Šç‚¹å‡» Connectï¼Œå¯†ç è¾“å…¥: secret"
          echo "========================================================"

      # 4. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: sleep 21600
