name: Fix-Black-Screen
on: workflow_dispatch

jobs:
  debug:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ã€æ ¸å¿ƒä¿®å¤ã€‘ä½¿ç”¨ sysadminctl å¼ºåŠ›é‡ç½® runner å¯†ç 
      # æˆ‘ä»¬ç”¨å¤æ‚å¯†ç  "MyStrongPass123!" ç»•è¿‡å®‰å…¨æ£€æŸ¥
      - name: Force Reset Runner Password
        run: |
          echo "æ­£åœ¨é‡ç½® runner å¯†ç ..."
          sudo sysadminctl -resetPasswordFor runner -newPassword "MyStrongPass123!"
          echo "âœ… runner å¯†ç å·²æˆåŠŸé‡ç½®ï¼"

      # 2. ç¦æ­¢ç¡çœ å’Œå±ä¿ (é˜²æ­¢é»‘å±)
      - name: Disable Sleep & Screensaver
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime 0
          echo "âœ… å·²ç¦æ­¢è‡ªåŠ¨é»‘å±"

      # 3. å¼€å¯ VNC
      - name: Start VNC Server
        run: |
          # é‡å¯å±å¹•å…±äº«æœåŠ¡
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # è®¾ç½® VNC è¿æ¥å¯†ç 
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw MyStrongPass123!
          echo "âœ… VNC å¯åŠ¨å®Œæ¯•"

      # 4. å¯åŠ¨ noVNC
      - name: Start noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          git clone https://github.com/novnc/websockify noVNC/utils/websockify
          ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

      # 5. å¯åŠ¨ Cloudflare
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "ç”Ÿæˆé“¾æ¥ä¸­..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸ”— åªæœ‰è¿™ä¸ªé“¾æ¥èƒ½è¿›ï¼Œå¤åˆ¶å®ƒï¼š"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "ğŸ‘¤ ç”¨æˆ·å: runner"
          echo "ğŸ”‘ å¯†  ç : MyStrongPass123!"
          echo "========================================================"

      - name: Keep Alive
        run: sleep 21600
