name: Mac-Electron-Fix-Chcp
on: workflow_dispatch

jobs:
  debug-job:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      # 1. æ‹‰å–ä½ çš„ä»“åº“
      - name: Checkout Target Repository
        uses: actions/checkout@v3
        with:
          repository: Jiaye-apple/wf--my-electron-app

      # 2. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 3. å¯åŠ¨æˆªå±ç›‘æ§ (è®©ä½ èƒ½çœ‹åˆ°ç”»é¢)
      - name: Start Screenshot Server
        run: |
          pip3 install flask --break-system-packages
          
          cat << 'EOF' > screen_server.py
          from flask import Flask, send_file
          import subprocess
          
          app = Flask(__name__)
          
          @app.route('/')
          def index():
              return '''
              <html>
                <head><meta http-equiv="refresh" content="2"></head>
                <body style="background:#222;color:#fff;text-align:center;">
                  <h1>Electron è¿è¡Œç›‘æ§</h1>
                  <p>ğŸ‘‡ ä½ çš„è½¯ä»¶çª—å£åº”è¯¥æ˜¾ç¤ºåœ¨ä¸‹é¢ ğŸ‘‡</p>
                  <img src="/shot" style="max-width:95%; border:2px solid #fff;">
                </body>
              </html>
              '''
          
          @app.route('/shot')
          def shot():
              # æˆªå±
              subprocess.run(['screencapture', '-x', 'screen.png'])
              return send_file('screen.png')
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          
          python3 screen_server.py &

      # 4. å¯åŠ¨ Cloudflare (ç»™ä½ è§‚çœ‹é“¾æ¥)
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 10
          echo "========================================================"
          echo "ğŸ‰ è§‚çœ‹é“¾æ¥ï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================================"

      # 5. ã€æ ¸å¿ƒä¿®å¤ã€‘ç›´æ¥å¯åŠ¨ Electron (é¿å¼€ chcp æŠ¥é”™)
      - name: Install & Run Electron
        run: |
          echo "ğŸš€ æ­£åœ¨å®‰è£…ä¾èµ–..."
          npm install
          
          echo "ğŸš€ æ­£åœ¨å¯åŠ¨ Electron..."
          
          # ğŸ”´ å…³é”®ä¿®æ”¹ï¼š
          # ä¸å†ä½¿ç”¨ npm start (å› ä¸ºå®ƒåŒ…å« Windows å‘½ä»¤ chcp)
          # æˆ‘ä»¬ç›´æ¥è°ƒç”¨ electron äºŒè¿›åˆ¶æ–‡ä»¶
          ./node_modules/.bin/electron . &
          
          echo "âœ… å¯åŠ¨å‘½ä»¤å·²å‘é€ï¼è¯·å»ç½‘é¡µæŸ¥çœ‹ç”»é¢ã€‚"

      # 6. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: sleep 21600
