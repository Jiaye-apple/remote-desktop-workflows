name: macOS-Remote-Desktop-Cloudflare
on: workflow_dispatch

jobs:
  desktop:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. 禁止休眠
      - name: Disable Sleep & Screensaver
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime 0
          echo "✅ 已禁止休眠和屏保"

      # 2. 启动 VNC 服务
      - name: Start VNC Server
        run: |
          # 激活远程管理
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -clientopts -setvnclegacy -vnclegacy yes \
            -restart -agent -privs -all -allowAccessFor -allUsers
          
          # 设置 VNC 密码
          VNC_PASSWORD="MacVNC2024!"
          echo "$VNC_PASSWORD" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpw
          
          # 重启服务确保生效
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          
          echo "✅ VNC 服务已启动"
          echo "VNC_PASSWORD=$VNC_PASSWORD" >> $GITHUB_ENV
          sleep 5

      # 3. 验证 VNC 端口
      - name: Verify VNC Port
        run: |
          echo "检查 VNC 端口 5900..."
          for i in {1..10}; do
            if sudo lsof -i :5900 | grep -q LISTEN; then
              echo "✅ VNC 正在监听端口 5900"
              sudo lsof -i :5900
              break
            else
              echo "⏳ 等待 VNC 启动... ($i/10)"
              sleep 2
            fi
          done
          
          if ! sudo lsof -i :5900 | grep -q LISTEN; then
            echo "❌ VNC 未能启动，尝试其他方法..."
            sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
            sleep 3
          fi

      # 4. 安装并启动 noVNC
      - name: Setup and Start noVNC
        run: |
          echo "正在安装 noVNC..."
          git clone --depth 1 https://github.com/novnc/noVNC.git
          git clone --depth 1 https://github.com/novnc/websockify.git noVNC/utils/websockify
          
          # 安装 Python 依赖
          python3 -m pip install numpy --break-system-packages 2>/dev/null || pip3 install numpy
          
          echo "启动 noVNC..."
          cd noVNC
          nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 > ../novnc.log 2>&1 &
          
          sleep 5
          
          # 验证 noVNC 启动
          if lsof -i :6080 > /dev/null 2>&1; then
            echo "✅ noVNC 已启动在端口 6080"
          else
            echo "❌ noVNC 启动失败"
            cat ../novnc.log
            exit 1
          fi

      # 5. 启动 Cloudflare Tunnel（关键步骤）
      - name: Start Cloudflare Tunnel
        run: |
          echo "正在安装 cloudflared..."
          brew install cloudflared
          
          echo "正在启动 Cloudflare 隧道..."
          nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "等待隧道建立..."
          sleep 20
          
          # 提取隧道链接
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "❌ 未能获取隧道地址，查看日志："
            cat tunnel.log
            exit 1
          fi
          
          # 显示访问信息
          echo "=========================================================="
          echo "🌐 远程桌面访问地址："
          echo "=========================================================="
          echo ""
          echo "   $TUNNEL_URL"
          echo ""
          echo "=========================================================="
          echo "🔑 VNC 密码: $VNC_PASSWORD"
          echo "=========================================================="
          echo ""
          echo "📖 使用说明："
          echo "   1. 复制上面的 trycloudflare.com 链接"
          echo "   2. 在浏览器中打开"
          echo "   3. 点击 'Connect' 按钮"
          echo "   4. 输入密码: $VNC_PASSWORD"
          echo "=========================================================="
          
          # 保存链接到环境变量
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV

      # 6. 健康检查和保持运行
      - name: Keep Alive with Health Check
        run: |
          echo "✅ 所有服务已启动，开始监控..."
          echo ""
          echo "=========================================================="
          echo "🔗 访问链接: $TUNNEL_URL"
          echo "🔑 密码: $VNC_PASSWORD"
          echo "=========================================================="
          echo ""
          
          # 持续运行并监控服务状态
          for i in {1..360}; do
            sleep 60
            
            # 检查 noVNC
            if ! pgrep -f novnc_proxy > /dev/null; then
              echo "⚠️  [$i/360] noVNC 进程丢失，重启中..."
              cd noVNC && nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 > ../novnc.log 2>&1 &
              sleep 3
            fi
            
            # 检查 Cloudflare
            if ! pgrep -f cloudflared > /dev/null; then
              echo "⚠️  [$i/360] Cloudflare 隧道丢失，重启中..."
              nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
              sleep 10
              NEW_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
              if [ ! -z "$NEW_URL" ]; then
                echo "🔗 新的访问链接: $NEW_URL"
              fi
            fi
            
            # 每 10 分钟显示一次状态
            if [ $((i % 10)) -eq 0 ]; then
              echo "✅ [$i/360] 服务运行正常 (已运行 $i 分钟)"
            fi
          done
          
          echo "⏰ 达到最大运行时间（6小时），工作流结束"
