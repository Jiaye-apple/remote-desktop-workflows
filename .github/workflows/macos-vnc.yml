name: macOS-Remote-Desktop-ngrok
on: 
  workflow_dispatch:
    inputs:
      ngrok_token:
        description: 'ngrok Authtoken (从 https://dashboard.ngrok.com/get-started/your-authtoken 获取)'
        required: true
        type: string

jobs:
  desktop:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. 禁止休眠
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime 0
          echo "✅ 已禁止休眠"

      # 2. 启动 VNC
      - name: Start VNC Server
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -clientopts -setvnclegacy -vnclegacy yes \
            -restart -agent -privs -all -allowAccessFor -allUsers
          
          VNC_PASSWORD="MacVNC2024!"
          echo "$VNC_PASSWORD" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvncpw
          
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          echo "VNC_PASSWORD=$VNC_PASSWORD" >> $GITHUB_ENV
          sleep 5

      # 3. 安装 ngrok
      - name: Setup ngrok
        run: |
          brew install ngrok/ngrok/ngrok
          
          # 配置 ngrok authtoken
          ngrok config add-authtoken ${{ github.event.inputs.ngrok_token }}
          
          echo "✅ ngrok 已配置"

      # 4. 启动 ngrok HTTP 隧道（免费方案）
      - name: Start ngrok Tunnel
        run: |
          # 先启动 noVNC
          git clone --depth 1 https://github.com/novnc/noVNC.git
          git clone --depth 1 https://github.com/novnc/websockify.git noVNC/utils/websockify
          python3 -m pip install numpy --break-system-packages 2>/dev/null || pip3 install numpy
          
          cd noVNC
          nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 > ../novnc.log 2>&1 &
          sleep 5
          
          # 使用 ngrok HTTP 隧道（免费）
          cd ..
          nohup ngrok http 6080 > ngrok.log 2>&1 &
          
          sleep 10
          
          # 获取 ngrok 链接
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"https://[^"]*"' | head -n1 | cut -d'"' -f4)
          
          if [ -z "$NGROK_URL" ]; then
            echo "❌ 未能获取 ngrok 地址"
            cat ngrok.log
            exit 1
          fi
          
          echo "=========================================================="
          echo "🌐 远程桌面访问地址："
          echo "=========================================================="
          echo ""
          echo "   $NGROK_URL"
          echo ""
          echo "=========================================================="
          echo "🔑 VNC 密码: $VNC_PASSWORD"
          echo "=========================================================="
          
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV

      # 5. 保持运行
      - name: Keep Alive
        run: |
          echo "✅ 服务运行中..."
          echo "🔗 访问链接: $NGROK_URL"
          sleep 21600
