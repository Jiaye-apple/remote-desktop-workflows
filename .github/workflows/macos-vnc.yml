name: Mac-NewUser-Fix
on: workflow_dispatch

jobs:
  debug-job:
    # ä½¿ç”¨ macOS 13 (Ventura)ï¼Œè¿™æ˜¯ç›®å‰èƒ½ç”¨çš„æœ€ç¨³å®šçš„ç‰ˆæœ¬
    runs-on: macos-13
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1.ã€æ ¸å¿ƒå¤§æ‹›ã€‘åˆ›å»ºä¸€ä¸ªæ–°çš„ç®¡ç†å‘˜è´¦æˆ· (ç»•è¿‡ runner è´¦æˆ·é”æ­»çš„é—®é¢˜)
      - name: Create New Admin User
        run: |
          echo "æ­£åœ¨åˆ›å»ºæ–°ç”¨æˆ· adminuser..."
          # ä½¿ç”¨ sysadminctl å·¥å…·åˆ›å»ºç”¨æˆ· (æ¯” dscl æ›´é«˜çº§ï¼Œä¸å®¹æ˜“æŠ¥é”™)
          sudo sysadminctl -addUser adminuser -fullName "Admin User" -password "123456" -admin
          echo "âœ… æ–°ç®¡ç†å‘˜ adminuser åˆ›å»ºæˆåŠŸï¼Œå¯†ç : 123456"

      # 2. ç¦æ­¢ç¡çœ  (é˜²æ­¢é»‘å±)
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 3. å¯åŠ¨ VNC å¹¶å…è®¸æ–°ç”¨æˆ·ç™»å½•
      - name: Start VNC Server
        run: |
          echo "æ­£åœ¨é…ç½® VNC..."
          # æ¿€æ´»æœåŠ¡
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # ã€é‡ç‚¹ã€‘ç‰¹åˆ«å…è®¸ adminuser è®¿é—®
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -users adminuser -access -on -privs -all
          
          echo "âœ… VNC å·²å¯åŠ¨ï¼Œå…è®¸ adminuser ç™»å½•"

      # 4. å®‰è£… noVNC (è½¬ç½‘é¡µç‰ˆ)
      - name: Install noVNC
        run: |
          git clone --depth 1 https://github.com/novnc/noVNC.git
          git clone --depth 1 https://github.com/novnc/websockify noVNC/utils/websockify
          ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

      # 5. å¯åŠ¨ Cloudflare
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "ç”Ÿæˆé“¾æ¥ä¸­..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸ‰ é“¾æ¥å·²ç”Ÿæˆï¼è¯·åŠ¡å¿…ä½¿ç”¨ä¸‹é¢çš„è´¦å·ç™»å½•ï¼š"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "ğŸ‘¤ ç”¨æˆ·å (Username): adminuser"
          echo "ğŸ”‘ å¯†  ç  (Password): 123456"
          echo "âš ï¸ æ³¨æ„ï¼šä¸è¦ç”¨é»˜è®¤çš„ runnerï¼Œä¸€å®šè¦å¡« adminuserï¼"
          echo "========================================================"

      - name: Keep Alive
        run: sleep 21600
