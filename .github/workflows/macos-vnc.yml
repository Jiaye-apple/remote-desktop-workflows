name: Web-Remote-Control
on: workflow_dispatch

jobs:
  debug-job:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          repository: Jiaye-apple/wf--my-electron-app

      # 1. å®‰è£…é¼ æ ‡æ§åˆ¶å·¥å…· (cliclick)
      # è¿™æ˜¯å®ç°â€œè¿œç¨‹ç‚¹å‡»â€çš„æ ¸å¿ƒå·¥å…·
      - name: Install Utilities
        run: |
          brew install cliclick
          brew install cloudflared
          pip3 install flask --break-system-packages

      # 2. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 3. ä¿®å¤ Windows å‘½ä»¤æŠ¥é”™ (chcp)
      # è¿™ä¸€æ­¥è§£å†³ä½ ä¹‹å‰ npm start è·‘ä¸èµ·æ¥çš„é—®é¢˜
      - name: Fix Windows Command
        run: |
          if [ -f "package.json" ]; then
            echo "ğŸ”§ æ­£åœ¨ç§»é™¤ package.json ä¸­çš„ Windows å‘½ä»¤..."
            sed -i '' 's/chcp 65001 && //g' package.json
            echo "âœ… ä¿®å¤å®Œæˆ"
          else
            echo "âš ï¸ æ²¡æ‰¾åˆ° package.jsonï¼Œè·³è¿‡ä¿®å¤"
          fi

      # 4. å¯åŠ¨â€œWeb é¥æ§å™¨â€æœåŠ¡å™¨
      - name: Start Web Remote
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request
          import subprocess
          import time
          
          app = Flask(__name__)
          
          # ç½‘é¡µå‰ç«¯ï¼šåŒ…å«ç”»é¢å’Œç‚¹å‡»é€»è¾‘
          @app.route('/')
          def index():
              return '''
              <html>
              <head>
                  <title>Mac ç½‘é¡µé¥æ§å™¨</title>
                  <style>
                      body { background: #222; text-align: center; color: white; margin: 0; overflow: hidden; }
                      #screen { cursor: crosshair; border: 2px solid cyan; max-width: 100%; }
                      #status { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; }
                  </style>
              </head>
              <body>
                  <div id="status">ğŸ”´ æ­£åœ¨è¿æ¥...</div>
                  <img id="screen" src="/shot" onclick="handleClick(event)">
                  
                  <script>
                      const img = document.getElementById('screen');
                      const status = document.getElementById('status');
                      
                      // 1. è‡ªåŠ¨åˆ·æ–°ç”»é¢ (æ¨¡æ‹Ÿè§†é¢‘æµ)
                      setInterval(() => {
                          img.src = '/shot?t=' + new Date().getTime();
                          status.innerText = "ğŸŸ¢ å®æ—¶ç›‘æ§ä¸­";
                      }, 1500); // 1.5ç§’åˆ·æ–°ä¸€æ¬¡
                      
                      // 2. å¤„ç†é¼ æ ‡ç‚¹å‡»
                      function handleClick(event) {
                          const rect = img.getBoundingClientRect();
                          // è®¡ç®—ç‚¹å‡»ä½ç½®åœ¨å›¾ç‰‡ä¸­çš„æ¯”ä¾‹
                          const scaleX = img.naturalWidth / rect.width;
                          const scaleY = img.naturalHeight / rect.height;
                          
                          const realX = Math.round((event.clientX - rect.left) * scaleX);
                          const realY = Math.round((event.clientY - rect.top) * scaleY);
                          
                          status.innerText = `ğŸ–±ï¸ ç‚¹å‡»: ${realX}, ${realY}`;
                          
                          // å‘é€ç‚¹å‡»æŒ‡ä»¤ç»™ Mac
                          fetch(`/click?x=${realX}&y=${realY}`);
                      }
                  </script>
              </body>
              </html>
              '''
          
          # æ¥å£ï¼šè·å–æˆªå›¾
          @app.route('/shot')
          def shot():
              subprocess.run(['screencapture', '-x', '-C', 'screen.png'])
              return send_file('screen.png')
          
          # æ¥å£ï¼šæ‰§è¡Œç‚¹å‡»
          @app.route('/click')
          def click():
              x = request.args.get('x')
              y = request.args.get('y')
              print(f"Executing click at {x}, {y}")
              # è°ƒç”¨ cliclick å·¥å…·ç‚¹å‡»å±å¹•
              subprocess.run(['cliclick', f'c:{x},{y}'])
              return "ok"
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          
          # åå°å¯åŠ¨
          python3 remote_server.py &
          echo "âœ… é¥æ§æœåŠ¡å™¨å·²å¯åŠ¨"

      # 5. å¯åŠ¨ Cloudflare éš§é“ (æä¾›è®¿é—®é“¾æ¥)
      - name: Start Tunnel
        run: |
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 10
          echo "========================================================"
          echo "ğŸ® é¥æ§å™¨é“¾æ¥å·²ç”Ÿæˆï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================================"

      # 6. å®‰è£…ä¾èµ–å¹¶å¯åŠ¨ Electron (å¸¦è‡ªåŠ¨ä¿®å¤)
      - name: Run Electron
        run: |
          echo "ğŸš€ å®‰è£…ä¾èµ–..."
          npm install
          
          echo "ğŸš€ å¯åŠ¨ Electron..."
          # ä½¿ç”¨ electron ç›´æ¥å¯åŠ¨ï¼Œè§„é¿ npm start å¯èƒ½æ®‹ç•™çš„é—®é¢˜
          ./node_modules/.bin/electron . &
          
          echo "âœ… Electron å·²å‘é€å¯åŠ¨æŒ‡ä»¤ï¼Œè¯·å»ç½‘é¡µæ“ä½œï¼"

      # 7. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: sleep 21600
