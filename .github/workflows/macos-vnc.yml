name: Build-Full-Project

# 1. è¿™é‡Œçš„æ ¼å¼å¿…é¡»ç»å¯¹æ­£ç¡®ï¼ŒæŒ‰é’®æ‰ä¼šå‡ºç°
on:
  workflow_dispatch: # è¿™ä¸ªå°±æ˜¯å¼€å¯â€œæ‰‹åŠ¨è¿è¡ŒæŒ‰é’®â€çš„å…³é”®

jobs:
  build-and-run:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: Jiaye-apple/wftest
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Tools
        run: |
          brew install cliclick cloudflared
          python3 -m pip install flask --break-system-packages

# 2. å¯åŠ¨ç›‘æ§ (V4 ç»ˆæä¿®å¤ç‰ˆï¼šè§£å†³é»‘å±ã€æ˜¾ç¤ºä¸å…¨ã€åæ ‡åç§»)
      - name: Start Remote Monitor
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request, jsonify
          import subprocess, os, re

          app = Flask(__name__)

          def get_actual_res():
              try:
                  # å¼ºåˆ¶è·å– macOS è™šæ‹Ÿæ˜¾ç¤ºå™¨çš„çœŸå®ç‰©ç†åˆ†è¾¨ç‡
                  out = subprocess.check_output("system_profiler SPDisplaysDataType | grep Resolution", shell=True).decode()
                  match = re.search(r'(\d+) x (\d+)', out)
                  if match: return int(match.group(1)), int(match.group(2))
              except: pass
              return 1280, 960

          @app.route('/')
          def index():
              w, h = get_actual_res()
              return f'''
              <html>
              <head>
                  <title>macOS Master Control</title>
                  <style>
                      body {{ background: #000; color: #00ff00; font-family: monospace; margin: 0; overflow: hidden; }}
                      .top-bar {{ background: #222; padding: 10px; display: flex; gap: 15px; align-items: center; border-bottom: 1px solid #444; position: fixed; top:0; width:100%; z-index:100; }}
                      .canvas-container {{ margin-top: 60px; width: 100vw; height: calc(100vh - 60px); overflow: auto; background: #111; }}
                      #screen {{ border: 2px solid #555; display: block; }}
                      .btn {{ background: #444; color: white; border: 1px solid #666; padding: 5px 10px; cursor: pointer; border-radius: 3px; }}
                      .btn:hover {{ background: #666; }}
                      .btn-primary {{ background: #007bff; border-color: #0056b3; }}
                      #coord {{ color: #ffcc00; font-size: 12px; }}
                  </style>
              </head>
              <body>
                  <div class="top-bar">
                      <b>MAC-REMOTE V4</b>
                      <input type="text" id="ti" placeholder="è¾“å…¥æ–‡å­—..." style="width:150px; background:#000; color:#fff; border:1px solid #555;">
                      <button class="btn" onclick="send('type')">è¾“å…¥</button>
                      <button class="btn btn-primary" onclick="send('enter')">å›è½¦(Enter)</button>
                      <button class="btn" onclick="send('space')">ç©ºæ ¼</button>
                      <button class="btn" onclick="send('cmd_v')" style="background:#d9534f">ç²˜è´´</button>
                      <button class="btn" onclick="location.reload()">å¼ºåˆ¶åˆ·æ–°</button>
                      <div id="coord">X: 0, Y: 0 | Res: {w}x{h}</div>
                  </div>
                  <div class="canvas-container">
                      <img id="screen" src="/shot" onclick="handleClick(event)" onmousemove="updateCoord(event)">
                  </div>
                  <script>
                      const W = {w}; const H = {h};
                      setInterval(() => {{
                          document.getElementById("screen").src = "/shot?t=" + new Date().getTime();
                      }}, 1000);

                      function updateCoord(e) {{
                          const rect = e.target.getBoundingClientRect();
                          const x = Math.round((e.clientX - rect.left) * (W / rect.width));
                          const y = Math.round((e.clientY - rect.top) * (H / rect.height));
                          document.getElementById("coord").innerText = `X: ${{x}}, Y: ${{y}} | Res: ${{W}}x${{H}}`;
                      }}

                      function handleClick(e) {{
                          const rect = e.target.getBoundingClientRect();
                          const xr = (e.clientX - rect.left) / rect.width;
                          const yr = (e.clientY - rect.top) / rect.height;
                          fetch(`/ctl?a=click&x=${{xr}}&y=${{yr}}`);
                      }}

                      function send(t) {{
                          const v = document.getElementById("ti").value;
                          fetch(`/ctl?a=${{t}}&v=${{encodeURIComponent(v)}}`);
                          if(t==='type') document.getElementById("ti").value = "";
                      }}
                  </script>
              </body>
              </html>
              '''

          @app.route('/shot')
          def shot():
              img_path = os.path.join(os.getcwd(), 'screen.png')
              # -C åŒ…å«é¼ æ ‡æŒ‡é’ˆï¼Œ-x é™éŸ³
              subprocess.run(['screencapture', '-C', '-x', img_path])
              return send_file(img_path)

          @app.route('/ctl')
          def ctl():
              a = request.args.get('a'); w, h = get_actual_res()
              if a == 'click':
                  x, y = int(float(request.args.get('x')) * w), int(float(request.args.get('y')) * h)
                  subprocess.run(['cliclick', f'c:{x},{y}'])
              elif a == 'type':
                  v = request.args.get('v').replace('"', '\\"')
                  subprocess.run(['osascript', '-e', f'tell application "System Events" to keystroke "{v}"'])
              elif a == 'enter':
                  subprocess.run(['osascript', '-e', 'tell application "System Events" to key code 36'])
              elif a == 'space':
                  subprocess.run(['osascript', '-e', 'tell application "System Events" to key code 49'])
              elif a == 'cmd_v':
                  subprocess.run(['osascript', '-e', 'tell application "System Events" to keystroke "v" using {{command down}}'])
              return jsonify(s="ok")

          if __name__ == '__main__':
              # å¯åŠ¨æ—¶å…ˆå¼ºåˆ¶å”¤é†’çª—å£ç®¡ç†å™¨
              subprocess.run(['killall', 'SystemUIServer'], stderr=subprocess.DEVNULL)
              app.run(host='0.0.0.0', port=8080)
          EOF
          python3 remote_server.py > flask.log 2>&1 &
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          
          # ç­‰å¾…éš§é“é“¾æ¥
          timeout 30s bash -c 'until grep -o "https://.*\.trycloudflare.com" tunnel.log; do sleep 1; done' || true
          echo "========================================="
          echo "ğŸ® ç»ˆæé¥æ§é¢æ¿é“¾æ¥ï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================="
      # 3. æ‰“åŒ…ä¸å¯åŠ¨
      - name: Build and Launch
        run: |
          sed -i '' 's/chcp 65001 && //g' package.json || true
          npm install          
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          ./node_modules/.bin/electron-builder --mac --x64 --dir
          APP_PATH=$(find dist/mac -name "*.app" -maxdepth 2 | head -n 1)
          if [ -n "$APP_PATH" ]; then
            open "$APP_PATH"
          fi

      - name: Keep Alive
        run: sleep 21600
