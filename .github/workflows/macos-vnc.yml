name: Build-Full-Project

# 1. è¿™é‡Œçš„æ ¼å¼å¿…é¡»ç»å¯¹æ­£ç¡®ï¼ŒæŒ‰é’®æ‰ä¼šå‡ºç°
on:
  workflow_dispatch: # è¿™ä¸ªå°±æ˜¯å¼€å¯â€œæ‰‹åŠ¨è¿è¡ŒæŒ‰é’®â€çš„å…³é”®

jobs:
  build-and-run:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: Jiaye-apple/wftest
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Tools
        run: |
          brew install cliclick cloudflared
          python3 -m pip install flask --break-system-packages

      # 2. å¯åŠ¨å¢å¼ºå‹é¥æ§ç›‘æ§
      - name: Start Remote Monitor
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request, jsonify
          import subprocess
          import os

          app = Flask(__name__)

          def get_res():
              try:
                  cmd = "system_profiler SPDisplaysDataType | grep Resolution"
                  out = subprocess.check_output(cmd, shell=True).decode()
                  res = [int(s) for s in out.replace('x', ' ').split() if s.isdigit()]
                  return (res[0], res[1]) if len(res) >= 2 else (1280, 960)
              except: return 1280, 960

          @app.route('/')
          def index():
              return '''
              <html>
              <head><title>macOS Remote</title><style>
              body{background:#1a1a1a;color:white;text-align:center;font-family:sans-serif;}
              .screen-container{position:relative;display:inline-block;margin-top:20px;border:3px solid #444;}
              #screen{max-width:90vw;cursor:crosshair;}
              .controls{background:#222;padding:15px;position:fixed;bottom:0;width:100%;display:flex;justify-content:center;gap:10px;}
              input{padding:8px;background:#000;color:#fff;border:1px solid #444;width:200px;}
              button{padding:8px 15px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;}
              </style></head>
              <body>
              <h3>macOS è¿œç¨‹æ“æ§é¢æ¿</h3>
              <div class="screen-container"><img id="screen" src="/shot" onclick="handle(event)"></div>
              <div class="controls">
                  <input type="text" id="ti" placeholder="è¾“å…¥æ–‡å­—...">
                  <button onclick="send('type')">è¾“å…¥</button>
                  <button onclick="send('enter')" style="background:#28a745;">å›è½¦</button>
                  <button onclick="location.reload()" style="background:#555;">åˆ·æ–°</button>
              </div>
              <script>
              setInterval(()=>{document.getElementById("screen").src="/shot?t="+new Date().getTime();},1500);
              function handle(e){
                  const i=document.getElementById("screen");const r=i.getBoundingClientRect();
                  const x=(e.clientX-r.left)/r.width;const y=(e.clientY-r.top)/r.height;
                  fetch(`/ctl?a=click&x=${x}&y=${y}`);
              }
              function send(t){
                  const v=document.getElementById("ti").value;
                  if(t==='type'){fetch(`/ctl?a=type&v=${encodeURIComponent(v)}`);document.getElementById("ti").value='';}
                  else{fetch(`/ctl?a=enter`);}
              }
              </script></body></html>
              '''

          @app.route('/shot')
          def shot():
              subprocess.run(['screencapture', '-x', 'screen.png'])
              return send_file('screen.png')

          @app.route('/ctl')
          def ctl():
              a = request.args.get('a'); w, h = get_res()
              if a=='click':
                  x, y = int(float(request.args.get('x'))*w), int(float(request.args.get('y'))*h)
                  subprocess.run(['cliclick', f'c:{x},{y}'])
              elif a=='type':
                  v = request.args.get('v').replace('"', '\\"')
                  subprocess.run(['osascript', '-e', f'tell application "System Events" to keystroke "{v}"'])
              elif a=='enter':
                  subprocess.run(['osascript', '-e', 'tell application "System Events" to key code 36'])
              return jsonify(s="ok")

          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          python3 remote_server.py > flask.log 2>&1 &
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 8
          echo "========================================="
          echo "ğŸ® è¿œç¨‹é“¾æ¥ (ç‚¹å‡»ä¸‹æ–¹é“¾æ¥å³å¯æ“ä½œ):"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================="

      # 3. æ‰“åŒ…ä¸å¯åŠ¨
      - name: Build and Launch
        run: |
          sed -i '' 's/chcp 65001 && //g' package.json || true
          npm install          
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          ./node_modules/.bin/electron-builder --mac --x64 --dir
          APP_PATH=$(find dist/mac -name "*.app" -maxdepth 2 | head -n 1)
          if [ -n "$APP_PATH" ]; then
            open "$APP_PATH"
          fi

      - name: Keep Alive
        run: sleep 21600
