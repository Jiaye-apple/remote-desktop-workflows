name: RealVNC-Ngrok-Pro
on: workflow_dispatch

jobs:
  debug-job:
    # æ¨èä½¿ç”¨ macos-13ï¼Œå…¼å®¹æ€§æœ€ç¨³
    runs-on: macos-13
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1.ã€æ ¸å¿ƒã€‘æ–°å»ºä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ· (è¿™æ˜¯è§£å†³éªŒè¯å¤±è´¥çš„å”¯ä¸€åŠæ³•ï¼)
      - name: Create Admin User
        run: |
          echo "æ­£åœ¨åˆ›å»ºä¸“ç”¨ç®¡ç†å‘˜è´¦æˆ·..."
          # åˆ›å»ºç”¨æˆ· adminuserï¼Œå¯†ç  123456
          sudo sysadminctl -addUser adminuser -fullName "Admin User" -password "123456" -admin
          echo "âœ… ç”¨æˆ· adminuser åˆ›å»ºæˆåŠŸ"

      # 2. ç¦æ­¢ç¡çœ  (é˜²æ­¢è¿ä¸Šå»é»‘å±)
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime 0
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 3. å¯åŠ¨ VNC å¹¶æˆæƒç»™æ–°ç”¨æˆ·
      - name: Start VNC Server
        run: |
          echo "æ­£åœ¨å¯åŠ¨ VNC..."
          # æ¿€æ´»è¿œç¨‹ç®¡ç†æœåŠ¡
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # ã€é‡ç‚¹ã€‘æ˜ç¡®å…è®¸ adminuser è®¿é—®ï¼Œå¹¶èµ‹äºˆæ‰€æœ‰æƒé™
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -users adminuser -access -on -privs -all
          
          echo "âœ… VNC å·²å¯åŠ¨ï¼Œå…è®¸ adminuser ç™»å½•"

      # 4. å¯åŠ¨ Ngrok (ä½ å·²ç»ç»‘å¡ï¼Œè¿™æ­¥ä¼šå¾ˆé¡ºç•…)
      - name: Start Ngrok Tunnel
        env:
          # è¿™é‡Œä¼šè‡ªåŠ¨è¯»å–ä½ åœ¨ GitHub åå°è®¾ç½®çš„ Secret
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          # æ£€æŸ¥æ˜¯å¦é…ç½®äº† Token
          if [ -z "$NGROK_AUTHTOKEN" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ£€æµ‹åˆ° Tokenï¼Œè¯·æ£€æŸ¥ GitHub Secrets è®¾ç½®ï¼"
            exit 1
          fi

          brew install ngrok/ngrok/ngrok
          
          # å¯åŠ¨ TCP éš§é“æŒ‡å‘ 5900 ç«¯å£
          ngrok tcp 5900 --log=stdout > ngrok.log &
          
          echo "æ­£åœ¨è¿æ¥ Ngrok æœåŠ¡å™¨..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸš€ è¿æ¥æˆåŠŸï¼è¯·åœ¨ RealVNC Viewer è¾“å…¥ä¸‹é¢çš„åœ°å€ï¼š"
          echo "--------------------------------------------------------"
          grep -o "tcp://.*:[0-9]*" ngrok.log
          echo "--------------------------------------------------------"
          echo "ğŸ‘¤ ç”¨æˆ·å (Username): adminuser"
          echo "ğŸ”‘ å¯†  ç  (Password): 123456"
          echo "âš ï¸ å¿…è¯»ï¼šåƒä¸‡ä¸è¦ç”¨é»˜è®¤çš„ runnerï¼Œä¸€å®šè¦å¡« adminuserï¼"
          echo "========================================================"

      - name: Keep Alive
        run: sleep 21600
