name: macOS-Remote-Desktop-Screenshot-Method
on: workflow_dispatch

jobs:
  desktop:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 2. å®‰è£…ä¾èµ–
      - name: Install Dependencies
        run: |
          brew install python@3.11 pillow
          pip3 install flask pillow pyautogui
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      # 3. åˆ›å»º Web è¿œç¨‹æ¡Œé¢æœåŠ¡å™¨ï¼ˆä½¿ç”¨æˆªå±ï¼‰
      - name: Create Web Desktop Server
        run: |
          cat > desktop_server.py << 'EOF'
from flask import Flask, render_template_string, Response, request
import subprocess
import time
import base64
import io

app = Flask(__name__)

HTML = """
<!DOCTYPE html>
<html>
<head>
    <title>macOS Remote Desktop</title>
    <style>
        body { margin: 0; padding: 20px; background: #000; }
        #screen { max-width: 100%; border: 2px solid #0f0; }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
    </style>
</head>
<body>
    <h1 style="color: #0f0;">macOS Remote Desktop</h1>
    <div class="controls">
        <button onclick="refresh()">åˆ·æ–°å±å¹•</button>
        <span style="color: #fff;">è‡ªåŠ¨åˆ·æ–°: <span id="countdown">3</span>ç§’</span>
    </div>
    <img id="screen" src="/screenshot" alt="Desktop">
    
    <script>
        let countdown = 3;
        setInterval(() => {
            countdown--;
            if (countdown <= 0) {
                refresh();
                countdown = 3;
            }
            document.getElementById('countdown').textContent = countdown;
        }, 1000);
        
        function refresh() {
            document.getElementById('screen').src = '/screenshot?' + new Date().getTime();
        }
    </script>
</body>
</html>
"""

@app.route('/')
def index():
    return render_template_string(HTML)

@app.route('/screenshot')
def screenshot():
    # ä½¿ç”¨ macOS çš„ screencapture å‘½ä»¤ï¼ˆä¸éœ€è¦æƒé™ï¼‰
    subprocess.run(['screencapture', '-x', '/tmp/screen.png'], check=True)
    
    with open('/tmp/screen.png', 'rb') as f:
        img_data = f.read()
    
    return Response(img_data, mimetype='image/png')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080)
EOF
          
          echo "âœ… Web æœåŠ¡å™¨ä»£ç å·²åˆ›å»º"

      # 4. å¯åŠ¨ Web æ¡Œé¢æœåŠ¡å™¨
      - name: Start Web Desktop Server
        run: |
          echo "æ­£åœ¨å¯åŠ¨ Web æ¡Œé¢æœåŠ¡å™¨..."
          nohup python3 desktop_server.py > server.log 2>&1 &
          
          sleep 5
          
          if lsof -i :8080 > /dev/null 2>&1; then
            echo "âœ… Web æœåŠ¡å™¨å·²å¯åŠ¨åœ¨ç«¯å£ 8080"
          else
            echo "âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
            cat server.log
            exit 1
          fi

      # 5. å¯åŠ¨ Cloudflare Tunnel
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          nohup cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          
          sleep 20
          
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "âŒ è·å–éš§é“å¤±è´¥"
            cat tunnel.log
            exit 1
          fi
          
          echo "=========================================================="
          echo "ğŸŒ è¿œç¨‹æ¡Œé¢è®¿é—®åœ°å€ï¼š"
          echo "=========================================================="
          echo ""
          echo "   $TUNNEL_URL"
          echo ""
          echo "=========================================================="
          echo "ğŸ“– ä½¿ç”¨è¯´æ˜ï¼š"
          echo "   1. æ‰“å¼€ä¸Šé¢çš„é“¾æ¥"
          echo "   2. è‡ªåŠ¨æ¯3ç§’åˆ·æ–°å±å¹•"
          echo "   3. å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»'åˆ·æ–°å±å¹•'æŒ‰é’®"
          echo "=========================================================="
          
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV

      # 6. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: |
          echo "âœ… æœåŠ¡è¿è¡Œä¸­..."
          echo "ğŸ”— è®¿é—®: $TUNNEL_URL"
          
          for i in {1..360}; do
            sleep 60
            if [ $((i % 10)) -eq 0 ]; then
              echo "âœ… [$i/360] è¿è¡Œæ­£å¸¸"
            fi
          done
