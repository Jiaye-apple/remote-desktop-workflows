name: RealVNC-Software-Connect
on: workflow_dispatch

jobs:
  realvnc-job:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. å¼ºåŠ›é‡ç½®ç³»ç»Ÿå¯†ç  (é˜²æ­¢æƒé™æŠ¥é”™)
      - name: Reset System Password
        run: |
          echo "æ­£åœ¨è®¾ç½®ç³»ç»Ÿå¯†ç ..."
          # å°†ç³»ç»Ÿç”¨æˆ· runner çš„å¯†ç æ”¹ä¸º MyStrongPass123!
          sudo dscl . -passwd /Users/runner "MyStrongPass123!"
          echo "âœ… ç³»ç»Ÿå¯†ç å·²è®¾ç½®"

      # 2. å¯åŠ¨ Mac è¿œç¨‹æ¡Œé¢æœåŠ¡
      - name: Start VNC Server
        run: |
          echo "æ­£åœ¨å¯åŠ¨ VNC æœåŠ¡..."
          # æ¿€æ´»æœåŠ¡
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # è®¾ç½® VNC è¿æ¥å¯†ç  (å¿…é¡»ä¸ç³»ç»Ÿå¯†ç ä¸€è‡´ä»¥é˜²ä¸‡ä¸€)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw MyStrongPass123!
          
          echo "âœ… VNC æœåŠ¡å·²å°±ç»ª"

      # 3. å®‰è£… Ngrok å¹¶ç”Ÿæˆè½¯ä»¶è¿æ¥åœ°å€
      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          brew install ngrok/ngrok/ngrok
          
          # å¯åŠ¨è½¬å‘ï¼ŒæŒ‡å‘ Mac çš„ 5900 ç«¯å£
          ngrok tcp 5900 --log=stdout > ngrok.log &
          
          echo "æ­£åœ¨è¿æ¥å…¨çƒèŠ‚ç‚¹ï¼Œè¯·ç¨ç­‰ 10 ç§’..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸš€ è¿æ¥æˆåŠŸï¼è¯·åœ¨ RealVNC Viewer è½¯ä»¶é¡¶éƒ¨æ¡†è¾“å…¥ï¼š"
          echo "--------------------------------------------------------"
          grep -o "tcp://.*:[0-9]*" ngrok.log
          echo "--------------------------------------------------------"
          echo "ğŸ‘¤ ç”¨æˆ·å (Username): runner"
          echo "ğŸ”‘ å¯†  ç  (Password): MyStrongPass123!"
          echo "========================================================"

      - name: Keep Alive
        run: sleep 21600
