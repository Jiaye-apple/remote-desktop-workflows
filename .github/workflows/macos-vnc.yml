name: macOS-Remote-Desktop-Fixed
on: workflow_dispatch

jobs:
  desktop:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep & Screensaver
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime 0
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ å’Œå±ä¿"

      # 2. ã€æ ¸å¿ƒä¿®å¤ã€‘æŽˆäºˆå±å¹•å½•åˆ¶æƒé™
      - name: Grant Screen Recording Permission
        run: |
          echo "æ­£åœ¨å¼ºåˆ¶æŽˆäºˆå±å¹•å½•åˆ¶æƒé™..."
          
          # ç»™ ARDAgent æ·»åŠ å±å¹•å½•åˆ¶æƒé™
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "INSERT or REPLACE INTO access VALUES('kTCCServiceScreenCapture','/System/Library/CoreServices/RemoteManagement/ARDAgent.app',0,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,1687825253);" 2>/dev/null || true
          
          # ç»™ ARDAgent æ·»åŠ è¾…åŠ©åŠŸèƒ½æƒé™
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "INSERT or REPLACE INTO access VALUES('kTCCServiceAccessibility','/System/Library/CoreServices/RemoteManagement/ARDAgent.app',0,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,1687825253);" 2>/dev/null || true
          
          # ç»™ ARDAgent æ·»åŠ åŽå°äº‹ä»¶æƒé™
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "INSERT or REPLACE INTO access VALUES('kTCCServicePostEvent','/System/Library/CoreServices/RemoteManagement/ARDAgent.app',0,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,1687825253);" 2>/dev/null || true
          
          # é‡å¯æƒé™æœåŠ¡
          sudo killall -9 tccd 2>/dev/null || true
          sleep 3
          
          echo "âœ… å±å¹•å½•åˆ¶æƒé™å·²æŽˆäºˆ"

      # 3. å¯åŠ¨ VNC æœåŠ¡å™¨
      - name: Start VNC Server
        run: |
          VNC_PASSWORD="jerrylin03@"
          echo "ä½¿ç”¨å¯†ç : $VNC_PASSWORD"
          
          # å¯åŠ¨å±å¹•å…±äº«æœåŠ¡
          sudo launchctl enable system/com.apple.screensharing
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # ä½¿ç”¨ kickstart æ¿€æ´»è¿œç¨‹ç®¡ç†
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # è®¾ç½® VNC å¯†ç 
          printf "%s" "$VNC_PASSWORD" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw -
          
          # é‡å¯æœåŠ¡
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          
          echo "VNC_PASSWORD=$VNC_PASSWORD" >> $GITHUB_ENV
          echo "âœ… VNC æœåŠ¡é…ç½®å®Œæˆ"
          sleep 8

      # 4. éªŒè¯æƒé™å’ŒæœåŠ¡çŠ¶æ€
      - name: Verify Permissions and Service
        run: |
          echo "========== æ£€æŸ¥æƒé™çŠ¶æ€ =========="
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "SELECT service, client, allowed FROM access WHERE service LIKE '%Screen%' OR service LIKE '%Accessibility%';" 2>/dev/null || echo "æ— æ³•è¯»å– TCC æ•°æ®åº“"
          
          echo ""
          echo "========== æ£€æŸ¥ VNC ç«¯å£ =========="
          for i in {1..15}; do
            if sudo lsof -i :5900 | grep -q LISTEN; then
              echo "âœ… VNC æ­£åœ¨ç›‘å¬ç«¯å£ 5900"
              sudo lsof -i :5900
              break
            else
              echo "â³ ç­‰å¾… VNC å¯åŠ¨... ($i/15)"
              sleep 2
            fi
          done
          
          echo ""
          echo "========== ARDAgent è¿›ç¨‹çŠ¶æ€ =========="
          ps aux | grep ARDAgent | grep -v grep

      # 5. å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ x11vnc
      - name: Fallback - Install and Start x11vnc
        run: |
          echo "å®‰è£… x11vnc ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ..."
          brew install x11vnc
          
          # ç»™ x11vnc æ·»åŠ å±å¹•å½•åˆ¶æƒé™
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "INSERT or REPLACE INTO access VALUES('kTCCServiceScreenCapture','/opt/homebrew/bin/x11vnc',0,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,1687825253);" 2>/dev/null || true
          
          sudo killall -9 tccd 2>/dev/null || true
          sleep 2
          
          # å¯åŠ¨ x11vncï¼ˆæ— å¯†ç æ¨¡å¼ï¼‰
          nohup x11vnc -display :0 -forever -shared -nopw -xkb -repeat -capslock -norc > x11vnc.log 2>&1 &
          
          sleep 5
          
          if pgrep x11vnc > /dev/null; then
            echo "âœ… x11vnc å·²å¯åŠ¨"
            cat x11vnc.log | head -n 20
          else
            echo "âš ï¸  x11vnc å¯åŠ¨å¤±è´¥"
          fi

      # 6. å®‰è£… noVNC
      - name: Setup noVNC
        run: |
          echo "æ­£åœ¨å®‰è£… noVNC..."
          git clone --depth 1 https://github.com/novnc/noVNC.git
          git clone --depth 1 https://github.com/novnc/websockify.git noVNC/utils/websockify
          python3 -m pip install numpy --break-system-packages 2>/dev/null || pip3 install numpy
          echo "âœ… noVNC å®‰è£…å®Œæˆ"

      # 7. å¯åŠ¨ noVNC
      - name: Start noVNC
        run: |
          cd noVNC
          nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 --web . > ../novnc.log 2>&1 &
          
          sleep 5
          
          if lsof -i :6080 > /dev/null 2>&1; then
            echo "âœ… noVNC å·²å¯åŠ¨åœ¨ç«¯å£ 6080"
          else
            echo "âŒ noVNC å¯åŠ¨å¤±è´¥"
            cat ../novnc.log
            exit 1
          fi

      # 8. å¯åŠ¨ Cloudflare Tunnel
      - name: Start Cloudflare Tunnel
        run: |
          echo "æ­£åœ¨å®‰è£… cloudflared..."
          brew install cloudflared
          
          echo "æ­£åœ¨å¯åŠ¨ Cloudflare éš§é“..."
          nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "ç­‰å¾…éš§é“å»ºç«‹..."
          sleep 20
          
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "âŒ æœªèƒ½èŽ·å–éš§é“åœ°å€"
            cat tunnel.log
            exit 1
          fi
          
          echo "=========================================================="
          echo "ðŸŒ è¿œç¨‹æ¡Œé¢è®¿é—®åœ°å€ï¼š"
          echo "=========================================================="
          echo ""
          echo "   $TUNNEL_URL/vnc.html"
          echo ""
          echo "=========================================================="
          echo "ðŸ”‘ è¿žæŽ¥æ–¹å¼ï¼š"
          echo "   æ–¹æ¡ˆ1: å¯†ç  jerrylin03@"
          echo "   æ–¹æ¡ˆ2: ç›´æŽ¥ç‚¹ Connectï¼ˆæ— å¯†ç ï¼‰"
          echo "=========================================================="
          
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV

      # 9. æ˜¾ç¤ºå®Œæ•´è°ƒè¯•ä¿¡æ¯
      - name: Debug Information
        run: |
          echo ""
          echo "=========================================================="
          echo "ðŸ” å®Œæ•´è°ƒè¯•ä¿¡æ¯"
          echo "=========================================================="
          echo ""
          echo "ã€æƒé™çŠ¶æ€ã€‘"
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "SELECT * FROM access;" 2>/dev/null | grep -i "screen\|vnc\|ard" || echo "æœªæ‰¾åˆ°ç›¸å…³æƒé™"
          echo ""
          echo "ã€ç«¯å£ç›‘å¬ã€‘"
          sudo lsof -i :5900
          lsof -i :6080
          echo ""
          echo "ã€VNC è¿›ç¨‹ã€‘"
          ps aux | grep -i "ard\|vnc\|x11vnc" | grep -v grep
          echo ""
          echo "ã€x11vnc æ—¥å¿—ã€‘"
          cat x11vnc.log 2>/dev/null | tail -n 30 || echo "x11vnc æœªè¿è¡Œ"
          echo "=========================================================="

      # 10. ä¿æŒè¿è¡Œ
      - name: Keep Alive with Monitoring
        run: |
          echo "âœ… æœåŠ¡è¿è¡Œä¸­..."
          echo "ðŸ”— è®¿é—®: $TUNNEL_URL/vnc.html"
          
          for i in {1..360}; do
            sleep 60
            
            if [ $((i % 10)) -eq 0 ]; then
              echo "âœ… [$i/360] è¿è¡Œä¸­"
            fi
            
            # è‡ªåŠ¨é‡å¯æœåŠ¡
            if ! pgrep -f novnc_proxy > /dev/null; then
              cd noVNC && nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 --web . > ../novnc.log 2>&1 &
            fi
            
            if ! pgrep -f cloudflared > /dev/null; then
              nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
            fi
          done
