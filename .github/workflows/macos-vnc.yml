name: macOS-Desktop-With-GUI
on: workflow_dispatch

jobs:
  desktop:
    runs-on: macos-13  # 使用 macOS 13（更稳定）
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 核心：启动图形界面
      - name: Start GUI Session
        run: |
          echo "启动图形界面..."
          
          # 创建虚拟显示器
          sudo /usr/bin/defaults write /Library/Preferences/com.apple.loginwindow "autoLoginUser" -string "runner"
          
          # 启动桌面会话
          sudo launchctl load /System/Library/LaunchDaemons/com.apple.loginwindow.plist 2>/dev/null || true
          
          # 等待桌面启动
          sleep 10
          
          echo "✅ 图形界面已启动"

      # 禁止休眠
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          caffeinate -d &

      # 安装 VNC 服务器
      - name: Setup TightVNC Server
        run: |
          # 使用 TightVNC（第三方，权限要求更低）
          brew install --cask tigervnc-viewer || brew install tiger-vnc
          
          # 或者用 RealVNC
          curl -O https://downloads.realvnc.com/download/file/vnc.files/VNC-Server-7.12.1-MacOSX-universal.pkg
          sudo installer -pkg VNC-Server-7.12.1-MacOSX-universal.pkg -target /
          
          # 设置 VNC 密码
          mkdir -p ~/.vnc
          echo "jerrylin03@" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # 启动 VNC
          vncserver :1 -geometry 1920x1080 -depth 24 &
          
          sleep 5
          echo "✅ VNC 服务器已启动"

      # 或者：使用 Chrome Remote Desktop
      - name: Setup Chrome Remote Desktop
        run: |
          # 下载 Chrome Remote Desktop
          curl -O https://dl.google.com/chrome-remote-desktop/chromeremotedesktop.dmg
          
          # 安装
          hdiutil attach chromeremotedesktop.dmg
          sudo installer -pkg /Volumes/Chrome\ Remote\ Desktop/Chrome\ Remote\ Desktop.pkg -target /
          
          # 配置（需要你的 Chrome Remote Desktop PIN）
          echo "访问 https://remotedesktop.google.com/headless"
          echo "获取授权码并在下次运行时提供"

      # 启动 noVNC
      - name: Start noVNC
        run: |
          git clone --depth 1 https://github.com/novnc/noVNC.git
          git clone --depth 1 https://github.com/novnc/websockify.git noVNC/utils/websockify
          pip3 install numpy
          
          cd noVNC
          ./utils/novnc_proxy --vnc localhost:5901 --listen 6080 &
          
          sleep 5

      # Cloudflare Tunnel
      - name: Cloudflare Tunnel
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          sleep 20
          grep -o 'https://.*\.trycloudflare.com' tunnel.log

      - name: Keep Alive
        run: sleep 21600
