name: Build-Full-Project

on:
  workflow_dispatch: # ç¡®ä¿ GitHub é¡µé¢æ˜¾ç¤ºè“è‰²çš„ "Run workflow" æŒ‰é’®

jobs:
  build-and-run:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      # 1. ç¯å¢ƒå‡†å¤‡
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: Jiaye-apple/wftest
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Tools
        run: |
          brew install cliclick cloudflared
          python3 -m pip install flask --break-system-packages

      # 2. é˜²æ­¢é»‘å±ï¼šåˆ›å»ºè™šæ‹Ÿæ˜¾ç¤ºå™¨å¹¶ä¿æŒå”¤é†’
      - name: Setup Virtual Display
        run: |
          # å¯åŠ¨caffeinateé˜²æ­¢ç³»ç»Ÿä¼‘çœ ï¼Œ-dé˜²æ­¢æ˜¾ç¤ºå™¨ä¼‘çœ ï¼Œ-ié˜²æ­¢ç©ºé—²ä¼‘çœ 
          caffeinate -d -i -u &
          echo $! > /tmp/caffeinate.pid
          
          # ç¦ç”¨å±ä¿
          defaults write com.apple.screensaver idleTime 0
          
          # å”¤é†’æ˜¾ç¤ºç³»ç»Ÿ
          killall SystemUIServer 2>/dev/null || true
          
          # è®¾ç½®åˆ†è¾¨ç‡ï¼ˆGitHub Actions macOSä½¿ç”¨è™šæ‹Ÿæ˜¾ç¤ºå™¨ï¼Œå›ºå®š1680x1050ï¼‰
          echo "è™šæ‹Ÿæ˜¾ç¤ºå™¨è®¾ç½®å®Œæˆ"

      # 3. å¯åŠ¨å…¨åŠŸèƒ½é¥æ§å™¨ï¼ˆæ”¯æŒé”®ç›˜ã€é¼ æ ‡ã€å¿«æ·é”®ç­‰ï¼‰
      - name: Start Remote Monitor
        run: |
          cat << 'SERVEREOF' > remote_server.py
          # -*- coding: utf-8 -*-
          """
          macOS è¿œç¨‹é¥æ§å™¨ - å…¨åŠŸèƒ½ç‰ˆ
          æ”¯æŒ: æˆªå±/é”®ç›˜è¾“å…¥/é¼ æ ‡æ“ä½œ/ç‰¹æ®ŠæŒ‰é”®/å¿«æ·é”®ç»„åˆ
          """
          from flask import Flask, send_file, request, jsonify, Response
          import subprocess, os, re, time, json

          app = Flask(__name__)

          # å›ºå®šåˆ†è¾¨ç‡ - GitHub Actions macOSè™šæ‹Ÿæ˜¾ç¤ºå™¨
          SCREEN_W, SCREEN_H = 1680, 1050

          def get_actual_res():
              """è·å–å®é™…åˆ†è¾¨ç‡ï¼Œå¸¦ç¼“å­˜"""
              global SCREEN_W, SCREEN_H
              try:
                  out = subprocess.check_output(
                      "system_profiler SPDisplaysDataType 2>/dev/null | grep -i resolution",
                      shell=True, timeout=5
                  ).decode()
                  match = re.search(r'(\d+)\s*x\s*(\d+)', out)
                  if match:
                      SCREEN_W = int(match.group(1))
                      SCREEN_H = int(match.group(2))
              except: pass
              return SCREEN_W, SCREEN_H

          # ç‰¹æ®ŠæŒ‰é”®æ˜ å°„è¡¨ (macOS key codes)
          KEY_CODES = {
              'enter': 36, 'return': 36, 'tab': 48, 'space': 49,
              'delete': 51, 'backspace': 51, 'escape': 53, 'esc': 53,
              'up': 126, 'down': 125, 'left': 123, 'right': 124,
              'home': 115, 'end': 119, 'pageup': 116, 'pagedown': 121,
              'f1': 122, 'f2': 120, 'f3': 99, 'f4': 118, 'f5': 96,
              'f6': 97, 'f7': 98, 'f8': 100, 'f9': 101, 'f10': 109,
              'f11': 103, 'f12': 111
          }

          @app.route('/')
          def index():
              w, h = get_actual_res()
              return f'''<!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>macOS è¿œç¨‹æ§åˆ¶ä¸­å¿ƒ</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ 
                      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                      color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                      min-height: 100vh; overflow-x: hidden;
                  }}
                  
                  /* é¡¶éƒ¨æ§åˆ¶æ  */
                  .control-bar {{
                      background: rgba(30, 30, 50, 0.95);
                      backdrop-filter: blur(10px);
                      padding: 12px 20px;
                      position: fixed; top: 0; left: 0; right: 0;
                      z-index: 1000;
                      border-bottom: 1px solid rgba(100, 100, 255, 0.3);
                      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
                  }}
                  
                  .control-group {{
                      display: flex; gap: 6px; align-items: center;
                      padding: 4px 10px;
                      background: rgba(255,255,255,0.05);
                      border-radius: 8px;
                  }}
                  .control-group label {{
                      font-size: 11px; color: #888; margin-right: 4px;
                  }}
                  
                  .btn {{
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white; border: none; padding: 8px 14px;
                      cursor: pointer; border-radius: 6px; font-size: 13px;
                      transition: all 0.2s; font-weight: 500;
                  }}
                  .btn:hover {{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }}
                  .btn:active {{ transform: translateY(0); }}
                  .btn-success {{ background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }}
                  .btn-danger {{ background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); }}
                  .btn-warning {{ background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }}
                  .btn-secondary {{ background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%); }}
                  .btn-small {{ padding: 5px 10px; font-size: 11px; }}
                  
                  input[type="text"] {{
                      background: rgba(0,0,0,0.4); color: #fff;
                      border: 1px solid rgba(255,255,255,0.2);
                      padding: 8px 12px; border-radius: 6px; width: 180px;
                      font-size: 13px;
                  }}
                  input[type="text"]:focus {{
                      outline: none; border-color: #667eea;
                      box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
                  }}
                  
                  /* å±å¹•æ˜¾ç¤ºåŒºåŸŸ */
                  .screen-wrapper {{
                      margin-top: 130px; /* ç»™æ§åˆ¶æ ç•™ç©ºé—´ */
                      padding: 15px;
                      display: flex; justify-content: center;
                  }}
                  
                  .screen-container {{
                      position: relative;
                      border: 2px solid rgba(100, 100, 255, 0.4);
                      border-radius: 12px;
                      overflow: hidden;
                      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                      background: #000;
                  }}
                  
                  #screen {{
                      display: block;
                      max-width: 100%;
                      max-height: calc(100vh - 180px);
                      cursor: crosshair;
                  }}
                  
                  /* çŠ¶æ€æ  */
                  .status-bar {{
                      position: fixed; bottom: 0; left: 0; right: 0;
                      background: rgba(20, 20, 40, 0.95);
                      padding: 8px 20px;
                      display: flex; justify-content: space-between; align-items: center;
                      font-size: 12px; color: #888;
                      border-top: 1px solid rgba(100, 100, 255, 0.2);
                  }}
                  .status-item {{ display: flex; align-items: center; gap: 8px; }}
                  .status-dot {{ width: 8px; height: 8px; border-radius: 50%; background: #38ef7d; }}
                  
                  /* é”®ç›˜é¢æ¿ */
                  .keyboard-panel {{
                      display: none; position: fixed;
                      top: 50%; left: 50%; transform: translate(-50%, -50%);
                      background: rgba(30, 30, 50, 0.98);
                      padding: 20px; border-radius: 12px;
                      z-index: 2000;
                      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
                      border: 1px solid rgba(100, 100, 255, 0.3);
                  }}
                  .keyboard-panel.show {{ display: block; }}
                  .keyboard-row {{ display: flex; gap: 6px; margin-bottom: 6px; justify-content: center; }}
                  .key-btn {{
                      min-width: 40px; height: 40px;
                      background: rgba(60, 60, 80, 0.9);
                      border: 1px solid rgba(100, 100, 255, 0.3);
                      color: #fff; border-radius: 6px; cursor: pointer;
                      font-size: 12px; transition: all 0.15s;
                  }}
                  .key-btn:hover {{ background: rgba(102, 126, 234, 0.6); }}
                  .key-btn:active {{ transform: scale(0.95); }}
                  .key-wide {{ min-width: 80px; }}
                  .key-space {{ min-width: 200px; }}
                  
                  /* æç¤ºä¿¡æ¯ */
                  .toast {{
                      position: fixed; bottom: 60px; left: 50%;
                      transform: translateX(-50%);
                      background: rgba(102, 126, 234, 0.9);
                      padding: 10px 20px; border-radius: 20px;
                      font-size: 13px; z-index: 3000;
                      opacity: 0; transition: opacity 0.3s;
                  }}
                  .toast.show {{ opacity: 1; }}
              </style>
          </head>
          <body>
              <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
              <div class="control-bar">
                  <!-- æ–‡å­—è¾“å…¥ -->
                  <div class="control-group">
                      <label>ğŸ“ æ–‡å­—</label>
                      <input type="text" id="textInput" placeholder="è¾“å…¥æ–‡å­—..." onkeydown="if(event.key==='Enter')sendText()">
                      <button class="btn btn-small" onclick="sendText()">å‘é€</button>
                  </div>
                  
                  <!-- å¸¸ç”¨æŒ‰é”® -->
                  <div class="control-group">
                      <label>âŒ¨ï¸ æŒ‰é”®</label>
                      <button class="btn btn-success btn-small" onclick="sendKey('enter')">Enter</button>
                      <button class="btn btn-secondary btn-small" onclick="sendKey('tab')">Tab</button>
                      <button class="btn btn-secondary btn-small" onclick="sendKey('escape')">Esc</button>
                      <button class="btn btn-danger btn-small" onclick="sendKey('backspace')">âŒ«</button>
                      <button class="btn btn-secondary btn-small" onclick="sendKey('space')">Space</button>
                  </div>
                  
                  <!-- æ–¹å‘é”® -->
                  <div class="control-group">
                      <label>ğŸ® æ–¹å‘</label>
                      <button class="btn btn-secondary btn-small" onclick="sendKey('up')">â†‘</button>
                      <button class="btn btn-secondary btn-small" onclick="sendKey('down')">â†“</button>
                      <button class="btn btn-secondary btn-small" onclick="sendKey('left')">â†</button>
                      <button class="btn btn-secondary btn-small" onclick="sendKey('right')">â†’</button>
                  </div>
                  
                  <!-- å¿«æ·é”® -->
                  <div class="control-group">
                      <label>âš¡ å¿«æ·é”®</label>
                      <button class="btn btn-warning btn-small" onclick="sendShortcut('cmd', 'c')">âŒ˜C</button>
                      <button class="btn btn-warning btn-small" onclick="sendShortcut('cmd', 'v')">âŒ˜V</button>
                      <button class="btn btn-warning btn-small" onclick="sendShortcut('cmd', 'a')">âŒ˜A</button>
                      <button class="btn btn-warning btn-small" onclick="sendShortcut('cmd', 'z')">âŒ˜Z</button>
                      <button class="btn btn-warning btn-small" onclick="sendShortcut('cmd', 's')">âŒ˜S</button>
                      <button class="btn btn-warning btn-small" onclick="sendShortcut('cmd', 'w')">âŒ˜W</button>
                  </div>
                  
                  <!-- é¼ æ ‡æ“ä½œ -->
                  <div class="control-group">
                      <label>ğŸ–±ï¸ é¼ æ ‡</label>
                      <select id="mouseMode" style="background:#333;color:#fff;border:1px solid #555;padding:5px;border-radius:4px;">
                          <option value="click">å·¦é”®å•å‡»</option>
                          <option value="dclick">å·¦é”®åŒå‡»</option>
                          <option value="rclick">å³é”®å•å‡»</option>
                          <option value="mclick">ä¸­é”®å•å‡»</option>
                          <option value="drag">æ‹–æ‹½æ¨¡å¼</option>
                      </select>
                  </div>
                  
                  <!-- åˆ·æ–°é¢‘ç‡ -->
                  <div class="control-group">
                      <label>â±ï¸ åˆ·æ–°</label>
                      <select id="refreshRate" onchange="setRefreshRate(parseInt(this.value))" style="background:#333;color:#fff;border:1px solid #555;padding:5px;border-radius:4px;">
                          <option value="500">500ms</option>
                          <option value="1000" selected>1ç§’</option>
                          <option value="2000">2ç§’</option>
                          <option value="3000">3ç§’</option>
                      </select>
                  </div>
                  
                  <!-- å·¥å…· -->
                  <div class="control-group">
                      <label>ğŸ”§</label>
                      <button class="btn btn-secondary btn-small" id="keyboardModeBtn" onclick="toggleKeyboardMode()">é”®ç›˜ç›´é€š: å…³</button>
                      <button class="btn btn-secondary btn-small" onclick="toggleKeyboard()">è™šæ‹Ÿé”®ç›˜</button>
                      <button class="btn btn-secondary btn-small" onclick="refreshScreen()">åˆ·æ–°</button>
                  </div>
              </div>
              
              <!-- å±å¹•æ˜¾ç¤º -->
              <div class="screen-wrapper">
                  <div class="screen-container">
                      <img id="screen" src="/shot" onclick="handleClick(event)" oncontextmenu="handleRightClick(event); return false;">
                  </div>
              </div>
              
              <!-- çŠ¶æ€æ  -->
              <div class="status-bar">
                  <div class="status-item">
                      <span class="status-dot"></span>
                      <span>å·²è¿æ¥</span>
                  </div>
                  <div class="status-item">
                      <span>åˆ†è¾¨ç‡: {w} x {h}</span>
                      <span>|</span>
                      <span>åˆ·æ–°é—´éš”: <span id="refreshMs">1000</span>ms</span>
                      <span>|</span>
                      <span id="lastUpdate">ç­‰å¾…æ›´æ–°...</span>
                  </div>
                  <div class="status-item">
                      <span>ç‚¹å‡»åæ ‡: <span id="clickPos">-</span></span>
                  </div>
              </div>
              
              <!-- è™šæ‹Ÿé”®ç›˜é¢æ¿ -->
              <div class="keyboard-panel" id="keyboardPanel">
                  <div class="keyboard-row">
                      <button class="key-btn" onclick="sendKey('escape')">Esc</button>
                      <button class="key-btn" onclick="sendKey('f1')">F1</button>
                      <button class="key-btn" onclick="sendKey('f2')">F2</button>
                      <button class="key-btn" onclick="sendKey('f3')">F3</button>
                      <button class="key-btn" onclick="sendKey('f4')">F4</button>
                      <button class="key-btn" onclick="sendKey('f5')">F5</button>
                      <button class="key-btn" onclick="sendKey('f6')">F6</button>
                      <button class="key-btn" onclick="sendKey('f7')">F7</button>
                      <button class="key-btn" onclick="sendKey('f8')">F8</button>
                      <button class="key-btn" onclick="sendKey('f9')">F9</button>
                      <button class="key-btn" onclick="sendKey('f10')">F10</button>
                      <button class="key-btn" onclick="sendKey('f11')">F11</button>
                      <button class="key-btn" onclick="sendKey('f12')">F12</button>
                  </div>
                  <div class="keyboard-row">
                      <button class="key-btn" onclick="sendChar('1')">1</button>
                      <button class="key-btn" onclick="sendChar('2')">2</button>
                      <button class="key-btn" onclick="sendChar('3')">3</button>
                      <button class="key-btn" onclick="sendChar('4')">4</button>
                      <button class="key-btn" onclick="sendChar('5')">5</button>
                      <button class="key-btn" onclick="sendChar('6')">6</button>
                      <button class="key-btn" onclick="sendChar('7')">7</button>
                      <button class="key-btn" onclick="sendChar('8')">8</button>
                      <button class="key-btn" onclick="sendChar('9')">9</button>
                      <button class="key-btn" onclick="sendChar('0')">0</button>
                      <button class="key-btn key-wide" onclick="sendKey('backspace')">âŒ« Delete</button>
                  </div>
                  <div class="keyboard-row">
                      <button class="key-btn key-wide" onclick="sendKey('tab')">Tab</button>
                      <button class="key-btn" onclick="sendChar('q')">Q</button>
                      <button class="key-btn" onclick="sendChar('w')">W</button>
                      <button class="key-btn" onclick="sendChar('e')">E</button>
                      <button class="key-btn" onclick="sendChar('r')">R</button>
                      <button class="key-btn" onclick="sendChar('t')">T</button>
                      <button class="key-btn" onclick="sendChar('y')">Y</button>
                      <button class="key-btn" onclick="sendChar('u')">U</button>
                      <button class="key-btn" onclick="sendChar('i')">I</button>
                      <button class="key-btn" onclick="sendChar('o')">O</button>
                      <button class="key-btn" onclick="sendChar('p')">P</button>
                  </div>
                  <div class="keyboard-row">
                      <button class="key-btn" onclick="sendChar('a')">A</button>
                      <button class="key-btn" onclick="sendChar('s')">S</button>
                      <button class="key-btn" onclick="sendChar('d')">D</button>
                      <button class="key-btn" onclick="sendChar('f')">F</button>
                      <button class="key-btn" onclick="sendChar('g')">G</button>
                      <button class="key-btn" onclick="sendChar('h')">H</button>
                      <button class="key-btn" onclick="sendChar('j')">J</button>
                      <button class="key-btn" onclick="sendChar('k')">K</button>
                      <button class="key-btn" onclick="sendChar('l')">L</button>
                      <button class="key-btn key-wide" onclick="sendKey('enter')">Enter â†µ</button>
                  </div>
                  <div class="keyboard-row">
                      <button class="key-btn" onclick="sendChar('z')">Z</button>
                      <button class="key-btn" onclick="sendChar('x')">X</button>
                      <button class="key-btn" onclick="sendChar('c')">C</button>
                      <button class="key-btn" onclick="sendChar('v')">V</button>
                      <button class="key-btn" onclick="sendChar('b')">B</button>
                      <button class="key-btn" onclick="sendChar('n')">N</button>
                      <button class="key-btn" onclick="sendChar('m')">M</button>
                      <button class="key-btn" onclick="sendChar(',')">ï¼Œ</button>
                      <button class="key-btn" onclick="sendChar('.')">ã€‚</button>
                  </div>
                  <div class="keyboard-row">
                      <button class="key-btn key-wide" onclick="sendShortcut('cmd','')">âŒ˜ Cmd</button>
                      <button class="key-btn key-space" onclick="sendKey('space')">Space</button>
                      <button class="key-btn" onclick="sendKey('up')">â†‘</button>
                      <button class="key-btn" onclick="sendKey('left')">â†</button>
                      <button class="key-btn" onclick="sendKey('down')">â†“</button>
                      <button class="key-btn" onclick="sendKey('right')">â†’</button>
                  </div>
                  <div style="text-align:center;margin-top:15px;">
                      <button class="btn btn-danger" onclick="toggleKeyboard()">å…³é—­é”®ç›˜</button>
                  </div>
              </div>
              
              <!-- æç¤ºæ¶ˆæ¯ -->
              <div class="toast" id="toast"></div>
              
              <script>
                  /* ========================================
                   * macOS è¿œç¨‹æ§åˆ¶ - Windowsæµè§ˆå™¨å…¼å®¹ç‰ˆ
                   * æ”¯æŒ: Chrome/Edge/Firefox on Windows
                   * ======================================== */
                  
                  const W = {w}, H = {h};
                  let refreshInterval = null;
                  let refreshMs = 1000;
                  let keyboardMode = false;  // é”®ç›˜ç›´é€šæ¨¡å¼
                  let isDragging = false;    // æ‹–æ‹½çŠ¶æ€
                  let dragStartPos = null;   // æ‹–æ‹½èµ·å§‹ä½ç½®
                  
                  // ========== å±å¹•åˆ·æ–° ==========
                  function startRefresh() {{
                      if (refreshInterval) clearInterval(refreshInterval);
                      refreshInterval = setInterval(function() {{
                          var img = document.getElementById("screen");
                          img.src = "/shot?t=" + Date.now();
                          document.getElementById("lastUpdate").textContent = new Date().toLocaleTimeString();
                      }}, refreshMs);
                  }}
                  startRefresh();
                  
                  function refreshScreen() {{
                      document.getElementById("screen").src = "/shot?t=" + Date.now();
                      showToast("å±å¹•å·²åˆ·æ–°");
                  }}
                  
                  // è°ƒæ•´åˆ·æ–°é¢‘ç‡
                  function setRefreshRate(ms) {{
                      refreshMs = ms;
                      document.getElementById("refreshMs").textContent = ms;
                      startRefresh();
                      showToast("åˆ·æ–°é—´éš”: " + ms + "ms");
                  }}
                  
                  // ========== é¼ æ ‡æ“ä½œ ==========
                  function getMousePos(e) {{
                      var rect = e.target.getBoundingClientRect();
                      var xr = (e.clientX - rect.left) / rect.width;
                      var yr = (e.clientY - rect.top) / rect.height;
                      // è¾¹ç•Œæ£€æŸ¥
                      xr = Math.max(0, Math.min(1, xr));
                      yr = Math.max(0, Math.min(1, yr));
                      return {{ xr: xr, yr: yr, x: Math.round(xr * W), y: Math.round(yr * H) }};
                  }}
                  
                  function handleClick(e) {{
                      var pos = getMousePos(e);
                      var mode = document.getElementById("mouseMode").value;
                      document.getElementById("clickPos").textContent = pos.x + ", " + pos.y;
                      
                      fetch("/ctl?a=" + mode + "&x=" + pos.xr + "&y=" + pos.yr)
                          .then(function() {{ showToast(mode + " @ (" + pos.x + ", " + pos.y + ")"); }});
                  }}
                  
                  // å³é”®ç‚¹å‡» (Windowsæµè§ˆå™¨å…¼å®¹)
                  function handleRightClick(e) {{
                      e.preventDefault();
                      e.stopPropagation();
                      var pos = getMousePos(e);
                      
                      fetch("/ctl?a=rclick&x=" + pos.xr + "&y=" + pos.yr)
                          .then(function() {{ showToast("å³é”® @ (" + pos.x + ", " + pos.y + ")"); }});
                      return false;
                  }}
                  
                  // é¼ æ ‡æ»šè½® (Windowsæµè§ˆå™¨å…¼å®¹)
                  function handleWheel(e) {{
                      e.preventDefault();
                      var pos = getMousePos(e);
                      // Windowså’ŒMacæ»šè½®æ–¹å‘å¯èƒ½ç›¸åï¼Œè¿™é‡Œç»Ÿä¸€å¤„ç†
                      var delta = e.deltaY || e.wheelDelta || -e.detail;
                      var direction = delta > 0 ? "down" : "up";
                      var amount = Math.min(Math.abs(delta), 100);
                      
                      fetch("/ctl?a=scroll&x=" + pos.xr + "&y=" + pos.yr + "&d=" + direction + "&n=" + amount)
                          .then(function() {{ showToast("æ»šåŠ¨ " + direction); }});
                  }}
                  
                  // æ‹–æ‹½æ“ä½œ
                  function handleMouseDown(e) {{
                      if (e.button === 0 && document.getElementById("mouseMode").value === "drag") {{
                          isDragging = true;
                          dragStartPos = getMousePos(e);
                          e.preventDefault();
                      }}
                  }}
                  
                  function handleMouseUp(e) {{
                      if (isDragging && dragStartPos) {{
                          var endPos = getMousePos(e);
                          fetch("/ctl?a=drag&x1=" + dragStartPos.xr + "&y1=" + dragStartPos.yr + 
                                "&x2=" + endPos.xr + "&y2=" + endPos.yr)
                              .then(function() {{ 
                                  showToast("æ‹–æ‹½: (" + dragStartPos.x + "," + dragStartPos.y + ") â†’ (" + endPos.x + "," + endPos.y + ")"); 
                              }});
                          isDragging = false;
                          dragStartPos = null;
                      }}
                  }}
                  
                  // ========== é”®ç›˜è¾“å…¥ ==========
                  function sendText() {{
                      var input = document.getElementById("textInput");
                      var v = input.value;
                      if (!v) return;
                      fetch("/ctl?a=type&v=" + encodeURIComponent(v))
                          .then(function() {{
                              showToast("å·²è¾“å…¥: " + v);
                              input.value = "";
                          }});
                  }}
                  
                  function sendChar(c) {{
                      fetch("/ctl?a=type&v=" + encodeURIComponent(c))
                          .then(function() {{ showToast("æŒ‰é”®: " + c); }});
                  }}
                  
                  function sendKey(key) {{
                      fetch("/ctl?a=key&k=" + key)
                          .then(function() {{ showToast("æŒ‰é”®: " + key.toUpperCase()); }});
                  }}
                  
                  // å‘é€å¿«æ·é”® (Windows Ctrl è‡ªåŠ¨æ˜ å°„ä¸º macOS Cmd)
                  function sendShortcut(mod, key) {{
                      fetch("/ctl?a=shortcut&mod=" + mod + "&k=" + key)
                          .then(function() {{ 
                              var modSymbol = mod === 'cmd' ? 'âŒ˜' : (mod === 'ctrl' ? 'Ctrl+' : (mod === 'alt' ? 'âŒ¥' : 'â‡§'));
                              showToast("å¿«æ·é”®: " + modSymbol + key.toUpperCase()); 
                          }});
                  }}
                  
                  // ========== UIæ§åˆ¶ ==========
                  function toggleKeyboard() {{
                      document.getElementById("keyboardPanel").classList.toggle("show");
                  }}
                  
                  function toggleKeyboardMode() {{
                      keyboardMode = !keyboardMode;
                      var btn = document.getElementById("keyboardModeBtn");
                      if (keyboardMode) {{
                          btn.style.background = "linear-gradient(135deg, #11998e 0%, #38ef7d 100%)";
                          btn.textContent = "é”®ç›˜ç›´é€š: å¼€";
                          showToast("é”®ç›˜ç›´é€šå·²å¼€å¯ - åœ¨ç½‘é¡µä¸ŠæŒ‰é”®ä¼šå‘é€åˆ°Mac");
                      }} else {{
                          btn.style.background = "";
                          btn.textContent = "é”®ç›˜ç›´é€š: å…³";
                          showToast("é”®ç›˜ç›´é€šå·²å…³é—­");
                      }}
                  }}
                  
                  function showToast(msg) {{
                      var toast = document.getElementById("toast");
                      toast.textContent = msg;
                      toast.classList.add("show");
                      setTimeout(function() {{ toast.classList.remove("show"); }}, 1500);
                  }}
                  
                  // ========== é”®ç›˜äº‹ä»¶ç›‘å¬ (Windowså…¼å®¹) ==========
                  document.addEventListener('keydown', function(e) {{
                      // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†æˆ–selectï¼Œä¸æ‹¦æˆª
                      var tag = document.activeElement.tagName;
                      if (tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') return;
                      
                      // Windows Ctrl+Key è‡ªåŠ¨æ˜ å°„ä¸º macOS Cmd+Key
                      if (e.ctrlKey && !e.altKey && !e.shiftKey) {{
                          var key = e.key.toLowerCase();
                          if (['c', 'v', 'x', 'a', 'z', 's', 'w', 'q', 'f', 'n', 'o', 'p'].indexOf(key) >= 0) {{
                              e.preventDefault();
                              sendShortcut('cmd', key);
                              return;
                          }}
                      }}
                      
                      // é”®ç›˜ç›´é€šæ¨¡å¼ï¼šå°†æ‰€æœ‰æŒ‰é”®å‘é€åˆ°è¿œç¨‹Mac
                      if (keyboardMode) {{
                          e.preventDefault();
                          
                          // ç‰¹æ®ŠæŒ‰é”®æ˜ å°„
                          var keyMap = {{
                              'ArrowUp': 'up', 'ArrowDown': 'down', 'ArrowLeft': 'left', 'ArrowRight': 'right',
                              'Enter': 'enter', 'Escape': 'escape', 'Backspace': 'backspace', 'Tab': 'tab',
                              'Delete': 'delete', ' ': 'space', 'Home': 'home', 'End': 'end',
                              'PageUp': 'pageup', 'PageDown': 'pagedown',
                              'F1': 'f1', 'F2': 'f2', 'F3': 'f3', 'F4': 'f4', 'F5': 'f5', 'F6': 'f6',
                              'F7': 'f7', 'F8': 'f8', 'F9': 'f9', 'F10': 'f10', 'F11': 'f11', 'F12': 'f12'
                          }};
                          
                          if (keyMap[e.key]) {{
                              sendKey(keyMap[e.key]);
                          }} else if (e.key.length === 1) {{
                              // æ™®é€šå­—ç¬¦
                              sendChar(e.key);
                          }}
                          return;
                      }}
                      
                      // éç›´é€šæ¨¡å¼ï¼šåªå¤„ç†åŠŸèƒ½é”®
                      var funcKeyMap = {{
                          'ArrowUp': 'up', 'ArrowDown': 'down', 'ArrowLeft': 'left', 'ArrowRight': 'right',
                          'Escape': 'escape'
                      }};
                      if (funcKeyMap[e.key]) {{
                          e.preventDefault();
                          sendKey(funcKeyMap[e.key]);
                      }}
                  }});
                  
                  // é˜»æ­¢æµè§ˆå™¨é»˜è®¤å³é”®èœå•
                  document.getElementById("screen").addEventListener('contextmenu', function(e) {{
                      e.preventDefault();
                      return false;
                  }});
                  
                  // ç»‘å®šæ»šè½®äº‹ä»¶ (å…¼å®¹ä¸åŒæµè§ˆå™¨)
                  var screenEl = document.getElementById("screen");
                  if (screenEl.addEventListener) {{
                      screenEl.addEventListener('wheel', handleWheel, {{ passive: false }});
                      screenEl.addEventListener('mousedown', handleMouseDown);
                      screenEl.addEventListener('mouseup', handleMouseUp);
                  }}
                  
                  // é¡µé¢åŠ è½½å®Œæˆæç¤º
                  showToast("ğŸ® è¿œç¨‹æ§åˆ¶å·²å°±ç»ª - Windowså…¼å®¹æ¨¡å¼");
              </script>
          </body>
          </html>'''

          @app.route('/shot')
          def shot():
              """æˆªå±å¹¶è¿”å›å›¾ç‰‡"""
              img_path = os.path.join(os.getcwd(), 'screen.png')
              try:
                  # -C æ˜¾ç¤ºé¼ æ ‡æŒ‡é’ˆ, -x é™éŸ³, æ•è·æ•´ä¸ªå±å¹•
                  result = subprocess.run(
                      ['screencapture', '-C', '-x', img_path],
                      timeout=10, capture_output=True
                  )
                  if os.path.exists(img_path):
                      return send_file(img_path, mimetype='image/png')
              except Exception as e:
                  print(f"æˆªå±é”™è¯¯: {e}")
              
              # å¦‚æœæˆªå±å¤±è´¥ï¼Œè¿”å›ä¸€ä¸ªæç¤ºå›¾ç‰‡
              return Response("æˆªå±å¤±è´¥", status=500)

          @app.route('/ctl')
          def ctl():
              """å¤„ç†æ§åˆ¶å‘½ä»¤"""
              a = request.args.get('a', '')
              w, h = get_actual_res()
              
              try:
                  # é¼ æ ‡ç‚¹å‡»æ“ä½œ
                  if a in ['click', 'dclick', 'rclick', 'mclick']:
                      xr = float(request.args.get('x', 0))
                      yr = float(request.args.get('y', 0))
                      x, y = int(xr * w), int(yr * h)
                      
                      if a == 'click':
                          subprocess.run(['cliclick', f'c:{x},{y}'], timeout=5)
                      elif a == 'dclick':
                          subprocess.run(['cliclick', f'dc:{x},{y}'], timeout=5)
                      elif a == 'rclick':
                          subprocess.run(['cliclick', f'rc:{x},{y}'], timeout=5)
                      elif a == 'mclick':
                          subprocess.run(['cliclick', f'tc:{x},{y}'], timeout=5)
                  
                  # æ–‡å­—è¾“å…¥
                  elif a == 'type':
                      v = request.args.get('v', '')
                      if v:
                          # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
                          v = v.replace('\\', '\\\\').replace('"', '\\"')
                          subprocess.run([
                              'osascript', '-e', 
                              f'tell application "System Events" to keystroke "{v}"'
                          ], timeout=10)
                  
                  # ç‰¹æ®ŠæŒ‰é”®
                  elif a == 'key':
                      k = request.args.get('k', '').lower()
                      if k in KEY_CODES:
                          code = KEY_CODES[k]
                          subprocess.run([
                              'osascript', '-e', 
                              f'tell application "System Events" to key code {code}'
                          ], timeout=5)
                  
                  # å¿«æ·é”®ç»„åˆ
                  elif a == 'shortcut':
                      mod = request.args.get('mod', 'cmd')
                      k = request.args.get('k', '')
                      if k:
                          mod_map = {{'cmd': 'command down', 'ctrl': 'control down', 'alt': 'option down', 'shift': 'shift down'}}
                          modifier = mod_map.get(mod, 'command down')
                          subprocess.run([
                              'osascript', '-e', 
                              f'tell application "System Events" to keystroke "{k}" using {{{modifier}}}'
                          ], timeout=5)
                  
                  # æ»šè½®æ»šåŠ¨ (ä½¿ç”¨cliclickæˆ–AppleScript)
                  elif a == 'scroll':
                      xr = float(request.args.get('x', 0.5))
                      yr = float(request.args.get('y', 0.5))
                      direction = request.args.get('d', 'down')
                      amount = int(request.args.get('n', 3))
                      x, y = int(xr * w), int(yr * h)
                      
                      # å…ˆç§»åŠ¨é¼ æ ‡åˆ°ä½ç½®
                      subprocess.run(['cliclick', f'm:{x},{y}'], timeout=5)
                      # ä½¿ç”¨AppleScriptæ¨¡æ‹Ÿæ»šè½®
                      scroll_amount = amount if direction == 'down' else -amount
                      subprocess.run([
                          'osascript', '-e',
                          f'tell application "System Events" to scroll area 1 by {{{scroll_amount}, 0}}'
                      ], timeout=5, stderr=subprocess.DEVNULL)
                  
                  # æ‹–æ‹½æ“ä½œ
                  elif a == 'drag':
                      x1r = float(request.args.get('x1', 0))
                      y1r = float(request.args.get('y1', 0))
                      x2r = float(request.args.get('x2', 0))
                      y2r = float(request.args.get('y2', 0))
                      x1, y1 = int(x1r * w), int(y1r * h)
                      x2, y2 = int(x2r * w), int(y2r * h)
                      
                      # cliclickæ”¯æŒæ‹–æ‹½: dd=drag down, du=drag up
                      subprocess.run(['cliclick', f'dd:{x1},{y1}', f'du:{x2},{y2}'], timeout=5)
                  
                  return jsonify(status="ok", action=a)
              
              except subprocess.TimeoutExpired:
                  return jsonify(status="timeout", action=a), 500
              except Exception as e:
                  return jsonify(status="error", message=str(e)), 500

          @app.route('/health')
          def health():
              """å¥åº·æ£€æŸ¥"""
              w, h = get_actual_res()
              return jsonify(status="ok", resolution=f"{w}x{h}")

          if __name__ == '__main__':
              print("=" * 50)
              print("ğŸ® macOS è¿œç¨‹æ§åˆ¶æœåŠ¡å™¨å¯åŠ¨ä¸­...")
              print(f"ğŸ“º åˆ†è¾¨ç‡: {SCREEN_W} x {SCREEN_H}")
              print("=" * 50)
              
              # å”¤é†’UIç³»ç»Ÿï¼Œé˜²æ­¢é»‘å±
              subprocess.run(['killall', 'SystemUIServer'], stderr=subprocess.DEVNULL)
              
              # è¿è¡ŒæœåŠ¡å™¨
              app.run(host='0.0.0.0', port=8080, threaded=True)
          SERVEREOF
          
          # å¯åŠ¨æœåŠ¡å™¨
          python3 remote_server.py > flask.log 2>&1 &
          sleep 3
          
          # å¯åŠ¨Cloudflareéš§é“
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 12
          
          echo ""
          echo "========================================="
          echo "ğŸ® macOS è¿œç¨‹æ§åˆ¶ä¸­å¿ƒå·²å¯åŠ¨"
          echo "========================================="
          echo ""
          echo "ğŸŒ è¿œç¨‹è®¿é—®åœ°å€:"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo ""
          echo "ğŸ“‹ æ”¯æŒçš„åŠŸèƒ½:"
          echo "   âœ… å®æ—¶å±å¹•æ˜¾ç¤º (1ç§’è‡ªåŠ¨åˆ·æ–°)"
          echo "   âœ… é¼ æ ‡æ“ä½œ: å·¦é”®/å³é”®/åŒå‡»/ä¸­é”®"
          echo "   âœ… æ–‡å­—è¾“å…¥"
          echo "   âœ… ç‰¹æ®ŠæŒ‰é”®: Enter, Tab, Esc, Backspace, Space"
          echo "   âœ… æ–¹å‘é”®: â†‘â†“â†â†’"
          echo "   âœ… å¿«æ·é”®ç»„åˆ: âŒ˜C, âŒ˜V, âŒ˜A, âŒ˜Z, âŒ˜S, âŒ˜W"
          echo "   âœ… è™šæ‹Ÿé”®ç›˜ (åŠŸèƒ½é”®F1-F12)"
          echo "   âœ… æœ¬åœ°é”®ç›˜å¿«æ·é”®æ”¯æŒ"
          echo ""
          echo "ğŸ”§ æ—¥å¿—æ–‡ä»¶:"
          echo "   - flask.log  (æœåŠ¡å™¨æ—¥å¿—)"
          echo "   - tunnel.log (éš§é“æ—¥å¿—)"
          echo "========================================="

      # 4. æ‰§è¡Œæ‰“åŒ…é€»è¾‘å¹¶å¯åŠ¨åº”ç”¨
      - name: Build and Launch
        run: |
          echo "ğŸš€ å®‰è£…ä¾èµ–å¹¶ä¿®å¤ç¼–ç ..."
          sed -i '' 's/chcp 65001 && //g' package.json || true
          npm install          
          
          echo "ğŸ“¦ æ‰“åŒ…ä¸­..."
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          ./node_modules/.bin/electron-builder --mac --x64 --dir

          echo "ğŸ“‚ å¯åŠ¨åº”ç”¨ (å¯åŠ¨ååº”ç”¨ä¼šå‡ºç°åœ¨é»‘è‰²æ¡Œé¢ä¸Š)..."
          APP_PATH=$(find dist/mac -name "*.app" -maxdepth 2 | head -n 1)
          if [ -n "$APP_PATH" ]; then
            open "$APP_PATH"
          else
            echo "âŒ æœªæ‰¾åˆ° .app æ–‡ä»¶"
            ls -R dist/
            exit 1
          fi

      - name: Keep Alive
        run: sleep 21600
