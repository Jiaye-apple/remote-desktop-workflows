name: Build-Full-Project

on:
  workflow_dispatch: # ç¡®ä¿ GitHub é¡µé¢æ˜¾ç¤ºè“è‰²çš„ "Run workflow" æŒ‰é’®

jobs:
  build-and-run:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      # 1. ç¯å¢ƒå‡†å¤‡
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: Jiaye-apple/wftest
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 2. å®‰è£…å·¥å…·
      - name: Install Tools
        run: |
          brew install cliclick cloudflared
          pip3 install flask pillow pyobjc-framework-Quartz --break-system-packages
          echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"

      # 3. é˜²æ­¢ä¼‘çœ 
      - name: Prevent Sleep
        run: |
          caffeinate -d -i -u &
          echo $! > /tmp/caffeinate.pid
          defaults write com.apple.screensaver idleTime 0
          killall SystemUIServer 2>/dev/null || true
          echo "âœ… é˜²ä¼‘çœ è®¾ç½®å®Œæˆ"

      # 4. å¯åŠ¨è¿œç¨‹æ§åˆ¶æœåŠ¡å™¨ï¼ˆä½¿ç”¨Quartzæˆªå›¾ï¼Œä¸ç”¨screencaptureï¼‰
      - name: Start Remote Control Server
        run: |
          cat << 'PYEOF' > remote_server.py
          # -*- coding: utf-8 -*-
          """
          macOSè¿œç¨‹æ§åˆ¶æœåŠ¡å™¨ - ä½¿ç”¨Quartzç›´æ¥è¯»å–å±å¹•
          ç»•è¿‡screencaptureçš„å®‰å…¨é™åˆ¶
          """
          from flask import Flask, send_file, request, jsonify, Response
          import subprocess
          import os
          import io
          import time

          # å°è¯•å¯¼å…¥Quartzè¿›è¡ŒåŸç”Ÿæˆªå›¾
          try:
              import Quartz
              from Quartz import CGWindowListCopyWindowInfo, kCGWindowListOptionOnScreenOnly, kCGNullWindowID
              from Quartz import CGMainDisplayID, CGDisplayBounds, CGWindowListCreateImage, kCGWindowImageDefault
              from Quartz import CGRectInfinite, kCGWindowListOptionAll
              import Quartz.CoreGraphics as CG
              from PIL import Image
              QUARTZ_AVAILABLE = True
              print("âœ… Quartzåº“åŠ è½½æˆåŠŸ")
          except ImportError as e:
              QUARTZ_AVAILABLE = False
              print(f"âš ï¸ Quartzåº“ä¸å¯ç”¨: {e}")

          app = Flask(__name__)

          # å±å¹•åˆ†è¾¨ç‡
          SCREEN_W, SCREEN_H = 1680, 1050

          def get_screen_size():
              """è·å–å±å¹•å°ºå¯¸"""
              global SCREEN_W, SCREEN_H
              try:
                  if QUARTZ_AVAILABLE:
                      main_display = CGMainDisplayID()
                      bounds = CGDisplayBounds(main_display)
                      SCREEN_W = int(bounds.size.width)
                      SCREEN_H = int(bounds.size.height)
              except:
                  pass
              return SCREEN_W, SCREEN_H

          def capture_screen_quartz():
              """ä½¿ç”¨Quartzç›´æ¥æ•è·å±å¹•"""
              try:
                  # æ–¹æ³•1: ä½¿ç”¨CGWindowListCreateImageæ•è·æ•´ä¸ªå±å¹•
                  image = CG.CGWindowListCreateImage(
                      CG.CGRectInfinite,
                      CG.kCGWindowListOptionOnScreenOnly,
                      CG.kCGNullWindowID,
                      CG.kCGWindowImageDefault
                  )
                  
                  if image is None:
                      print("CGWindowListCreateImageè¿”å›None")
                      return None
                  
                  width = CG.CGImageGetWidth(image)
                  height = CG.CGImageGetHeight(image)
                  bytes_per_row = CG.CGImageGetBytesPerRow(image)
                  
                  # è·å–åƒç´ æ•°æ®
                  provider = CG.CGImageGetDataProvider(image)
                  data = CG.CGDataProviderCopyData(provider)
                  
                  # è½¬æ¢ä¸ºPIL Image
                  img = Image.frombytes("RGBA", (width, height), data, "raw", "BGRA", bytes_per_row, 1)
                  
                  # è½¬æ¢ä¸ºPNGå­—èŠ‚æµ
                  output = io.BytesIO()
                  img.save(output, format='PNG')
                  output.seek(0)
                  return output
              except Exception as e:
                  print(f"Quartzæˆªå›¾å¤±è´¥: {e}")
                  return None

          def capture_screen_fallback():
              """å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨screencapture"""
              img_path = '/tmp/screen.png'
              try:
                  # å°è¯•ä¸åŒçš„screencaptureå‚æ•°
                  result = subprocess.run(
                      ['screencapture', '-C', '-x', '-t', 'png', img_path],
                      timeout=10, capture_output=True
                  )
                  if os.path.exists(img_path) and os.path.getsize(img_path) > 1000:
                      return img_path
              except:
                  pass
              return None

          # ç‰¹æ®ŠæŒ‰é”®æ˜ å°„
          KEY_CODES = {
              'enter': 36, 'return': 36, 'tab': 48, 'space': 49,
              'delete': 51, 'backspace': 51, 'escape': 53, 'esc': 53,
              'up': 126, 'down': 125, 'left': 123, 'right': 124,
              'home': 115, 'end': 119, 'pageup': 116, 'pagedown': 121,
              'f1': 122, 'f2': 120, 'f3': 99, 'f4': 118, 'f5': 96,
              'f6': 97, 'f7': 98, 'f8': 100, 'f9': 101, 'f10': 109,
              'f11': 103, 'f12': 111
          }

          @app.route('/')
          def index():
              w, h = get_screen_size()
              return f'''<!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>macOS è¿œç¨‹æ§åˆ¶</title>
              <style>
                  * {{ margin: 0; padding: 0; box-sizing: border-box; }}
                  body {{ 
                      background: #1a1a2e; color: #fff; 
                      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                      min-height: 100vh;
                  }}
                  .toolbar {{
                      background: rgba(30,30,50,0.95);
                      padding: 10px 15px;
                      position: fixed; top: 0; left: 0; right: 0;
                      z-index: 1000;
                      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
                      border-bottom: 1px solid rgba(100,100,255,0.3);
                  }}
                  .group {{
                      display: flex; gap: 5px; align-items: center;
                      padding: 4px 8px;
                      background: rgba(255,255,255,0.05);
                      border-radius: 6px;
                  }}
                  .group label {{ font-size: 11px; color: #888; margin-right: 4px; }}
                  .btn {{
                      background: linear-gradient(135deg, #667eea, #764ba2);
                      color: #fff; border: none; padding: 6px 12px;
                      border-radius: 5px; cursor: pointer; font-size: 12px;
                  }}
                  .btn:hover {{ opacity: 0.9; }}
                  .btn-green {{ background: linear-gradient(135deg, #11998e, #38ef7d); }}
                  .btn-red {{ background: linear-gradient(135deg, #eb3349, #f45c43); }}
                  .btn-gray {{ background: linear-gradient(135deg, #4b6cb7, #182848); }}
                  input, select {{
                      background: #333; color: #fff; border: 1px solid #555;
                      padding: 5px 8px; border-radius: 4px; font-size: 12px;
                  }}
                  .screen-area {{
                      margin-top: 65px; padding: 10px;
                      display: flex; justify-content: center;
                  }}
                  #screen {{
                      max-width: 100%; max-height: calc(100vh - 120px);
                      border: 2px solid rgba(100,100,255,0.4);
                      border-radius: 8px; cursor: crosshair;
                      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                  }}
                  .status {{
                      position: fixed; bottom: 0; left: 0; right: 0;
                      background: rgba(20,20,40,0.95);
                      padding: 6px 15px;
                      display: flex; justify-content: space-between;
                      font-size: 11px; color: #888;
                  }}
                  .toast {{
                      position: fixed; bottom: 50px; left: 50%;
                      transform: translateX(-50%);
                      background: rgba(102,126,234,0.9);
                      padding: 8px 16px; border-radius: 15px;
                      font-size: 12px; opacity: 0; transition: opacity 0.3s;
                  }}
                  .toast.show {{ opacity: 1; }}
              </style>
          </head>
          <body>
              <div class="toolbar">
                  <div class="group">
                      <label>ğŸ“</label>
                      <input type="text" id="textInput" placeholder="è¾“å…¥æ–‡å­—..." style="width:150px" onkeydown="if(event.key==='Enter')sendText()">
                      <button class="btn" onclick="sendText()">å‘é€</button>
                  </div>
                  <div class="group">
                      <label>âŒ¨ï¸</label>
                      <button class="btn btn-green" onclick="sendKey('enter')">Enter</button>
                      <button class="btn btn-gray" onclick="sendKey('tab')">Tab</button>
                      <button class="btn btn-gray" onclick="sendKey('escape')">Esc</button>
                      <button class="btn btn-red" onclick="sendKey('backspace')">âŒ«</button>
                  </div>
                  <div class="group">
                      <label>ğŸ®</label>
                      <button class="btn btn-gray" onclick="sendKey('up')">â†‘</button>
                      <button class="btn btn-gray" onclick="sendKey('down')">â†“</button>
                      <button class="btn btn-gray" onclick="sendKey('left')">â†</button>
                      <button class="btn btn-gray" onclick="sendKey('right')">â†’</button>
                  </div>
                  <div class="group">
                      <label>âš¡</label>
                      <button class="btn" onclick="sendShortcut('c')">âŒ˜C</button>
                      <button class="btn" onclick="sendShortcut('v')">âŒ˜V</button>
                      <button class="btn" onclick="sendShortcut('a')">âŒ˜A</button>
                      <button class="btn" onclick="sendShortcut('z')">âŒ˜Z</button>
                      <button class="btn" onclick="sendShortcut('s')">âŒ˜S</button>
                  </div>
                  <div class="group">
                      <label>ğŸ–±ï¸</label>
                      <select id="clickMode">
                          <option value="c">å•å‡»</option>
                          <option value="dc">åŒå‡»</option>
                          <option value="rc">å³é”®</option>
                      </select>
                  </div>
                  <div class="group">
                      <select id="refreshRate" onchange="setRefresh(this.value)">
                          <option value="800">å¿«é€Ÿ</option>
                          <option value="1500" selected>æ­£å¸¸</option>
                          <option value="3000">æ…¢é€Ÿ</option>
                      </select>
                      <button class="btn btn-gray" onclick="refresh()">åˆ·æ–°</button>
                  </div>
              </div>
              
              <div class="screen-area">
                  <img id="screen" src="/shot" onclick="handleClick(event)" oncontextmenu="handleRightClick(event);return false;">
              </div>
              
              <div class="status">
                  <span>åˆ†è¾¨ç‡: {w}x{h}</span>
                  <span id="pos">åæ ‡: -</span>
                  <span id="time">æ›´æ–°: -</span>
              </div>
              
              <div class="toast" id="toast"></div>
              
              <script>
                  var W={w}, H={h}, interval=null, rate=1500;
                  
                  function startRefresh() {{
                      if(interval) clearInterval(interval);
                      interval = setInterval(function(){{
                          document.getElementById('screen').src = '/shot?t=' + Date.now();
                          document.getElementById('time').textContent = 'æ›´æ–°: ' + new Date().toLocaleTimeString();
                      }}, rate);
                  }}
                  startRefresh();
                  
                  function setRefresh(ms) {{ rate = parseInt(ms); startRefresh(); toast('åˆ·æ–°é—´éš”: '+ms+'ms'); }}
                  function refresh() {{ document.getElementById('screen').src = '/shot?t=' + Date.now(); toast('å·²åˆ·æ–°'); }}
                  
                  function getPos(e) {{
                      var r = e.target.getBoundingClientRect();
                      var xr = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width));
                      var yr = Math.max(0, Math.min(1, (e.clientY - r.top) / r.height));
                      return {{xr:xr, yr:yr, x:Math.round(xr*W), y:Math.round(yr*H)}};
                  }}
                  
                  function handleClick(e) {{
                      var p = getPos(e);
                      var mode = document.getElementById('clickMode').value;
                      document.getElementById('pos').textContent = 'åæ ‡: '+p.x+','+p.y;
                      fetch('/ctl?a='+mode+'&x='+p.xr+'&y='+p.yr).then(function(){{ toast('ç‚¹å‡» '+p.x+','+p.y); }});
                  }}
                  
                  function handleRightClick(e) {{
                      e.preventDefault();
                      var p = getPos(e);
                      fetch('/ctl?a=rc&x='+p.xr+'&y='+p.yr).then(function(){{ toast('å³é”® '+p.x+','+p.y); }});
                      return false;
                  }}
                  
                  function sendText() {{
                      var v = document.getElementById('textInput').value;
                      if(!v) return;
                      fetch('/ctl?a=type&v='+encodeURIComponent(v)).then(function(){{
                          toast('è¾“å…¥: '+v);
                          document.getElementById('textInput').value = '';
                      }});
                  }}
                  
                  function sendKey(k) {{
                      fetch('/ctl?a=key&k='+k).then(function(){{ toast('æŒ‰é”®: '+k); }});
                  }}
                  
                  function sendShortcut(k) {{
                      fetch('/ctl?a=shortcut&k='+k).then(function(){{ toast('âŒ˜+'+k.toUpperCase()); }});
                  }}
                  
                  function toast(msg) {{
                      var t = document.getElementById('toast');
                      t.textContent = msg;
                      t.classList.add('show');
                      setTimeout(function(){{ t.classList.remove('show'); }}, 1200);
                  }}
                  
                  // Windows Ctrlè‡ªåŠ¨æ˜ å°„ä¸ºmacOS Cmd
                  document.addEventListener('keydown', function(e){{
                      if(document.activeElement.tagName === 'INPUT') return;
                      if(e.ctrlKey && ['c','v','x','a','z','s'].indexOf(e.key.toLowerCase()) >= 0) {{
                          e.preventDefault();
                          sendShortcut(e.key.toLowerCase());
                      }}
                  }});
                  
                  toast('ğŸ® è¿œç¨‹æ§åˆ¶å·²å°±ç»ª');
              </script>
          </body>
          </html>'''

          @app.route('/shot')
          def shot():
              """æˆªå–å±å¹•"""
              # æ–¹æ³•1: å°è¯•Quartz
              if QUARTZ_AVAILABLE:
                  img_data = capture_screen_quartz()
                  if img_data:
                      return send_file(img_data, mimetype='image/png')
              
              # æ–¹æ³•2: å¤‡ç”¨screencapture
              img_path = capture_screen_fallback()
              if img_path:
                  return send_file(img_path, mimetype='image/png')
              
              # å…¨éƒ¨å¤±è´¥
              return Response("æˆªå±å¤±è´¥", status=500)

          @app.route('/ctl')
          def ctl():
              """å¤„ç†æ§åˆ¶å‘½ä»¤"""
              a = request.args.get('a', '')
              w, h = get_screen_size()
              
              try:
                  # é¼ æ ‡ç‚¹å‡»
                  if a in ['c', 'dc', 'rc', 'tc']:
                      xr = float(request.args.get('x', 0))
                      yr = float(request.args.get('y', 0))
                      x, y = int(xr * w), int(yr * h)
                      subprocess.run(['cliclick', f'{a}:{x},{y}'], timeout=5)
                  
                  # æ–‡å­—è¾“å…¥
                  elif a == 'type':
                      v = request.args.get('v', '').replace('\\', '\\\\').replace('"', '\\"')
                      if v:
                          subprocess.run(['osascript', '-e', f'tell application "System Events" to keystroke "{v}"'], timeout=10)
                  
                  # ç‰¹æ®ŠæŒ‰é”®
                  elif a == 'key':
                      k = request.args.get('k', '').lower()
                      if k in KEY_CODES:
                          subprocess.run(['osascript', '-e', f'tell application "System Events" to key code {KEY_CODES[k]}'], timeout=5)
                  
                  # å¿«æ·é”®
                  elif a == 'shortcut':
                      k = request.args.get('k', '')
                      if k:
                          subprocess.run(['osascript', '-e', f'tell application "System Events" to keystroke "{k}" using {{command down}}'], timeout=5)
                  
                  return jsonify(status="ok")
              except Exception as e:
                  return jsonify(status="error", msg=str(e)), 500

          @app.route('/health')
          def health():
              return jsonify(status="ok", quartz=QUARTZ_AVAILABLE)

          if __name__ == '__main__':
              get_screen_size()
              print("=" * 50)
              print(f"ğŸ–¥ï¸ å±å¹•å°ºå¯¸: {SCREEN_W} x {SCREEN_H}")
              print(f"ğŸ“· Quartzæˆªå›¾: {'å¯ç”¨' if QUARTZ_AVAILABLE else 'ä¸å¯ç”¨'}")
              print("=" * 50)
              subprocess.run(['killall', 'SystemUIServer'], stderr=subprocess.DEVNULL)
              app.run(host='0.0.0.0', port=8080, threaded=True)
          PYEOF
          
          # å¯åŠ¨æœåŠ¡å™¨
          python3 remote_server.py > /tmp/flask.log 2>&1 &
          sleep 5
          
          # æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨
          if curl -s http://localhost:8080/health > /dev/null; then
            echo "âœ… è¿œç¨‹æ§åˆ¶æœåŠ¡å™¨å·²å¯åŠ¨"
          else
            echo "âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
            cat /tmp/flask.log
          fi

      # 5. åˆ›å»ºéš§é“
      - name: Create Tunnel
        run: |
          cloudflared tunnel --url http://localhost:8080 > /tmp/tunnel.log 2>&1 &
          sleep 12
          
          TUNNEL_URL=$(grep -o 'https://[a-zA-Z0-9\-]*\.trycloudflare\.com' /tmp/tunnel.log | head -n 1)
          
          echo ""
          echo "========================================="
          echo "ğŸ® macOS è¿œç¨‹æ§åˆ¶é¢æ¿"
          echo "========================================="
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€:"
          echo "   $TUNNEL_URL"
          echo ""
          echo "ğŸ“‹ åŠŸèƒ½:"
          echo "   âœ… å±å¹•å®æ—¶æ˜¾ç¤º (ä½¿ç”¨QuartzåŸç”ŸAPI)"
          echo "   âœ… é¼ æ ‡ç‚¹å‡»/åŒå‡»/å³é”®"
          echo "   âœ… æ–‡å­—è¾“å…¥"
          echo "   âœ… å¿«æ·é”® (Ctrlè‡ªåŠ¨æ˜ å°„ä¸ºCmd)"
          echo "   âœ… æ–¹å‘é”®å’ŒåŠŸèƒ½é”®"
          echo ""
          echo "========================================="
          
          echo "$TUNNEL_URL" > /tmp/remote_url.txt

      # 6. æ„å»ºå’Œå¯åŠ¨åº”ç”¨
      - name: Build and Launch
        run: |
          echo "ğŸš€ å®‰è£…ä¾èµ–..."
          sed -i '' 's/chcp 65001 && //g' package.json || true
          npm install
          
          echo "ğŸ“¦ æ‰“åŒ…..."
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          ./node_modules/.bin/electron-builder --mac --x64 --dir

          echo "ğŸ“‚ å¯åŠ¨åº”ç”¨..."
          APP_PATH=$(find dist/mac -name "*.app" -maxdepth 2 | head -n 1)
          if [ -n "$APP_PATH" ]; then
            open "$APP_PATH"
            echo "âœ… åº”ç”¨å·²å¯åŠ¨"
          else
            echo "âŒ æœªæ‰¾åˆ°åº”ç”¨"
            ls -R dist/
          fi
          
          echo ""
          echo "ğŸŒ è¿œç¨‹æ§åˆ¶: $(cat /tmp/remote_url.txt)"

      # 7. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: |
          echo "è¿è¡Œä¸­... è¿œç¨‹æ§åˆ¶: $(cat /tmp/remote_url.txt)"
          sleep 21600
