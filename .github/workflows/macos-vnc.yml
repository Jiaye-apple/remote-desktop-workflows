name: Full-Function-Remote
on: workflow_dispatch

jobs:
  debug-job:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          repository: Jiaye-apple/wf--my-electron-app

      # 1. å®‰è£…å·¥å…· (cliclick æ˜¯æ ¸å¿ƒ)
      - name: Install Utilities
        run: |
          brew install cliclick
          brew install cloudflared
          pip3 install flask --break-system-packages

      # 2. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 3. ä¿®å¤ Windows å‘½ä»¤
      - name: Fix Windows Command
        run: |
          if [ -f "package.json" ]; then
            sed -i '' 's/chcp 65001 && //g' package.json
            echo "âœ… ä¿®å¤å®Œæˆ"
          fi

      # 4. å¯åŠ¨â€œå…¨åŠŸèƒ½â€é¥æ§æœåŠ¡å™¨
      - name: Start Full Remote
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request
          import subprocess
          import urllib.parse
          
          app = Flask(__name__)
          
          @app.route('/')
          def index():
              return '''
              <html>
              <head>
                  <title>Mac å…¨åŠŸèƒ½é¥æ§</title>
                  <meta charset="utf-8">
                  <style>
                      body { background: #222; text-align: center; color: white; margin: 0; font-family: sans-serif; }
                      #screen-container { position: relative; display: inline-block; margin-top: 10px; }
                      #screen { cursor: crosshair; border: 2px solid cyan; max-width: 95%; }
                      #controls { padding: 10px; background: #333; border-bottom: 1px solid #555; display: flex; justify-content: center; gap: 10px; align-items: center; }
                      button { padding: 8px 15px; background: #444; color: white; border: 1px solid #777; cursor: pointer; border-radius: 4px; }
                      button.active { background: #007bff; border-color: #0056b3; }
                      input { padding: 8px; border-radius: 4px; border: none; }
                      .status { color: #aaa; font-size: 12px; margin-top: 5px; }
                  </style>
              </head>
              <body>
                  <div id="controls">
                      <span>æ¨¡å¼:</span>
                      <button id="btnClick" class="active" onclick="setMode('click')">ğŸ–±ï¸ ç‚¹å‡»</button>
                      <button id="btnDrag" onclick="setMode('drag')">âœ‹ æ‹–æ‹½ (Aåˆ°B)</button>
                      <span style="width: 20px;"></span>
                      <input type="text" id="typeText" placeholder="è¾“å…¥æ–‡å­—...">
                      <button onclick="sendText()">âŒ¨ï¸ å‘é€æ–‡æœ¬</button>
                  </div>
                  
                  <div id="screen-container">
                      <img id="screen" src="/shot" draggable="false">
                  </div>
                  <div id="status" class="status">ğŸŸ¢ æ»šè½®å¯æ»šåŠ¨ | ç‚¹å‡»å›¾ç‰‡æ“ä½œ</div>
                  
                  <script>
                      const img = document.getElementById('screen');
                      const status = document.getElementById('status');
                      let mode = 'click';
                      let dragStart = null;
                      
                      // 1. æ¨¡å¼åˆ‡æ¢
                      function setMode(newMode) {
                          mode = newMode;
                          document.getElementById('btnClick').className = mode === 'click' ? 'active' : '';
                          document.getElementById('btnDrag').className = mode === 'drag' ? 'active' : '';
                          dragStart = null;
                          status.innerText = mode === 'drag' ? "ğŸŸ¡ æ‹–æ‹½æ¨¡å¼: è¯·å…ˆç‚¹å‡»èµ·ç‚¹ A" : "ğŸŸ¢ ç‚¹å‡»æ¨¡å¼";
                      }
                      
                      // 2. è‡ªåŠ¨åˆ·æ–°ç”»é¢
                      setInterval(() => {
                          img.src = '/shot?t=' + new Date().getTime();
                      }, 1500);
                      
                      // 3. å¤„ç†ç‚¹å‡» (åŒ…å«æ‹–æ‹½é€»è¾‘)
                      img.onclick = function(event) {
                          const coords = getCoords(event);
                          
                          if (mode === 'click') {
                              status.innerText = `ğŸ–±ï¸ ç‚¹å‡»: ${coords.x}, ${coords.y}`;
                              fetch(`/click?x=${coords.x}&y=${coords.y}`);
                          } else if (mode === 'drag') {
                              if (!dragStart) {
                                  dragStart = coords;
                                  status.innerText = `ğŸŸ¡ èµ·ç‚¹å·²å®š (${coords.x},${coords.y})ï¼Œè¯·ç‚¹å‡»ç»ˆç‚¹ B`;
                              } else {
                                  status.innerText = `ğŸš€ æ‰§è¡Œæ‹–æ‹½: (${dragStart.x},${dragStart.y}) -> (${coords.x},${coords.y})`;
                                  fetch(`/drag?x1=${dragStart.x}&y1=${dragStart.y}&x2=${coords.x}&y2=${coords.y}`);
                                  dragStart = null;
                                  // æ‹–å®Œè‡ªåŠ¨åˆ‡å›ç‚¹å‡»æ¨¡å¼
                                  setTimeout(() => setMode('click'), 1000);
                              }
                          }
                      };
                      
                      // 4. å¤„ç†æ»šè½® (æ¨¡æ‹Ÿæ»šåŠ¨)
                      img.onwheel = function(event) {
                          event.preventDefault();
                          // é™åˆ¶å‘é€é¢‘ç‡ï¼Œé˜²æ­¢å¡æ­»
                          if (event.deltaY > 0) fetch('/scroll?dir=down');
                          else fetch('/scroll?dir=up');
                          status.innerText = event.deltaY > 0 ? "â¬‡ï¸ å‘ä¸‹æ»šåŠ¨" : "â¬†ï¸ å‘ä¸Šæ»šåŠ¨";
                      };
                      
                      // 5. å‘é€æ–‡æœ¬
                      function sendText() {
                          const text = document.getElementById('typeText').value;
                          if(text) fetch('/type?text=' + encodeURIComponent(text));
                      }
                      
                      // è¾…åŠ©ï¼šè®¡ç®—åæ ‡
                      function getCoords(event) {
                          const rect = img.getBoundingClientRect();
                          const scaleX = img.naturalWidth / rect.width;
                          const scaleY = img.naturalHeight / rect.height;
                          return {
                              x: Math.round((event.clientX - rect.left) * scaleX),
                              y: Math.round((event.clientY - rect.top) * scaleY)
                          };
                      }
                  </script>
              </body>
              </html>
              '''
          
          # æ¥å£ï¼šæˆªå›¾
          @app.route('/shot')
          def shot():
              subprocess.run(['screencapture', '-x', '-C', 'screen.png'])
              return send_file('screen.png')
          
          # æ¥å£ï¼šç‚¹å‡»
          @app.route('/click')
          def click():
              x = request.args.get('x')
              y = request.args.get('y')
              # cliclick c:x,y (ç‚¹å‡»)
              subprocess.run(['cliclick', f'c:{x},{y}'])
              return "ok"
          
          # æ¥å£ï¼šæ‹–æ‹½ (Swipe)
          @app.route('/drag')
          def drag():
              x1 = request.args.get('x1')
              y1 = request.args.get('y1')
              x2 = request.args.get('x2')
              y2 = request.args.get('y2')
              # cliclick dd:æŒ‰ä¸‹ w:ç­‰å¾… m:ç§»åŠ¨ du:æŠ¬èµ·
              # æ¨¡æ‹Ÿäººç±»çš„æ‹–åŠ¨æ“ä½œ
              cmd = f'dd:{x1},{y1} w:200 m:{x2},{y2} w:200 du:{x2},{y2}'
              subprocess.run(['cliclick', cmd])
              return "ok"
          
          # æ¥å£ï¼šæ»šåŠ¨
          @app.route('/scroll')
          def scroll():
              direction = request.args.get('dir')
              # ä½¿ç”¨é”®ç›˜ç®­å¤´é”®æ¨¡æ‹Ÿæ»šåŠ¨ (æ¯”æ¨¡æ‹Ÿæ»šè½®æ›´ç¨³å®š)
              key = 'arrow-down' if direction == 'down' else 'arrow-up'
              subprocess.run(['cliclick', f'kp:{key}'])
              return "ok"
              
          # æ¥å£ï¼šæ‰“å­—
          @app.route('/type')
          def type_text():
              text = request.args.get('text')
              # cliclick t:text
              subprocess.run(['cliclick', f't:{text}'])
              return "ok"
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          
          python3 remote_server.py &

      # 5. å¯åŠ¨ Cloudflare
      - name: Start Tunnel
        run: |
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 10
          echo "========================================================"
          echo "ğŸ® å…¨èƒ½é¥æ§å™¨åœ°å€ï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================================"

      # 6. å¯åŠ¨ Electron
      - name: Run Electron
        run: |
          npm install
          ./node_modules/.bin/electron . &

      # 7. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: sleep 21600
