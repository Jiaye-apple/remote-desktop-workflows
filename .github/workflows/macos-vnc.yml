name: Force-Login-123456
on: workflow_dispatch

jobs:
  debug:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1.ã€æš´åŠ›ä¿®æ”¹ã€‘å°†ç³»ç»Ÿç”¨æˆ· runner çš„ç™»å½•å¯†ç å¼ºåˆ¶æ”¹ä¸º 123456
      - name: Force Reset System Password
        run: |
          echo "æ­£åœ¨æš´åŠ›é‡ç½®ç³»ç»Ÿå¯†ç ..."
          sudo dscl . -passwd /Users/runner 123456
          echo "âœ… ç³»ç»Ÿç”¨æˆ· runner å¯†ç å·²æ”¹ä¸º 123456"

      # 2.ã€æš´åŠ›ä¿®æ”¹ã€‘å°† VNC è¿œç¨‹è¿æ¥å¯†ç å¼ºåˆ¶æ”¹ä¸º 123456
      - name: Force Reset VNC Password
        run: |
          echo "æ­£åœ¨æš´åŠ›é‡ç½® VNC å¯†ç ..."
          # å¼€å¯å±å¹•å…±äº«æœåŠ¡
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # å¼ºåˆ¶å†™å…¥ VNC å¯†ç 
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw 123456
          echo "âœ… VNC è¿æ¥å¯†ç å·²æ”¹ä¸º 123456"

      # 3. å®‰è£…å¹¶å¯åŠ¨ noVNC (æºç ç‰ˆï¼Œæœ€ç¨³)
      - name: Start noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          git clone https://github.com/novnc/websockify noVNC/utils/websockify
          ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

      # 4. å¯åŠ¨ Cloudflare éš§é“ (æ— éœ€ Token)
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "ç­‰å¾…ç”Ÿæˆé“¾æ¥..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸ”— åªæœ‰ä¸‹é¢è¿™ä¸ªé“¾æ¥èƒ½è¿›ï¼Œå¤åˆ¶å®ƒï¼š"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "ğŸ‘¤ ç”¨æˆ·å: runner"
          echo "ğŸ”‘ å¯†  ç : 123456"
          echo "========================================================"

      - name: Keep Alive
        run: sleep 21600
