name: Build-Run-Remote-Pro
on: workflow_dispatch

jobs:
  test-release:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          repository: Jiaye-apple/wf--my-electron-app

      # 1. å®‰è£…é¥æ§å·¥å…·
      - name: Install Tools
        run: |
          brew install cliclick
          brew install cloudflared
          pip3 install flask --break-system-packages

      # 2. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 3. ä¿®å¤ Windows å‘½ä»¤
      - name: Fix package.json
        run: |
          if [ -f "package.json" ]; then
            sed -i '' 's/chcp 65001 && //g' package.json
          fi

      # 4. ã€æ ¸å¿ƒå‡çº§ã€‘å¯åŠ¨æ”¯æŒå³é”®å’ŒåŒå‡»çš„é¥æ§å™¨
      - name: Start Remote Controller
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request
          import subprocess
          import urllib.parse
          
          app = Flask(__name__)
          
          @app.route('/')
          def index():
              return '''
              <html>
              <head>
                  <title>Mac å…¨èƒ½é¥æ§å™¨</title>
                  <meta charset="utf-8">
                  <style>
                      body { background: #222; text-align: center; color: white; margin: 0; font-family: sans-serif; }
                      #screen-box { margin-top: 10px; display: inline-block; position: relative; border: 2px solid #555; }
                      #screen { cursor: crosshair; max-width: 95%; display: block; }
                      
                      /* æ§åˆ¶æ æ ·å¼ */
                      .controls { padding: 10px; background: #333; border-bottom: 1px solid #444; position: sticky; top: 0; }
                      .btn-group { display: inline-flex; gap: 5px; margin-right: 15px; }
                      button { padding: 8px 12px; background: #444; color: #ccc; border: 1px solid #666; cursor: pointer; border-radius: 4px; font-size: 14px; }
                      button:hover { background: #555; }
                      
                      /* é€‰ä¸­çŠ¶æ€ */
                      button.active { background: #007bff; color: white; border-color: #0056b3; font-weight: bold; }
                      
                      input { padding: 8px; border-radius: 4px; border: 1px solid #555; background: #111; color: white; width: 150px; }
                  </style>
              </head>
              <body>
                  <div class="controls">
                      <div class="btn-group">
                          <button id="btn-click" class="active" onclick="setMode('click')">ğŸ–±ï¸ å·¦é”®</button>
                          <button id="btn-double" onclick="setMode('double')">ğŸ–±ï¸ğŸ–±ï¸ åŒå‡»</button>
                          <button id="btn-right" onclick="setMode('right')">ğŸ–±ï¸ å³é”®</button>
                      </div>
                      
                      <div class="btn-group">
                          <input type="text" id="txtInput" placeholder="è¾“å…¥æ–‡å­—...">
                          <button onclick="sendText()">âŒ¨ï¸ å‘é€</button>
                          <button onclick="sendEnter()">â†µ å›è½¦</button>
                      </div>
                      
                      <span id="status" style="margin-left:10px; color:#0f0; font-size: 12px;">ğŸŸ¢ å‡†å¤‡å°±ç»ª</span>
                  </div>
                  
                  <div id="screen-box">
                      <img id="screen" src="/shot" onclick="handleClick(event)">
                  </div>
                  
                  <script>
                      const img = document.getElementById('screen');
                      const status = document.getElementById('status');
                      let currentMode = 'click'; // é»˜è®¤å·¦é”®æ¨¡å¼
                      
                      // 1. è‡ªåŠ¨åˆ·æ–°ç”»é¢ (1.5ç§’ä¸€æ¬¡)
                      setInterval(() => { img.src = '/shot?t=' + new Date().getTime(); }, 1500);
                      
                      // 2. åˆ‡æ¢é¼ æ ‡æ¨¡å¼
                      function setMode(mode) {
                          currentMode = mode;
                          // æ›´æ–°æŒ‰é’®æ ·å¼
                          document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                          if(mode === 'click') document.getElementById('btn-click').classList.add('active');
                          if(mode === 'double') document.getElementById('btn-double').classList.add('active');
                          if(mode === 'right') document.getElementById('btn-right').classList.add('active');
                          
                          let modeName = mode === 'click' ? "å·¦é”®" : (mode === 'double' ? "åŒå‡»" : "å³é”®");
                          status.innerText = "ğŸŸ¡ å½“å‰æ¨¡å¼: " + modeName + " (è¯·ç‚¹å‡»å±å¹•)";
                      }
                      
                      // 3. å¤„ç†ç‚¹å‡»äº‹ä»¶
                      function handleClick(event) {
                          const rect = img.getBoundingClientRect();
                          // è®¡ç®—çœŸå®åæ ‡
                          const x = Math.round((event.clientX - rect.left) * (img.naturalWidth / rect.width));
                          const y = Math.round((event.clientY - rect.top) * (img.naturalHeight / rect.height));
                          
                          status.innerText = `ğŸš€ å‘é€æŒ‡ä»¤: ${currentMode} -> (${x}, ${y})`;
                          
                          // å‘é€ç»™åç«¯ï¼Œå¸¦ä¸Š mode å‚æ•°
                          fetch(`/action?mode=${currentMode}&x=${x}&y=${y}`)
                              .then(() => {
                                  // å¦‚æœæ˜¯åŒå‡»æˆ–å³é”®ï¼Œæ“ä½œå®Œè‡ªåŠ¨åˆ‡å›å·¦é”®ï¼Œæ–¹ä¾¿åç»­æ“ä½œ
                                  if(currentMode !== 'click') {
                                      setTimeout(() => setMode('click'), 1000);
                                  }
                              });
                      }
                      
                      // 4. å‘é€æ–‡å­—
                      function sendText() {
                          const val = document.getElementById('txtInput').value;
                          if(val) fetch('/type?text=' + encodeURIComponent(val));
                      }
                      
                      // 5. å‘é€å›è½¦
                      function sendEnter() {
                          fetch('/key?k=return');
                      }
                  </script>
              </body>
              </html>
              '''
          
          @app.route('/shot')
          def shot():
              subprocess.run(['screencapture', '-x', '-C', 'screen.png'])
              return send_file('screen.png')
          
          # ç»Ÿä¸€å¤„ç†é¼ æ ‡åŠ¨ä½œ
          @app.route('/action')
          def action():
              mode = request.args.get('mode')
              x = request.args.get('x')
              y = request.args.get('y')
              
              cmd = ''
              if mode == 'click':
                  cmd = f'c:{x},{y}'   # å•å‡»
              elif mode == 'double':
                  cmd = f'dc:{x},{y}'  # åŒå‡» (Double Click)
              elif mode == 'right':
                  cmd = f'rc:{x},{y}'  # å³é”® (Right Click)
                  
              print(f"Executing: {cmd}")
              subprocess.run(['cliclick', cmd])
              return "ok"

          @app.route('/type')
          def type_text():
              text = request.args.get('text')
              subprocess.run(['cliclick', f't:{text}'])
              return "ok"
              
          @app.route('/key')
          def key_press():
              k = request.args.get('k')
              subprocess.run(['cliclick', f'kp:{k}'])
              return "ok"
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          python3 remote_server.py &

      # 5. å¯åŠ¨ Cloudflare (ç”Ÿæˆé“¾æ¥)
      - name: Start Tunnel
        run: |
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 10
          echo "========================================================"
          echo "ğŸ® é¥æ§é“¾æ¥ï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================================"

      # 6. æ„å»ºå¹¶è¿è¡Œ (ä¿ç•™ä½ ä¹‹å‰çš„é…ç½®)
      - name: Build and Run
        run: |
          echo "ğŸš€ å®‰è£…ä¾èµ–..."
          npm install
          npm install --save-dev electron-builder
          
          echo "ğŸ“¦ æ­£åœ¨æ„å»º (ç”Ÿæˆå¯è¿è¡Œçš„ .app)..."
          ./node_modules/.bin/electron-builder --mac --x64 --dir
          
          echo "ğŸ“‚ æŸ¥çœ‹æ„å»ºç»“æœï¼š"
          ls -R dist/mac/
          
          echo "ğŸš€ æ­£åœ¨å¯åŠ¨åº”ç”¨..."
          APP_PATH=$(find dist/mac -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ è¿˜æ˜¯æ²¡æ‰¾åˆ° .app æ–‡ä»¶ï¼"
            exit 1
          else
            echo "âœ… æ‰¾åˆ°åº”ç”¨: $APP_PATH"
            open "$APP_PATH"
          fi

      # 7. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: sleep 21600
