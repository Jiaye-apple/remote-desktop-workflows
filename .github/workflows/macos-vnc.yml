name: macOS-Remote-Desktop-Fixed
on: workflow_dispatch

jobs:
  desktop:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep & Screensaver
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime 0
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ å’Œå±ä¿"

      # 2. ä½¿ç”¨æ›´å¯é çš„æ–¹å¼å¯åŠ¨ VNCï¼ˆå…³é”®ä¿®å¤ï¼‰
      - name: Start VNC Server - Method 1
        run: |
          VNC_PASSWORD="jerrylin03@"
          echo "ä½¿ç”¨å¯†ç : $VNC_PASSWORD"
          
          # æ–¹æ³•1: ç›´æŽ¥å¯åŠ¨å±å¹•å…±äº«
          sudo launchctl enable system/com.apple.screensharing
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # æ–¹æ³•2: ä½¿ç”¨ kickstart æ¿€æ´»
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # è®¾ç½® VNC å¯†ç  - ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿æˆåŠŸ
          # æ–¹æ³•A: æ ‡å‡†æ–¹å¼
          printf "%s" "$VNC_PASSWORD" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw -
          
          # æ–¹æ³•B: åˆ›å»ºå¯†ç æ–‡ä»¶
          sudo mkdir -p /Library/Preferences/com.apple.VNCSettings
          echo "$VNC_PASSWORD" | sudo tee /Library/Preferences/com.apple.VNCSettings/VNCPassword.txt > /dev/null
          
          # é‡å¯æœåŠ¡
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          
          echo "VNC_PASSWORD=$VNC_PASSWORD" >> $GITHUB_ENV
          echo "âœ… VNC æœåŠ¡é…ç½®å®Œæˆ"
          sleep 8

      # 3. éªŒè¯ VNC ç«¯å£
      - name: Verify VNC Port
        run: |
          echo "æ£€æŸ¥ VNC ç«¯å£ 5900..."
          for i in {1..15}; do
            if sudo lsof -i :5900 | grep -q LISTEN; then
              echo "âœ… VNC æ­£åœ¨ç›‘å¬ç«¯å£ 5900"
              sudo lsof -i :5900
              break
            else
              echo "â³ ç­‰å¾… VNC å¯åŠ¨... ($i/15)"
              sleep 2
            fi
          done
          
          # æ˜¾ç¤º VNC ç›¸å…³è¿›ç¨‹
          echo ""
          echo "VNC ç›¸å…³è¿›ç¨‹:"
          ps aux | grep -i "ard\|vnc\|screen" | grep -v grep || echo "æœªæ‰¾åˆ° VNC è¿›ç¨‹"

      # 4. å®‰è£… noVNCï¼ˆä½¿ç”¨æ— å¯†ç æ¨¡å¼ï¼‰
      - name: Setup noVNC - No Auth Mode
        run: |
          echo "æ­£åœ¨å®‰è£… noVNC..."
          git clone --depth 1 https://github.com/novnc/noVNC.git
          git clone --depth 1 https://github.com/novnc/websockify.git noVNC/utils/websockify
          
          # å®‰è£…ä¾èµ–
          python3 -m pip install numpy --break-system-packages 2>/dev/null || pip3 install numpy
          
          echo "âœ… noVNC å®‰è£…å®Œæˆ"

      # 5. å¯åŠ¨ noVNCï¼ˆå…³é”®ï¼šä½¿ç”¨ --web å‚æ•°ç®€åŒ–è®¤è¯ï¼‰
      - name: Start noVNC
        run: |
          cd noVNC
          # ä½¿ç”¨ --web å‚æ•°ï¼Œè®© noVNC è‡ªåŠ¨å¤„ç†è®¤è¯
          nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 --web . > ../novnc.log 2>&1 &
          
          sleep 5
          
          if lsof -i :6080 > /dev/null 2>&1; then
            echo "âœ… noVNC å·²å¯åŠ¨åœ¨ç«¯å£ 6080"
          else
            echo "âŒ noVNC å¯åŠ¨å¤±è´¥ï¼ŒæŸ¥çœ‹æ—¥å¿—:"
            cat ../novnc.log
            exit 1
          fi

      # 6. å¯åŠ¨ Cloudflare Tunnel
      - name: Start Cloudflare Tunnel
        run: |
          echo "æ­£åœ¨å®‰è£… cloudflared..."
          brew install cloudflared
          
          echo "æ­£åœ¨å¯åŠ¨ Cloudflare éš§é“..."
          nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "ç­‰å¾…éš§é“å»ºç«‹..."
          sleep 20
          
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "âŒ æœªèƒ½èŽ·å–éš§é“åœ°å€"
            cat tunnel.log
            exit 1
          fi
          
          echo "=========================================================="
          echo "ðŸŒ è¿œç¨‹æ¡Œé¢è®¿é—®åœ°å€ï¼š"
          echo "=========================================================="
          echo ""
          echo "   $TUNNEL_URL"
          echo ""
          echo "=========================================================="
          echo "ðŸ”‘ VNC å¯†ç : $VNC_PASSWORD"
          echo "=========================================================="
          echo ""
          echo "ðŸ“– ä½¿ç”¨è¯´æ˜Žï¼š"
          echo "   1. å¤åˆ¶ä¸Šé¢çš„é“¾æŽ¥åœ¨æµè§ˆå™¨æ‰“å¼€"
          echo "   2. ç‚¹å‡» 'Connect' æŒ‰é’®"
          echo "   3. åœ¨å¯†ç æ¡†è¾“å…¥: $VNC_PASSWORD"
          echo "   4. ç”¨æˆ·åç•™ç©ºï¼"
          echo "=========================================================="
          echo ""
          echo "ðŸ”§ å¦‚æžœè¿˜æ˜¯æç¤ºå¯†ç é”™è¯¯ï¼Œå°è¯•ä»¥ä¸‹å¯†ç ï¼š"
          echo "   - 123456"
          echo "   - (ç•™ç©ºï¼Œç›´æŽ¥ç‚¹ Connect)"
          echo "=========================================================="
          
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV

      # 7. å°è¯•å¦ä¸€ç§ VNC é…ç½®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
      - name: Alternative VNC Setup
        run: |
          echo "æ‰§è¡Œå¤‡ç”¨ VNC é…ç½®..."
          
          # ä½¿ç”¨ç³»ç»Ÿåå¥½è®¾ç½®å¯ç”¨å±å¹•å…±äº«
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
          
          # å†æ¬¡è®¾ç½®å¯†ç 
          echo "jerrylin03@" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw 2>/dev/null || true
          
          # ç¡®ä¿æœåŠ¡è¿è¡Œ
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          
          sleep 3
          echo "âœ… å¤‡ç”¨é…ç½®å®Œæˆ"

      # 8. æ˜¾ç¤ºè¯¦ç»†çš„è¿žæŽ¥ä¿¡æ¯å’Œè°ƒè¯•ä¿¡æ¯
      - name: Connection Info & Debug
        run: |
          echo ""
          echo "=========================================================="
          echo "ðŸ”— æœ€ç»ˆè¿žæŽ¥ä¿¡æ¯"
          echo "=========================================================="
          echo "è®¿é—®é“¾æŽ¥: $TUNNEL_URL"
          echo "VNC å¯†ç : $VNC_PASSWORD"
          echo ""
          echo "å¦‚æžœå¯†ç ä¸å¯¹ï¼Œè¯·å°è¯•ï¼š"
          echo "  1. ç›´æŽ¥ç‚¹ Connectï¼ˆä¸è¾“å…¥å¯†ç ï¼‰"
          echo "  2. è¾“å…¥: jerrylin03@"
          echo "  3. è¾“å…¥: 123456"
          echo "=========================================================="
          echo ""
          echo "ðŸ“Š ç«¯å£ç›‘å¬çŠ¶æ€:"
          sudo lsof -i :5900 || echo "ç«¯å£ 5900 æœªç›‘å¬"
          lsof -i :6080 || echo "ç«¯å£ 6080 æœªç›‘å¬"
          echo ""
          echo "ðŸ“‹ noVNC æ—¥å¿—:"
          cat novnc.log | head -n 20
          echo "=========================================================="

      # 9. ä¿æŒè¿è¡Œå¹¶ç›‘æŽ§
      - name: Keep Alive with Monitoring
        run: |
          echo "âœ… æœåŠ¡è¿è¡Œä¸­ï¼Œå¼€å§‹ç›‘æŽ§..."
          echo "ðŸ”— è®¿é—®é“¾æŽ¥: $TUNNEL_URL"
          echo "ðŸ”‘ å¯†ç : $VNC_PASSWORD"
          
          for i in {1..360}; do
            sleep 60
            
            # æ¯10åˆ†é’Ÿæ˜¾ç¤ºä¸€æ¬¡çŠ¶æ€
            if [ $((i % 10)) -eq 0 ]; then
              echo "âœ… [$i/360] æœåŠ¡è¿è¡Œæ­£å¸¸ (å·²è¿è¡Œ $i åˆ†é’Ÿ)"
              echo "ðŸ”— é“¾æŽ¥: $TUNNEL_URL"
            fi
            
            # æ£€æŸ¥å¹¶é‡å¯æœåŠ¡
            if ! pgrep -f novnc_proxy > /dev/null; then
              echo "âš ï¸  noVNC é‡å¯ä¸­..."
              cd noVNC && nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 --web . > ../novnc.log 2>&1 &
            fi
            
            if ! pgrep -f cloudflared > /dev/null; then
              echo "âš ï¸  Cloudflare é‡å¯ä¸­..."
              nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
              sleep 10
              grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
            fi
          done
