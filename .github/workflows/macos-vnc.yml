name: Build-And-Play-Mac
on: workflow_dispatch

jobs:
  test-release:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          repository: Jiaye-apple/wf--my-electron-app

      # 2. å®‰è£…é¥æ§å·¥å…· (cliclick + cloudflared)
      - name: Install Tools
        run: |
          brew install cliclick
          brew install cloudflared
          pip3 install flask --break-system-packages

      # 3. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 4. ä¿®å¤ Windows å‘½ä»¤ (å¿…åš)
      - name: Fix package.json
        run: |
          if [ -f "package.json" ]; then
            sed -i '' 's/chcp 65001 && //g' package.json
          fi

      # 5. å¯åŠ¨â€œå…¨åŠŸèƒ½â€é¥æ§æœåŠ¡å™¨ (è®©ä½ èƒ½æ“ä½œ)
      - name: Start Remote Controller
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request
          import subprocess
          
          app = Flask(__name__)
          
          @app.route('/')
          def index():
              return '''
              <html>
              <head>
                  <title>Mac æ‰“åŒ…æµ‹è¯•é¥æ§å™¨</title>
                  <style>
                      body { background: #222; text-align: center; color: white; margin: 0; font-family: sans-serif; }
                      #screen { cursor: crosshair; border: 2px solid cyan; max-width: 95%; margin-top: 10px;}
                      .controls { padding: 10px; background: #333; }
                      button { padding: 8px 15px; background: #444; color: white; border: 1px solid #777; cursor: pointer; border-radius: 4px; }
                      button:hover { background: #555; }
                  </style>
              </head>
              <body>
                  <div class="controls">
                      <strong>æ“ä½œæ¨¡å¼ï¼š</strong>
                      <button onclick="setMode('click')">ğŸ–±ï¸ ç‚¹å‡»</button>
                      <button onclick="setMode('type')">âŒ¨ï¸ è¾“å…¥æ–‡å­—</button>
                      <span id="status" style="margin-left:10px; color:#0f0;">ğŸŸ¢ å®æ—¶ç›‘æ§ä¸­</span>
                  </div>
                  <img id="screen" src="/shot" onclick="handleClick(event)">
                  
                  <script>
                      const img = document.getElementById('screen');
                      let mode = 'click';
                      
                      // 1. è‡ªåŠ¨åˆ·æ–°ç”»é¢
                      setInterval(() => { img.src = '/shot?t=' + new Date().getTime(); }, 1500);
                      
                      // 2. æ¨¡å¼åˆ‡æ¢
                      window.setMode = (m) => { 
                          mode = m; 
                          if(m === 'type') {
                              let t = prompt("è¯·è¾“å…¥è¦å‘é€åˆ° Mac çš„æ–‡å­—:");
                              if(t) fetch('/type?text=' + encodeURIComponent(t));
                              mode = 'click';
                          }
                      }
                      
                      // 3. å¤„ç†ç‚¹å‡»
                      function handleClick(event) {
                          const rect = img.getBoundingClientRect();
                          const scaleX = img.naturalWidth / rect.width;
                          const scaleY = img.naturalHeight / rect.height;
                          const x = Math.round((event.clientX - rect.left) * scaleX);
                          const y = Math.round((event.clientY - rect.top) * scaleY);
                          
                          document.getElementById('status').innerText = `ğŸ–±ï¸ ç‚¹å‡»: ${x}, ${y}`;
                          fetch(`/click?x=${x}&y=${y}`);
                      }
                  </script>
              </body>
              </html>
              '''
          
          @app.route('/shot')
          def shot():
              subprocess.run(['screencapture', '-x', '-C', 'screen.png'])
              return send_file('screen.png')
          
          @app.route('/click')
          def click():
              x = request.args.get('x')
              y = request.args.get('y')
              subprocess.run(['cliclick', f'c:{x},{y}'])
              return "ok"
              
          @app.route('/type')
          def type_text():
              text = request.args.get('text')
              subprocess.run(['cliclick', f't:{text}'])
              return "ok"
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          python3 remote_server.py &

      # 6. å¯åŠ¨ Cloudflare (ç”Ÿæˆé“¾æ¥)
      - name: Start Tunnel
        run: |
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 10
          echo "========================================================"
          echo "ğŸ® é¥æ§é“¾æ¥å·²ç”Ÿæˆï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================================"

      # 7. ã€æ ¸å¿ƒã€‘æ‰“åŒ…å¹¶è¿è¡Œæ‰“åŒ…å¥½çš„è½¯ä»¶
      - name: Build and Open App
        run: |
          echo "ğŸš€ å®‰è£…ä¾èµ–..."
          npm install
          npm install --save-dev electron-builder
          
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ… (è¿™éœ€è¦å‡ åˆ†é’Ÿ)..."
          ./node_modules/.bin/electron-builder --mac --x64
          
          echo "âœ… æ‰“åŒ…å®Œæˆï¼å‡†å¤‡è¿è¡Œ..."
          
          # æ‰¾åˆ°æ‰“åŒ…å‡ºæ¥çš„ .app æ–‡ä»¶å¹¶æ‰“å¼€
          # é€šå¸¸åœ¨ dist/mac/ æˆ–è€… dist/ ç›®å½•ä¸‹
          APP_PATH=$(find dist -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ æœªæ‰¾åˆ° .app æ–‡ä»¶ï¼Œæ‰“åŒ…å¯èƒ½å¤±è´¥"
            ls -R dist/
            exit 1
          else
            echo "ğŸš€ æ­£åœ¨æ‰“å¼€æ‰“åŒ…å¥½çš„åº”ç”¨: $APP_PATH"
            open -a "$APP_PATH"
          fi

      # 8. ä¿æŒè¿è¡Œ (è®©ä½ æ…¢æ…¢æµ‹è¯•)
      - name: Keep Alive
        run: sleep 21600
