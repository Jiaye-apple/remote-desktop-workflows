name: Build-Full-Project

on:
  workflow_dispatch: # ç¡®ä¿ GitHub é¡µé¢æ˜¾ç¤ºè“è‰²çš„ "Run workflow" æŒ‰é’®

jobs:
  build-and-run:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      # 1. ç¯å¢ƒå‡†å¤‡
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: Jiaye-apple/wftest
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Tools
        run: |
          brew install cliclick cloudflared
          python3 -m pip install flask --break-system-packages

      # 2. å¯åŠ¨å…¨åŠŸèƒ½é¥æ§å™¨ (è§£å†³é»‘å±ã€åˆ†è¾¨ç‡å¯¹ä¸ä¸Šã€æ“ä½œæ— ååº”)
      - name: Start Remote Monitor
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request, jsonify
          import subprocess, os, re

          app = Flask(__name__)

          def get_actual_res():
              try:
                  # å¼ºåˆ¶è·å– macOS è™šæ‹Ÿæ˜¾ç¤ºå™¨çš„çœŸå®ç‰©ç†åˆ†è¾¨ç‡
                  out = subprocess.check_output("system_profiler SPDisplaysDataType | grep Resolution", shell=True).decode()
                  match = re.search(r'(\d+) x (\d+)', out)
                  if match: return int(match.group(1)), int(match.group(2))
              except: pass
              return 1280, 960

          @app.route('/')
          def index():
              w, h = get_actual_res()
              return f'''
              <html>
              <head>
                  <title>macOS Master Control</title>
                  <style>
                      body {{ background: #000; color: #fff; font-family: sans-serif; margin: 0; }}
                      .top-bar {{ background: #222; padding: 10px; display: flex; gap: 10px; position: fixed; top:0; width:100%; z-index:100; border-bottom: 2px solid #007bff; }}
                      .screen-container {{ margin-top: 60px; overflow: auto; width: 100vw; height: calc(100vh - 60px); }}
                      #screen {{ border: 1px solid #444; cursor: crosshair; }}
                      .btn {{ background: #007bff; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px; }}
                      input {{ background: #000; color: #fff; border: 1px solid #444; padding: 8px; width: 200px; }}
                      #info {{ color: #ffcc00; font-size: 12px; margin-left: 10px; }}
                  </style>
              </head>
              <body>
                  <div class="top-bar">
                      <input type="text" id="ti" placeholder="è¾“å…¥æ–‡å­—...">
                      <button class="btn" onclick="send('type')">è¾“å…¥</button>
                      <button class="btn" onclick="send('enter')" style="background:#28a745">å›è½¦</button>
                      <button class="btn" onclick="send('cmd_v')" style="background:#d9534f">ç²˜è´´(Cmd+V)</button>
                      <button class="btn" onclick="location.reload()" style="background:#666">å¼ºåˆ¶åˆ·æ–°</button>
                      <span id="info">åˆ†è¾¨ç‡: {w}x{h}</span>
                  </div>
                  <div class="screen-container">
                      <img id="screen" src="/shot" onclick="handleClick(event)">
                  </div>
                  <script>
                      const W = {w}; const H = {h};
                      setInterval(() => {{
                          document.getElementById("screen").src = "/shot?t=" + new Date().getTime();
                      }}, 1500);

                      function handleClick(e) {{
                          const rect = e.target.getBoundingClientRect();
                          const xr = (e.clientX - rect.left) / rect.width;
                          const yr = (e.clientY - rect.top) / rect.height;
                          fetch(`/ctl?a=click&x=${{xr}}&y=${{yr}}`);
                      }}

                      function send(t) {{
                          const v = document.getElementById("ti").value;
                          fetch(`/ctl?a=${{t}}&v=${{encodeURIComponent(v)}}`);
                          if(t==='type') document.getElementById("ti").value = "";
                      }}
                  </script>
              </body>
              </html>
              '''

          @app.route('/shot')
          def shot():
              img_path = os.path.join(os.getcwd(), 'screen.png')
              # -C æ˜¾ç¤ºé¼ æ ‡æŒ‡é’ˆ, -x é™éŸ³
              subprocess.run(['screencapture', '-C', '-x', img_path])
              return send_file(img_path)

          @app.route('/ctl')
          def ctl():
              a = request.args.get('a'); w, h = get_actual_res()
              if a == 'click':
                  x, y = int(float(request.args.get('x')) * w), int(float(request.args.get('y')) * h)
                  subprocess.run(['cliclick', f'c:{x},{y}'])
              elif a == 'type':
                  v = request.args.get('v').replace('"', '\\"')
                  subprocess.run(['osascript', '-e', f'tell application "System Events" to keystroke "{v}"'])
              elif a == 'enter':
                  subprocess.run(['osascript', '-e', 'tell application "System Events" to key code 36'])
              elif a == 'cmd_v':
                  subprocess.run(['osascript', '-e', 'tell application "System Events" to keystroke "v" using {{command down}}'])
              return jsonify(s="ok")

          if __name__ == '__main__':
              # å°è¯•å”¤é†’ UI
              subprocess.run(['killall', 'SystemUIServer'], stderr=subprocess.DEVNULL)
              app.run(host='0.0.0.0', port=8080)
          EOF
          python3 remote_server.py > flask.log 2>&1 &
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 10
          echo "========================================="
          echo "ğŸ® è¿œç¨‹æ§åˆ¶é¢æ¿ (å…¨å±æ»šåŠ¨+ç²¾å‡†ç‚¹å‡»):"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================="

      # 3. æ‰§è¡Œæ‰“åŒ…é€»è¾‘å¹¶å¯åŠ¨åº”ç”¨
      - name: Build and Launch
        run: |
          echo "ğŸš€ å®‰è£…ä¾èµ–å¹¶ä¿®å¤ç¼–ç ..."
          sed -i '' 's/chcp 65001 && //g' package.json || true
          npm install          
          
          echo "ğŸ“¦ æ‰“åŒ…ä¸­..."
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          ./node_modules/.bin/electron-builder --mac --x64 --dir

          echo "ğŸ“‚ å¯åŠ¨åº”ç”¨ (å¯åŠ¨ååº”ç”¨ä¼šå‡ºç°åœ¨é»‘è‰²æ¡Œé¢ä¸Š)..."
          APP_PATH=$(find dist/mac -name "*.app" -maxdepth 2 | head -n 1)
          if [ -n "$APP_PATH" ]; then
            open "$APP_PATH"
          else
            echo "âŒ æœªæ‰¾åˆ° .app æ–‡ä»¶"
            ls -R dist/
            exit 1
          fi

      - name: Keep Alive
        run: sleep 21600
