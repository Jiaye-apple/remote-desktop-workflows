name: Build-Full-Project

on:
  workflow_dispatch: # ç¡®ä¿ GitHub é¡µé¢æ˜¾ç¤ºè“è‰²çš„ "Run workflow" æŒ‰é’®

jobs:
  build-and-run:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      # 1. ç¯å¢ƒå‡†å¤‡
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: Jiaye-apple/wftest
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 2. å®‰è£…VNCå’Œè¿œç¨‹æ§åˆ¶å·¥å…·
      - name: Install VNC Tools
        run: |
          brew install cloudflared
          
          # å®‰è£…noVNC (ç½‘é¡µVNCå®¢æˆ·ç«¯)
          git clone --depth 1 https://github.com/novnc/noVNC.git /tmp/noVNC
          
          # å®‰è£…websockify (WebSocketåˆ°TCPä»£ç†)
          pip3 install websockify --break-system-packages
          
          # å®‰è£…cliclickç”¨äºé¼ æ ‡/é”®ç›˜æ§åˆ¶
          brew install cliclick
          
          echo "âœ… VNCå·¥å…·å®‰è£…å®Œæˆ"

      # 3. å¯ç”¨macOSå±å¹•å…±äº«ï¼ˆVNCæœåŠ¡å™¨ï¼‰
      - name: Enable Screen Sharing
        run: |
          # è®¾ç½®VNCå¯†ç 
          VNC_PASSWORD="remote123"
          
          # å¯ç”¨macOSå†…ç½®çš„å±å¹•å…±äº«æœåŠ¡
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASSWORD" \
            -restart -agent -privs -all
          
          # ç¡®ä¿å±å¹•å…±äº«æœåŠ¡å¯åŠ¨
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # é˜²æ­¢ç³»ç»Ÿä¼‘çœ 
          caffeinate -d -i -u &
          echo $! > /tmp/caffeinate.pid
          
          # ç¦ç”¨å±ä¿
          defaults write com.apple.screensaver idleTime 0
          
          # ç­‰å¾…VNCæœåŠ¡å¯åŠ¨
          sleep 5
          
          # æ£€æŸ¥VNCç«¯å£
          if lsof -i :5900 > /dev/null 2>&1; then
            echo "âœ… VNCæœåŠ¡å™¨å·²å¯åŠ¨ (ç«¯å£5900)"
          else
            echo "âš ï¸ VNCç«¯å£æœªç›‘å¬ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ..."
            # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨x11vnc
            brew install x11vnc || true
            x11vnc -display :0 -forever -shared -rfbport 5900 -passwd "$VNC_PASSWORD" &
            sleep 3
          fi
          
          echo "VNCå¯†ç : $VNC_PASSWORD"

      # 4. å¯åŠ¨noVNCç½‘é¡µæœåŠ¡
      - name: Start noVNC Web Server
        run: |
          # å¯åŠ¨websockifyï¼Œå°†WebSocketè¿æ¥ä»£ç†åˆ°VNCç«¯å£
          cd /tmp/noVNC
          ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 > /tmp/novnc.log 2>&1 &
          NOVNC_PID=$!
          echo $NOVNC_PID > /tmp/novnc.pid
          
          sleep 3
          
          # æ£€æŸ¥noVNCæ˜¯å¦å¯åŠ¨æˆåŠŸ
          if kill -0 $NOVNC_PID 2>/dev/null; then
            echo "âœ… noVNCç½‘é¡µæœåŠ¡å·²å¯åŠ¨ (ç«¯å£6080)"
          else
            echo "âŒ noVNCå¯åŠ¨å¤±è´¥"
            cat /tmp/novnc.log
            exit 1
          fi

      # 5. åˆ›å»ºCloudflareéš§é“
      - name: Create Cloudflare Tunnel
        run: |
          # ä¸ºnoVNCåˆ›å»ºéš§é“
          cloudflared tunnel --url http://localhost:6080 > /tmp/tunnel.log 2>&1 &
          TUNNEL_PID=$!
          echo $TUNNEL_PID > /tmp/tunnel.pid
          
          # ç­‰å¾…éš§é“å»ºç«‹
          sleep 15
          
          # è·å–éš§é“URL
          TUNNEL_URL=$(grep -o 'https://[a-zA-Z0-9\-]*\.trycloudflare\.com' /tmp/tunnel.log | head -n 1)
          
          echo ""
          echo "========================================="
          echo "ğŸ–¥ï¸  macOS è¿œç¨‹æ¡Œé¢å·²å°±ç»ª"
          echo "========================================="
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€:"
          echo "   $TUNNEL_URL/vnc.html"
          echo ""
          echo "ğŸ”‘ VNCå¯†ç : remote123"
          echo ""
          echo "ğŸ“‹ ä½¿ç”¨è¯´æ˜:"
          echo "   1. åœ¨Windowsæµè§ˆå™¨ä¸­æ‰“å¼€ä¸Šé¢çš„URL"
          echo "   2. ç‚¹å‡» 'Connect' è¿æ¥"
          echo "   3. è¾“å…¥å¯†ç : remote123"
          echo "   4. å³å¯çœ‹åˆ°macOSæ¡Œé¢å¹¶è¿›è¡Œæ“ä½œ"
          echo ""
          echo "âŒ¨ï¸ å¿«æ·é”®æç¤º:"
          echo "   - Windows Ctrl = macOS Command"
          echo "   - å¯ä»¥ç›´æ¥ä½¿ç”¨é¼ æ ‡ç‚¹å‡»å’Œé”®ç›˜è¾“å…¥"
          echo ""
          echo "========================================="
          
          # ä¿å­˜URLåˆ°æ–‡ä»¶æ–¹ä¾¿åç»­æŸ¥çœ‹
          echo "$TUNNEL_URL/vnc.html" > /tmp/vnc_url.txt

      # 6. æ‰§è¡Œæ‰“åŒ…é€»è¾‘å¹¶å¯åŠ¨åº”ç”¨
      - name: Build and Launch
        run: |
          echo "ğŸš€ å®‰è£…ä¾èµ–å¹¶ä¿®å¤ç¼–ç ..."
          sed -i '' 's/chcp 65001 && //g' package.json || true
          npm install          
          
          echo "ğŸ“¦ æ‰“åŒ…ä¸­..."
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          ./node_modules/.bin/electron-builder --mac --x64 --dir

          echo "ğŸ“‚ å¯åŠ¨åº”ç”¨..."
          APP_PATH=$(find dist/mac -name "*.app" -maxdepth 2 | head -n 1)
          if [ -n "$APP_PATH" ]; then
            open "$APP_PATH"
            echo "âœ… åº”ç”¨å·²å¯åŠ¨: $APP_PATH"
          else
            echo "âŒ æœªæ‰¾åˆ° .app æ–‡ä»¶"
            ls -R dist/
            exit 1
          fi
          
          # å†æ¬¡æ˜¾ç¤ºVNC URL
          echo ""
          echo "========================================="
          echo "ğŸ–¥ï¸ VNCè¿œç¨‹æ¡Œé¢åœ°å€:"
          cat /tmp/vnc_url.txt 2>/dev/null || echo "æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—è·å–URL"
          echo "========================================="

      # 7. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: |
          echo "ä¿æŒè¿è¡Œ6å°æ—¶..."
          echo "VNCåœ°å€: $(cat /tmp/vnc_url.txt 2>/dev/null)"
          
          # æ¯5åˆ†é’Ÿè¾“å‡ºä¸€æ¬¡çŠ¶æ€
          for i in $(seq 1 72); do
            sleep 300
            echo "[$i/72] å·²è¿è¡Œ $((i*5)) åˆ†é’Ÿ - VNC: $(cat /tmp/vnc_url.txt 2>/dev/null)"
            
            # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜æ´»ç€
            if ! kill -0 $(cat /tmp/tunnel.pid 2>/dev/null) 2>/dev/null; then
              echo "âš ï¸ éš§é“è¿›ç¨‹å·²é€€å‡ºï¼Œé‡æ–°å¯åŠ¨..."
              cloudflared tunnel --url http://localhost:6080 > /tmp/tunnel.log 2>&1 &
              echo $! > /tmp/tunnel.pid
              sleep 10
              grep -o 'https://.*\.trycloudflare.com' /tmp/tunnel.log | head -n 1 > /tmp/vnc_url_new.txt
              echo "æ–°VNCåœ°å€: $(cat /tmp/vnc_url_new.txt)/vnc.html"
            fi
          done
