name: Build-Run-Fix
on: workflow_dispatch

jobs:
  test-release:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          repository: Jiaye-apple/wf--my-electron-app

      # 1. å®‰è£…é¥æ§å·¥å…·
      - name: Install Tools
        run: |
          brew install cliclick
          brew install cloudflared
          pip3 install flask --break-system-packages

      # 2. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 3. ä¿®å¤ Windows å‘½ä»¤
      - name: Fix package.json
        run: |
          if [ -f "package.json" ]; then
            sed -i '' 's/chcp 65001 && //g' package.json
          fi

      # 4. å¯åŠ¨ç½‘é¡µé¥æ§å™¨
      - name: Start Remote Controller
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request
          import subprocess
          
          app = Flask(__name__)
          
          @app.route('/')
          def index():
              return '''
              <html>
              <head>
                  <title>Mac è°ƒè¯•é¥æ§å™¨</title>
                  <meta charset="utf-8">
                  <style>
                      body { background: #222; text-align: center; color: white; margin: 0; font-family: sans-serif; }
                      #screen { cursor: crosshair; border: 2px solid cyan; max-width: 95%; margin-top: 10px;}
                      .controls { padding: 10px; background: #333; }
                      button { padding: 8px 15px; background: #444; color: white; border: 1px solid #777; cursor: pointer; border-radius: 4px; }
                  </style>
              </head>
              <body>
                  <div class="controls">
                      <button onclick="setMode('click')">ğŸ–±ï¸ ç‚¹å‡»</button>
                      <button onclick="setMode('type')">âŒ¨ï¸ è¾“å…¥æ–‡å­—</button>
                      <span id="status" style="margin-left:10px; color:#0f0;">ğŸŸ¢ å®æ—¶ç›‘æ§ä¸­</span>
                  </div>
                  <img id="screen" src="/shot" onclick="handleClick(event)">
                  
                  <script>
                      const img = document.getElementById('screen');
                      setInterval(() => { img.src = '/shot?t=' + new Date().getTime(); }, 1500);
                      
                      function handleClick(event) {
                          const rect = img.getBoundingClientRect();
                          const x = Math.round((event.clientX - rect.left) * (img.naturalWidth / rect.width));
                          const y = Math.round((event.clientY - rect.top) * (img.naturalHeight / rect.height));
                          fetch(`/click?x=${x}&y=${y}`);
                      }
                      
                      window.setMode = (m) => {
                          if(m === 'type') {
                              let t = prompt("è¾“å…¥æ–‡å­—:");
                              if(t) fetch('/type?text=' + encodeURIComponent(t));
                          }
                      }
                  </script>
              </body>
              </html>
              '''
          
          @app.route('/shot')
          def shot():
              subprocess.run(['screencapture', '-x', '-C', 'screen.png'])
              return send_file('screen.png')
          
          @app.route('/click')
          def click():
              x = request.args.get('x')
              y = request.args.get('y')
              subprocess.run(['cliclick', f'c:{x},{y}'])
              return "ok"

          @app.route('/type')
          def type_text():
              text = request.args.get('text')
              subprocess.run(['cliclick', f't:{text}'])
              return "ok"
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          python3 remote_server.py &

      # 5. å¯åŠ¨ Cloudflare (ç”Ÿæˆé“¾æ¥)
      - name: Start Tunnel
        run: |
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 10
          echo "========================================================"
          echo "ğŸ® é¥æ§é“¾æ¥ï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================================"

      # 6. ã€æ ¸å¿ƒä¿®å¤ã€‘æ„å»ºå¹¶è¿è¡Œ
      - name: Build and Run
        run: |
          echo "ğŸš€ å®‰è£…ä¾èµ–..."
          npm install
          npm install --save-dev electron-builder
          
          echo "ğŸ“¦ æ­£åœ¨æ„å»º (ç”Ÿæˆå¯è¿è¡Œçš„ .app)..."
          # ğŸ”´ å…³é”®ä¿®æ”¹1ï¼šä½¿ç”¨ --dir å‚æ•°ï¼Œå¼ºåˆ¶ç”Ÿæˆè§£å‹åçš„æ–‡ä»¶å¤¹ï¼Œè€Œä¸æ˜¯ zip
          ./node_modules/.bin/electron-builder --mac --x64 --dir
          
          echo "ğŸ“‚ æŸ¥çœ‹æ„å»ºç»“æœï¼š"
          ls -R dist/mac/
          
          echo "ğŸš€ æ­£åœ¨å¯åŠ¨åº”ç”¨..."
          # æ‰¾åˆ° .app æ–‡ä»¶
          APP_PATH=$(find dist/mac -name "*.app" | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ è¿˜æ˜¯æ²¡æ‰¾åˆ° .app æ–‡ä»¶ï¼"
            exit 1
          else
            echo "âœ… æ‰¾åˆ°åº”ç”¨: $APP_PATH"
            # ğŸ”´ å…³é”®ä¿®æ”¹2ï¼šå»æ‰ -aï¼Œç›´æ¥ open æ–‡ä»¶è·¯å¾„
            open "$APP_PATH"
          fi

      # 7. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: sleep 21600
