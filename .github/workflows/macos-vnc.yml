name: RealVNC-BlackScreen-Fix
on: workflow_dispatch

jobs:
  debug-job:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. 创建管理员账户 (你已经验证过这个能登录)
      - name: Create Admin User
        run: |
          sudo sysadminctl -addUser adminuser -fullName "Admin User" -password "123456" -admin

      # 2.【关键修复A】给系统灌咖啡 (模拟用户活跃，防止休眠)
      - name: Keep Awake (Caffeinate)
        run: |
          # -u 表示模拟用户活动，-t 指定秒数 (6小时)
          # & 让它在后台一直跑
          caffeinate -u -t 21600 &
          echo "✅ 已启动防休眠进程"

      # 3. 启动 VNC 并授权
      - name: Start VNC Server
        run: |
          # 激活服务
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # 授权 adminuser
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -users adminuser -access -on -privs -all
          
          echo "✅ VNC 已启动"

      # 4.【关键修复B】强制切换 GUI 到 adminuser (抢占前台)
      - name: Switch to Admin User GUI
        run: |
          echo "正在尝试切换画面..."
          # 获取 adminuser 的用户 ID
          ADMIN_UID=$(id -u adminuser)
          
          # 强制系统把显示器画面切给 adminuser
          # 就算没有显示器，这也能通知 WindowServer 渲染该用户的桌面
          sudo "/System/Library/CoreServices/Menu Extras/User.menu/Contents/Resources/CGSession" -switchToUserID $ADMIN_UID || echo "⚠️ 切换命令可能在新系统上受限，但已尝试"
          
          echo "✅ 画面切换指令已发送"

      # 5. 启动 Ngrok
      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          brew install ngrok/ngrok/ngrok
          ngrok tcp 5900 --log=stdout > ngrok.log &
          sleep 10
          grep -o "tcp://.*:[0-9]*" ngrok.log

      - name: Keep Alive
        run: sleep 21600
