name: Debug-And-Build-Mac
on: workflow_dispatch

jobs:
  interactive-debug:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          repository: Jiaye-apple/wf--my-electron-app

      # 2. æ–°å»ºç®¡ç†å‘˜ (ç»•è¿‡æƒé™é”)
      - name: Create Admin User
        run: |
          sudo sysadminctl -addUser adminuser -fullName "Admin User" -password "123456" -admin

      # 3. ç¦æ­¢ä¼‘çœ  (é˜²æ­¢é»‘å±)
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime 0

      # 4. å¯åŠ¨ VNC æœåŠ¡ (å…è®¸ adminuser)
      - name: Start VNC
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -users adminuser -access -on -privs -all

      # 5. å¯åŠ¨ Ngrok (è®©ä½ èƒ½è¿è¿›å»)
      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          brew install ngrok/ngrok/ngrok
          ngrok tcp 5900 --log=stdout > ngrok.log &
          sleep 10
          echo "========================================================"
          echo "ğŸš€ RealVNC è¿æ¥åœ°å€ï¼š"
          grep -o "tcp://.*:[0-9]*" ngrok.log
          echo "ğŸ‘¤ ç”¨æˆ·å: adminuser"
          echo "ğŸ”‘ å¯†  ç : 123456"
          echo "========================================================"

      # 6. ã€å…³é”®ã€‘ä¿®å¤ Windows å‘½ä»¤å¹¶å‡†å¤‡ç¯å¢ƒ
      # æˆ‘ä»¬ä¸åœ¨è„šæœ¬é‡Œç›´æ¥å¯åŠ¨ Electronï¼Œè€Œæ˜¯æŠŠç¯å¢ƒä¿®å¥½ï¼Œç­‰ä½ è¿è¿›å»è‡ªå·±ç‚¹
      - name: Fix package.json for Mac
        run: |
          # åˆ æ‰ package.json é‡Œå¯¼è‡´æŠ¥é”™çš„ "chcp 65001"
          sed -i '' 's/chcp 65001 && //g' package.json
          
          # å®‰è£…ä¾èµ–
          npm install
          
          # å®‰è£…æ‰“åŒ…å·¥å…· (electron-builder)
          npm install --save-dev electron-builder

      # 7. ä¿æŒè¿è¡Œ (ç­‰ä½ è¿è¿›æ¥æ“ä½œ)
      - name: Keep Alive
        run: sleep 21600
