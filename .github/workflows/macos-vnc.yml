name: macOS-Remote-Desktop-Final-Fix
on: workflow_dispatch

jobs:
  desktop:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime 0
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 2. æˆäºˆå±å¹•å½•åˆ¶æƒé™ï¼ˆå…³é”®ä¿®å¤ï¼‰
      - name: Grant Screen Recording Permission
        run: |
          echo "æ­£åœ¨æˆäºˆå±å¹•å½•åˆ¶æƒé™..."
          
          # æ·»åŠ  ARDAgent åˆ°å±å¹•å½•åˆ¶ç™½åå•
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "INSERT or REPLACE INTO access VALUES('kTCCServiceScreenCapture','com.apple.RemoteDesktop',0,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,1687825253);" 2>/dev/null || true
          
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "INSERT or REPLACE INTO access VALUES('kTCCServicePostEvent','com.apple.RemoteDesktop',0,2,4,1,NULL,NULL,0,'UNUSED',NULL,0,1687825253);" 2>/dev/null || true
          
          # é‡å¯ TCC æœåŠ¡
          sudo killall -9 tccd 2>/dev/null || true
          sleep 2
          
          echo "âœ… æƒé™æˆäºˆå®Œæˆ"

      # 3. å¯åŠ¨å±å¹•å…±äº«ï¼ˆä½¿ç”¨ç³»ç»ŸæœåŠ¡ï¼‰
      - name: Enable Screen Sharing
        run: |
          VNC_PASSWORD="jerrylin03@"
          echo "ä½¿ç”¨å¯†ç : $VNC_PASSWORD"
          
          # æ–¹æ³•1: å¯ç”¨ç³»ç»Ÿå±å¹•å…±äº«
          sudo launchctl enable system/com.apple.screensharing
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # æ–¹æ³•2: ä½¿ç”¨ kickstart
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -users runner -privs -all -restart -agent -menu
          
          # è®¾ç½® VNC å¯†ç ï¼ˆä½¿ç”¨æ–‡ä»¶æ–¹å¼ï¼‰
          sudo mkdir -p /Library/Preferences/com.apple.VNCSettings
          echo -n "$VNC_PASSWORD" | sudo tee /Library/Preferences/com.apple.VNCSettings/.VNCpasswd > /dev/null
          
          # é€šè¿‡ kickstart è®¾ç½®å¯†ç 
          printf "%s" "$VNC_PASSWORD" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw - 2>/dev/null || true
          
          # è®¾ç½®æ— éœ€å¯†ç ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -allowAccessFor -allUsers -privs -all
          
          sleep 5
          
          echo "VNC_PASSWORD=$VNC_PASSWORD" >> $GITHUB_ENV
          echo "âœ… å±å¹•å…±äº«å·²å¯åŠ¨"

      # 4. éªŒè¯å¹¶æ˜¾ç¤º VNC çŠ¶æ€
      - name: Verify VNC Service
        run: |
          echo "æ£€æŸ¥ VNC æœåŠ¡çŠ¶æ€..."
          
          # æ£€æŸ¥ç«¯å£
          if sudo lsof -i :5900 | grep -q LISTEN; then
            echo "âœ… VNC ç«¯å£ 5900 æ­£åœ¨ç›‘å¬"
            sudo lsof -i :5900
          else
            echo "âš ï¸  VNC ç«¯å£æœªç›‘å¬ï¼Œå°è¯•æ‰‹åŠ¨å¯åŠ¨..."
            sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent -console
            sleep 3
          fi
          
          # æ£€æŸ¥è¿›ç¨‹
          echo ""
          echo "VNC ç›¸å…³è¿›ç¨‹:"
          ps aux | grep -i "ARDAgent\|screensharing" | grep -v grep
          
          # æ˜¾ç¤º TCC æƒé™
          echo ""
          echo "å±å¹•å½•åˆ¶æƒé™çŠ¶æ€:"
          sudo sqlite3 /Library/Application\ Support/com.apple.TCC/TCC.db "SELECT * FROM access WHERE service='kTCCServiceScreenCapture';" 2>/dev/null || echo "æ— æ³•è¯»å–æƒé™æ•°æ®åº“"

      # 5. ä½¿ç”¨ x11vnc ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼ˆæ›´å¯é ï¼‰
      - name: Install and Start x11vnc
        run: |
          echo "å®‰è£… x11vncï¼ˆå¤‡ç”¨ VNC æœåŠ¡å™¨ï¼‰..."
          brew install x11vnc
          
          # å¯åŠ¨ x11vncï¼ˆæ— å¯†ç æ¨¡å¼æ›´ç¨³å®šï¼‰
          nohup x11vnc -display :0 -forever -shared -nopw -xkb -repeat -capslock > x11vnc.log 2>&1 &
          
          sleep 5
          
          if pgrep x11vnc > /dev/null; then
            echo "âœ… x11vnc å·²å¯åŠ¨"
            cat x11vnc.log | head -n 20
          else
            echo "âš ï¸  x11vnc å¯åŠ¨å¤±è´¥ï¼Œä½¿ç”¨ç³»ç»Ÿ VNC"
          fi

      # 6. å®‰è£…å¹¶å¯åŠ¨ noVNC
      - name: Setup and Start noVNC
        run: |
          echo "å®‰è£… noVNC..."
          git clone --depth 1 https://github.com/novnc/noVNC.git
          git clone --depth 1 https://github.com/novnc/websockify.git noVNC/utils/websockify
          python3 -m pip install numpy --break-system-packages 2>/dev/null || pip3 install numpy
          
          echo "å¯åŠ¨ noVNC..."
          cd noVNC
          nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 --web . > ../novnc.log 2>&1 &
          
          sleep 5
          
          if lsof -i :6080 > /dev/null 2>&1; then
            echo "âœ… noVNC å·²å¯åŠ¨"
          else
            echo "âŒ noVNC å¯åŠ¨å¤±è´¥"
            cat ../novnc.log
            exit 1
          fi

      # 7. å¯åŠ¨ Cloudflare Tunnel
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          sleep 20
          
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "âŒ è·å–éš§é“åœ°å€å¤±è´¥"
            exit 1
          fi
          
          echo "=========================================================="
          echo "ğŸŒ è¿œç¨‹æ¡Œé¢è®¿é—®åœ°å€ï¼š"
          echo "=========================================================="
          echo ""
          echo "   $TUNNEL_URL/vnc.html"
          echo ""
          echo "=========================================================="
          echo "ğŸ”‘ è¿æ¥æ–¹å¼ï¼š"
          echo "   1. æ‰“å¼€ä¸Šé¢çš„é“¾æ¥"
          echo "   2. ç‚¹å‡» 'Connect' æŒ‰é’®"
          echo "   3. å¯†ç : jerrylin03@"
          echo "   4. å¦‚æœå¯†ç ä¸å¯¹ï¼Œç•™ç©ºç›´æ¥è¿æ¥ï¼ˆæ— å¯†ç æ¨¡å¼ï¼‰"
          echo "=========================================================="
          echo ""
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV

      # 8. åˆ›å»ºè‡ªåŠ¨è·³è½¬é¡µé¢
      - name: Create Auto-Redirect Page
        run: |
          cat > index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="refresh" content="0; url=./vnc.html">
    <title>æ­£åœ¨è·³è½¬...</title>
</head>
<body>
    <h2>æ­£åœ¨è·³è½¬åˆ°è¿œç¨‹æ¡Œé¢...</h2>
    <p>å¦‚æœæ²¡æœ‰è‡ªåŠ¨è·³è½¬ï¼Œè¯·<a href="./vnc.html">ç‚¹å‡»è¿™é‡Œ</a></p>
</body>
</html>
EOF
          
          cp index.html noVNC/
          echo "âœ… å·²åˆ›å»ºè‡ªåŠ¨è·³è½¬é¡µé¢"

      # 9. ä¿æŒè¿è¡Œå¹¶ç›‘æ§
      - name: Keep Alive
        run: |
          echo "âœ… æœåŠ¡è¿è¡Œä¸­..."
          echo "ğŸ”— è®¿é—®é“¾æ¥: $TUNNEL_URL"
          echo "ğŸ”— ç›´æ¥è¿æ¥: $TUNNEL_URL/vnc.html"
          echo ""
          echo "ğŸ’¡ å¦‚æœè¿æ¥å¤±è´¥ï¼Œå°è¯•ä»¥ä¸‹æ“ä½œï¼š"
          echo "   1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜"
          echo "   2. ä½¿ç”¨æ— ç—•æ¨¡å¼æ‰“å¼€"
          echo "   3. å¯†ç è¾“å…¥: jerrylin03@"
          echo "   4. æˆ–è€…ç•™ç©ºå¯†ç ç›´æ¥è¿æ¥"
          
          # æŒç»­ç›‘æ§
          for i in {1..360}; do
            sleep 60
            
            if [ $((i % 10)) -eq 0 ]; then
              echo "âœ… [$i/360] è¿è¡Œæ­£å¸¸"
              
              # æ£€æŸ¥æœåŠ¡çŠ¶æ€
              if ! pgrep -f novnc_proxy > /dev/null; then
                echo "âš ï¸  é‡å¯ noVNC..."
                cd noVNC && nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 --web . > ../novnc.log 2>&1 &
              fi
              
              if ! pgrep cloudflared > /dev/null; then
                echo "âš ï¸  é‡å¯ Cloudflare..."
                nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
                sleep 10
                grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
              fi
            fi
          done
