name: Build-Run-Remote-Pro
on: workflow_dispatch

jobs:
  test-release:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # é»˜è®¤æ‹‰å–å½“å‰ä»“åº“ï¼Œå¦‚æœæ˜¯å¤–éƒ¨ä»“åº“è¯·å–æ¶ˆä¸‹é¢ä¸€è¡Œçš„æ³¨é‡Š
          # repository: Jiaye-apple/wf--my-electron-app

      # 1. ç¯å¢ƒåˆå§‹åŒ– (å¢åŠ  Node.js ç¯å¢ƒç¡®ä¿æ„å»ºç¨³å®š)
      - name: Setup Node and Python
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install System Tools
        run: |
          brew install cliclick cloudflared
          python3 -m pip install flask --break-system-packages

      # 2. ç¦æ­¢ä¼‘çœ  (ç¡®ä¿é•¿å»¶æ—¶ä»»åŠ¡ä¸æ‰çº¿)
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never || true
          sudo systemsetup -setdisplaysleep Never || true

      # 3. ã€æå‰å¯åŠ¨ã€‘é¥æ§æœåŠ¡å™¨ (è®©ä½ èƒ½çœ‹åˆ°å®‰è£…å’Œæ‰“åŒ…çš„è¿‡ç¨‹)
      - name: Start Remote Server & Tunnel
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request
          import subprocess
          import urllib.parse
          app = Flask(__name__)
          @app.route('/')
          def index():
              return '''
              <html>
              <head><title>Mac è‡ªåŠ¨å®‰è£…ç›‘æ§</title><meta charset="utf-8">
              <style>body{background:#222;color:white;text-align:center;}#screen{max-width:90%;border:3px solid #555;}</style></head>
              <body>
                  <h2>æ­£åœ¨è‡ªåŠ¨æ‰“åŒ…ä¸å®‰è£…é¡¹ç›®...</h2>
                  <div id="status" style="color:#0f0">ğŸŸ¢ ç³»ç»Ÿå·²ä¸Šçº¿</div>
                  <img id="screen" src="/shot" onclick="handleClick(event)">
                  <script>
                      const img = document.getElementById('screen');
                      setInterval(() => { img.src = '/shot?t=' + new Date().getTime(); }, 1500);
                      function handleClick(event) {
                          const rect = img.getBoundingClientRect();
                          const x = Math.round((event.clientX - rect.left) * (img.naturalWidth / rect.width));
                          const y = Math.round((event.clientY - rect.top) * (img.naturalHeight / rect.height));
                          fetch(`/action?mode=click&x=${x}&y=${y}`);
                      }
                  </script>
              </body></html>
              '''
          @app.route('/shot')
          def shot():
              subprocess.run(['screencapture', '-x', '-C', 'screen.png'])
              return send_file('screen.png')
          @app.route('/action')
          def action():
              x, y = request.args.get('x'), request.args.get('y')
              subprocess.run(['cliclick', f'c:{x},{y}'])
              return "ok"
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          python3 remote_server.py &
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 5
          echo "========================================================"
          echo "ğŸ® å®æ—¶ç›‘æ§ä¸é¥æ§é“¾æ¥ï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================================"

      # 4. ã€æ ¸å¿ƒæ­¥éª¤ã€‘å…¨è‡ªåŠ¨å®‰è£…ä¸æ‰“åŒ…
      - name: Auto Install and Build
        run: |
          echo "ğŸš€ å¼€å§‹ä¿®å¤ package.json..."
          if [ -f "package.json" ]; then
            sed -i '' 's/chcp 65001 && //g' package.json
          fi

          echo "ğŸ“¦ æ­£åœ¨å®‰è£…ä¾èµ–åº“ (npm install)..."
          npm install
          
          echo "ğŸ”¨ æ­£åœ¨æ‰“åŒ…é¡¹ç›® (electron-builder)..."
          # å…³é”®ï¼šè®¾ç½® CSC_IDENTITY_AUTO_DISCOVERY=false è·³è¿‡ macOS è¯ä¹¦æŠ¥é”™
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          ./node_modules/.bin/electron-builder --mac --x64 --dir

      # 5. ã€è‡ªåŠ¨è¿è¡Œã€‘å¯åŠ¨å®‰è£…å¥½çš„åº”ç”¨
      - name: Launch Application
        run: |
          echo "ğŸ“‚ å¯»æ‰¾ç”Ÿæˆçš„ .app æ–‡ä»¶..."
          APP_PATH=$(find dist/mac -name "*.app" -maxdepth 2 | head -n 1)
          
          if [ -n "$APP_PATH" ]; then
            echo "âœ… æ‰¾åˆ°åº”ç”¨å¹¶å¯åŠ¨: $APP_PATH"
            open "$APP_PATH"
          else
            echo "âŒ æœªæ‰¾åˆ°æ„å»ºå¥½çš„åº”ç”¨ï¼Œè¯·æ£€æŸ¥ dist/mac ç›®å½•"
            ls -R dist/
            exit 1
          fi

      # 6. ä¿æŒç¯å¢ƒè¿è¡Œ (6å°æ—¶)
      - name: Keep Alive
        run: sleep 21600
