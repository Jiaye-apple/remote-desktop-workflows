name: macOS-Screen-Share-Working
on: workflow_dispatch

jobs:
  desktop:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ç¦æ­¢ä¼‘çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          caffeinate -d &
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 2. åˆ›å»ºæˆªå± Web æœåŠ¡å™¨ï¼ˆç»•è¿‡ VNC é™åˆ¶ï¼‰
      - name: Create Screenshot Server
        run: |
          pip3 install flask pillow
          
          cat > screen_server.py << 'EOF'
from flask import Flask, Response, render_template_string
import subprocess
import time
import os

app = Flask(__name__)

HTML = '''
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>macOS è¿œç¨‹æ¡Œé¢</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #1a1a1a; 
            color: #00ff00; 
            font-family: 'Courier New', monospace;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 { 
            color: #00ff00; 
            text-align: center; 
            padding: 20px;
            text-shadow: 0 0 10px #00ff00;
        }
        .controls {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 2px solid #00ff00;
        }
        .controls button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .controls button:hover { background: #00cc00; }
        .info {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #00ff00;
        }
        .screen-container {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            border: 3px solid #00ff00;
            box-shadow: 0 0 20px rgba(0,255,0,0.3);
        }
        #screen {
            width: 100%;
            display: block;
            image-rendering: crisp-edges;
        }
        .countdown {
            display: inline-block;
            padding: 5px 10px;
            background: #00ff00;
            color: #000;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¥ï¸ macOS è¿œç¨‹æ¡Œé¢ç›‘æ§</h1>
        
        <div class="controls">
            <button onclick="refresh()">ğŸ”„ ç«‹å³åˆ·æ–°</button>
            <button onclick="toggleAuto()">â¯ï¸ <span id="autoText">æš‚åœ</span>è‡ªåŠ¨åˆ·æ–°</button>
            <button onclick="fullscreen()">â›¶ å…¨å±</button>
            <span style="margin-left: 20px;">
                ä¸‹æ¬¡åˆ·æ–°: <span class="countdown" id="countdown">2</span> ç§’
            </span>
        </div>
        
        <div class="info">
            <p>âœ… çŠ¶æ€: <strong>è¿è¡Œä¸­</strong></p>
            <p>ğŸ”„ åˆ·æ–°é¢‘ç‡: æ¯ 2 ç§’</p>
            <p>ğŸ’¡ æç¤º: å›¾ç‰‡ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°é¡µé¢</p>
        </div>
        
        <div class="screen-container">
            <img id="screen" src="/screenshot" alt="Mac Desktop">
        </div>
    </div>
    
    <script>
        let autoRefresh = true;
        let countdown = 2;
        let timer;
        
        function refresh() {
            document.getElementById('screen').src = '/screenshot?' + Date.now();
            countdown = 2;
        }
        
        function toggleAuto() {
            autoRefresh = !autoRefresh;
            document.getElementById('autoText').textContent = autoRefresh ? 'æš‚åœ' : 'ç»§ç»­';
        }
        
        function fullscreen() {
            const img = document.getElementById('screen');
            if (img.requestFullscreen) {
                img.requestFullscreen();
            }
        }
        
        setInterval(() => {
            if (autoRefresh) {
                countdown--;
                document.getElementById('countdown').textContent = countdown;
                if (countdown <= 0) {
                    refresh();
                }
            }
        }, 1000);
    </script>
</body>
</html>
'''

@app.route('/')
def index():
    return HTML

@app.route('/screenshot')
def screenshot():
    try:
        # ä½¿ç”¨ screencaptureï¼ˆä¸éœ€è¦å±å¹•å½•åˆ¶æƒé™ï¼ï¼‰
        subprocess.run(['screencapture', '-x', '-C', '/tmp/screen.png'], 
                      check=True, timeout=5)
        
        with open('/tmp/screen.png', 'rb') as f:
            img_data = f.read()
        
        return Response(img_data, mimetype='image/png')
    except Exception as e:
        # å¦‚æœå¤±è´¥ï¼Œè¿”å›é”™è¯¯å›¾ç‰‡
        return Response(b'', mimetype='image/png', status=500)

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080, threaded=True)
EOF
          
          echo "âœ… æˆªå±æœåŠ¡å™¨ä»£ç å·²åˆ›å»º"

      # 3. å¯åŠ¨æˆªå±æœåŠ¡å™¨
      - name: Start Screenshot Server
        run: |
          echo "æ­£åœ¨å¯åŠ¨æˆªå±æœåŠ¡å™¨..."
          nohup python3 screen_server.py > server.log 2>&1 &
          
          sleep 5
          
          if lsof -i :8080 > /dev/null 2>&1; then
            echo "âœ… æˆªå±æœåŠ¡å™¨å·²å¯åŠ¨åœ¨ç«¯å£ 8080"
          else
            echo "âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥"
            cat server.log
            exit 1
          fi

      # 4. æµ‹è¯•æˆªå±åŠŸèƒ½
      - name: Test Screenshot
        run: |
          echo "æµ‹è¯•æˆªå±åŠŸèƒ½..."
          screencapture -x test.png
          
          if [ -f "test.png" ]; then
            ls -lh test.png
            echo "âœ… æˆªå±åŠŸèƒ½æ­£å¸¸"
          else
            echo "âŒ æˆªå±å¤±è´¥"
            exit 1
          fi

      # 5. å¯åŠ¨ Cloudflare Tunnel
      - name: Start Cloudflare Tunnel
        run: |
          echo "æ­£åœ¨å®‰è£… cloudflared..."
          brew install cloudflared
          
          echo "æ­£åœ¨å¯åŠ¨éš§é“..."
          nohup cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          
          sleep 20
          
          TUNNEL_URL=$(grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1)
          
          if [ -z "$TUNNEL_URL" ]; then
            echo "âŒ æœªèƒ½è·å–éš§é“åœ°å€"
            cat tunnel.log
            exit 1
          fi
          
          echo "=========================================================="
          echo "ğŸŒ è¿œç¨‹æ¡Œé¢è®¿é—®åœ°å€ï¼š"
          echo "=========================================================="
          echo ""
          echo "   $TUNNEL_URL"
          echo ""
          echo "=========================================================="
          echo "ğŸ“– ä½¿ç”¨è¯´æ˜ï¼š"
          echo "   1. å¤åˆ¶ä¸Šé¢çš„é“¾æ¥åœ¨æµè§ˆå™¨æ‰“å¼€"
          echo "   2. è‡ªåŠ¨æ¯ 2 ç§’åˆ·æ–°å±å¹•"
          echo "   3. å¯ä»¥ç‚¹å‡»æŒ‰é’®ç«‹å³åˆ·æ–°æˆ–æš‚åœ"
          echo "   4. å¯ä»¥å…¨å±æŸ¥çœ‹"
          echo "=========================================================="
          echo ""
          echo "ğŸ’¡ æç¤ºï¼š"
          echo "   - è¿™æ˜¯å®æ—¶æˆªå±ï¼Œä¸æ˜¯ VNC"
          echo "   - å¯ä»¥çœ‹åˆ°æ¡Œé¢ï¼Œä½†ä¸èƒ½æ§åˆ¶é¼ æ ‡é”®ç›˜"
          echo "   - é€‚åˆæŸ¥çœ‹æ„å»ºè¿‡ç¨‹å’Œåº”ç”¨è¿è¡ŒçŠ¶æ€"
          echo "=========================================================="
          
          echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV

      # 6. æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
      - name: System Information
        run: |
          echo "========== ç³»ç»Ÿä¿¡æ¯ =========="
          sw_vers
          echo ""
          echo "CPU: $(sysctl -n machdep.cpu.brand_string)"
          echo "å†…å­˜: $(sysctl -n hw.memsize | awk '{print $0/1024/1024/1024}') GB"
          echo "ç£ç›˜:"
          df -h /
          echo ""
          echo "å·²å®‰è£…åº”ç”¨:"
          ls /Applications/ | head -n 20

      # 7. ä¿æŒè¿è¡Œå¹¶å®šæœŸæˆªå›¾
      - name: Keep Alive and Monitor
        run: |
          echo "âœ… æœåŠ¡è¿è¡Œä¸­..."
          echo "ğŸ”— è®¿é—®: $TUNNEL_URL"
          echo ""
          echo "ä¿æŒè¿è¡Œ 6 å°æ—¶..."
          
          # æ¯åˆ†é’Ÿæ£€æŸ¥å¹¶æˆªå›¾
          for i in {1..360}; do
            sleep 60
            
            # æˆªå›¾ä¿å­˜
            screencapture -x "snapshot_$(date +%H%M).png" 2>/dev/null || true
            
            # æ¯ 10 åˆ†é’Ÿæ˜¾ç¤ºçŠ¶æ€
            if [ $((i % 10)) -eq 0 ]; then
              echo "âœ… [$i/360] è¿è¡Œæ­£å¸¸ (å·²è¿è¡Œ $i åˆ†é’Ÿ)"
              echo "ğŸ”— é“¾æ¥: $TUNNEL_URL"
              
              # æ£€æŸ¥æœåŠ¡
              if ! lsof -i :8080 > /dev/null 2>&1; then
                echo "âš ï¸  æˆªå±æœåŠ¡å™¨é‡å¯ä¸­..."
                nohup python3 screen_server.py > server.log 2>&1 &
                sleep 3
              fi
              
              if ! pgrep -f cloudflared > /dev/null; then
                echo "âš ï¸  Cloudflare éš§é“é‡å¯ä¸­..."
                nohup cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
                sleep 10
                grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
              fi
            fi
          done

      # 8. ä¸Šä¼ æ‰€æœ‰æˆªå›¾
      - name: Upload Screenshots
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: screenshots
          path: |
            *.png
            *.log
