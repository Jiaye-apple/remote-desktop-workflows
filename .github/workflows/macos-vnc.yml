name: Build-Full-Project
on:
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install System Tools
        run: |
          brew install cliclick cloudflared
          python3 -m pip install flask --break-system-packages

      # 1. å¯åŠ¨è¿œç¨‹ç›‘æ§ï¼ˆè®©ä½ èƒ½çœ‹åˆ°æ‰“åŒ…ä¸»ä½“çš„å…¨è¿‡ç¨‹ï¼‰
      - name: Start Remote Monitor
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request
          import subprocess
          app = Flask(__name__)
          @app.route('/')
          def index():
              return '''<html><body style="background:#222;color:white;text-align:center;">
                  <h2>ä¸»ä½“è½¯ä»¶æ‰“åŒ…ç›‘æ§ä¸­...</h2>
                  <img id="screen" src="/shot" style="max-width:90%;border:3px solid #555;" onclick="handleClick(event)">
                  <script>
                      const img = document.getElementById('screen');
                      setInterval(() => { img.src = '/shot?t=' + new Date().getTime(); }, 1000);
                      function handleClick(event) {
                          const rect = img.getBoundingClientRect();
                          const x = Math.round((event.clientX - rect.left) * (img.naturalWidth / rect.width));
                          const y = Math.round((event.clientY - rect.top) * (img.naturalHeight / rect.height));
                          fetch(`/action?x=${x}&y=${y}`);
                      }
                  </script>
              </body></html>'''
          @app.route('/shot')
          def shot():
              subprocess.run(['screencapture', '-x', '-C', 'screen.png'])
              return send_file('screen.png')
          @app.route('/action')
          def action():
              x, y = request.args.get('x'), request.args.get('y')
              subprocess.run(['cliclick', f'c:{x},{y}'])
              return "ok"
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          python3 remote_server.py &
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 10
          echo "========================================="
          echo "ğŸ® è¿œç¨‹ç”»é¢ç›‘æ§é“¾æ¥ï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================="

      # 2. æ‰“åŒ…ä¸»ä½“è½¯ä»¶ (Root Directory)
      - name: Build Main Application
        run: |
          echo "ğŸš€ æ­£åœ¨å®‰è£…ä¸»ä½“è½¯ä»¶ä¾èµ–..."
          npm install
          
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…ä¸»ä½“è½¯ä»¶..."
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          # ä¿®å¤ Windows å¯èƒ½é—ç•™çš„ç¼–ç å‘½ä»¤
          sed -i '' 's/chcp 65001 && //g' package.json || true
          ./node_modules/.bin/electron-builder --mac --x64 --dir

      # 3. å¤„ç†æ’ä»¶/å­é¡¹ç›® (WindsurfSwitch-main)
      - name: Prepare Plugin (WindsurfSwitch-main)
        run: |
          if [ -d "WindsurfSwitch-main" ]; then
            echo "ğŸ“‚ è¿›å…¥æ’ä»¶ç›®å½•è¿›è¡Œå¤„ç†..."
            cd WindsurfSwitch-main
            if [ -f "package.json" ]; then
               npm install
               # å¦‚æœæ’ä»¶éœ€è¦ç‹¬ç«‹ buildï¼Œå¯ä»¥åœ¨è¿™é‡ŒåŠ  npm run build
            fi
          fi

      # 4. å¯åŠ¨ä¸»ä½“ç¨‹åº
      - name: Launch Main App
        run: |
          echo "ğŸ“‚ å¯»æ‰¾ä¸»ä½“ç¨‹åºè¿è¡Œè·¯å¾„..."
          # åœ¨æ ¹ç›®å½•çš„ dist/mac ä¸‹å¯»æ‰¾ .app
          APP_PATH=$(find dist/mac -name "*.app" -maxdepth 2 | head -n 1)
          
          if [ -n "$APP_PATH" ]; then
            echo "âœ… å¯åŠ¨ä¸»ä½“è½¯ä»¶: $APP_PATH"
            open "$APP_PATH"
          else
            echo "âŒ é”™è¯¯ï¼šä¸»ä½“è½¯ä»¶æ‰“åŒ…å¤±è´¥ï¼Œæœªå‘ç° .app æ–‡ä»¶"
            ls -R dist/
            exit 1
          fi

      - name: Keep Alive
        run: sleep 21600
