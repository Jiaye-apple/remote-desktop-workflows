name: Build-Full-Project
on:
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      # 1. ç›´æ¥æ‹‰å–å…¬å¼€ä»“åº“ (å½»åº•åˆ æ‰ token è¡Œï¼Œé¿å¼€å‡­è¯æŠ¥é”™)
      - name: Checkout wftest Repository
        uses: actions/checkout@v4
        with:
          repository: Jiaye-apple/wftest
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Tools
        run: |
          brew install cliclick cloudflared
          python3 -m pip install flask --break-system-packages

      # 2. å¯åŠ¨ç›‘æ§
      - name: Start Remote Monitor
        run: |
          cat << 'EOF' > remote_server.py
          from flask import Flask, send_file, request
          import subprocess
          app = Flask(__name__)
          @app.route('/')
          def index():
              return '<html><body style="background:#222;color:white;text-align:center;"><h2>æ‰“åŒ…ç›‘æ§å·²å°±ç»ª</h2><img id="screen" src="/shot" style="max-width:95%; border:2px solid #555;"><script>setInterval(()=>{document.getElementById("screen").src="/shot?t="+new Date().getTime();},1500);</script></body></html>'
          @app.route('/shot')
          def shot():
              subprocess.run(['screencapture', '-x', '-C', 'screen.png'])
              return send_file('screen.png')
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          python3 remote_server.py &
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 5
          echo "========================================="
          echo "ğŸ® è¿œç¨‹ç›‘æ§é“¾æ¥ï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================="

      # 3. åœ¨æ ¹ç›®å½•æ‰§è¡Œå®‰è£…ä¸æ‰“åŒ…
      - name: Build and Launch
        run: |
          echo "ğŸš€ å¼€å§‹å®‰è£…ä¾èµ–..."
          # ä¿®å¤ package.json å¯èƒ½å­˜åœ¨çš„ Windows ç¼–ç é—®é¢˜
          sed -i '' 's/chcp 65001 && //g' package.json || true
          npm install
          
          echo "ğŸ“¦ æ­£åœ¨æ‰§è¡Œ Electron æ‰“åŒ…..."
          export CSC_IDENTITY_AUTO_DISCOVERY=false
          ./node_modules/.bin/electron-builder --mac --x64 --dir

          echo "ğŸ“‚ å¯åŠ¨åº”ç”¨..."
          APP_PATH=$(find dist/mac -name "*.app" -maxdepth 2 | head -n 1)
          if [ -n "$APP_PATH" ]; then
            echo "âœ… æˆåŠŸå¯åŠ¨åº”ç”¨: $APP_PATH"
            open "$APP_PATH"
          else
            echo "âŒ é”™è¯¯ï¼šæœªå‘ç°æ‰“åŒ…ç”Ÿæˆçš„ .app æ–‡ä»¶"
            ls -R dist/
            exit 1
          fi

      - name: Keep Alive
        run: sleep 21600
