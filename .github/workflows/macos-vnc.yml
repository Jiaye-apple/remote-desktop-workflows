name: Mac-Debug-Final-Fix
on: workflow_dispatch

jobs:
  debug-job:
    # ğŸ”´ å…³é”®ä¿®æ”¹ï¼šå¼ºåˆ¶ä½¿ç”¨ macOS 12 (Monterey)
    # åªæœ‰è¿™ä¸ªæ—§ç‰ˆæœ¬å…è®¸æˆ‘ä»¬ç”¨ kickstart å‘½ä»¤è®¾ç½® VNC å¯†ç 
    runs-on: macos-12
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. å¯åŠ¨ VNC (åœ¨ macOS 12 ä¸Šè¿™è¡Œå‘½ä»¤æ˜¯æœ‰æ•ˆçš„)
      - name: Start VNC
        run: |
          echo "æ­£åœ¨å¯åŠ¨ VNC æœåŠ¡..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # è®¾ç½®å¯†ç  123456 (macOS 12 å…è®¸è¿™ä¹ˆåš)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw 123456
          
          echo "âœ… VNC å¯åŠ¨æˆåŠŸ"

      # 2. å®‰è£… noVNC (è½¬ç½‘é¡µç‰ˆ)
      - name: Install noVNC
        run: |
          git clone --depth 1 https://github.com/novnc/noVNC.git
          git clone --depth 1 https://github.com/novnc/websockify noVNC/utils/websockify
          ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

      # 3. å¯åŠ¨ Cloudflare (å…è´¹é€šé“)
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "ç”Ÿæˆé“¾æ¥ä¸­..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸ‰ è°ƒè¯•é“¾æ¥ (macOS 12 ç‰ˆ) å·²ç”Ÿæˆï¼š"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "ğŸ”‘ å¯†ç : 123456"
          echo "ğŸ‘¤ ç”¨æˆ·å: (ç•™ç©º)"
          echo "========================================================"

      - name: Keep Alive
        run: sleep 21600
