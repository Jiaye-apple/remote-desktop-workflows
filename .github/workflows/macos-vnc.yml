name: Mac-Screenshot-Stream
on: workflow_dispatch

jobs:
  debug-job:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ç¦æ­¢ä¼‘çœ  (è¿™æ˜¯åŸºæœ¬åŠŸ)
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 2. æ­å»ºä¸€ä¸ªâ€œå®æ—¶æˆªå±â€ç½‘ç«™ (Python)
      # è¿™æ˜¯ä¸€ä¸ªç¥å¥‡çš„è„šæœ¬ï¼Œå®ƒæŠŠå½“å‰å±å¹•å˜æˆä¸€ä¸ªç½‘é¡µå›¾ç‰‡
      - name: Start Screenshot Server
        run: |
          # å®‰è£… Flask ç½‘é¡µæ¡†æ¶
          pip3 install flask
          
          # å†™å…¥ Python è„šæœ¬
          cat << 'EOF' > screen_server.py
          from flask import Flask, send_file
          import subprocess
          import time
          
          app = Flask(__name__)
          
          @app.route('/')
          def index():
              # HTML é¡µé¢ï¼Œå¸¦è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ (æ¯ 2 ç§’åˆ·ä¸€æ¬¡)
              return '''
              <html>
                <head><meta http-equiv="refresh" content="2"></head>
                <body style="background:#333; color:white; text-align:center;">
                  <h1>macOS å®æ—¶ç›‘æ§</h1>
                  <img src="/shot" style="max-width:100%; border:2px solid #fff;">
                  <p>é¡µé¢æ¯ 2 ç§’è‡ªåŠ¨åˆ·æ–°</p>
                </body>
              </html>
              '''
          
          @app.route('/shot')
          def shot():
              # è°ƒç”¨ç³»ç»Ÿå‘½ä»¤æˆªå± (screencapture æ˜¯ Mac è‡ªå¸¦çš„)
              # -x è¡¨ç¤ºé™éŸ³ï¼Œscreen.png æ˜¯ä¿å­˜è·¯å¾„
              subprocess.run(['screencapture', '-x', 'screen.png'])
              return send_file('screen.png')
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          
          # åå°å¯åŠ¨è¿™ä¸ªæœåŠ¡å™¨
          python3 screen_server.py &
          echo "âœ… æˆªå±æœåŠ¡å™¨å·²å¯åŠ¨ (ç«¯å£ 8080)"

      # 3. å¯åŠ¨ Cloudflare éš§é“ (æŠŠ 8080 ç«¯å£æ˜ å°„å‡ºå»)
      # è¿™æ¬¡æˆ‘ä»¬ä¸éœ€è¦ Ngrokï¼Œç”¨ Cloudflare æ›´å¿«ä¸”å…è´¹
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          
          echo "æ­£åœ¨ç”Ÿæˆé“¾æ¥..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸ‰ ç›‘æ§é“¾æ¥å·²ç”Ÿæˆï¼å¤åˆ¶ä¸‹é¢çš„é“¾æ¥åˆ°æµè§ˆå™¨æ‰“å¼€ï¼š"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "æ— éœ€å¯†ç ï¼Œç›´æ¥è®¿é—®å³å¯çœ‹åˆ°æ¡Œé¢ï¼"
          echo "========================================================"

      # 4. ä¿æŒè¿è¡Œ (è®©ä½ æœ‰æ—¶é—´å»ä¸‹è½½ä»£ç å’Œæµ‹è¯•)
      - name: Keep Alive
        run: sleep 21600
