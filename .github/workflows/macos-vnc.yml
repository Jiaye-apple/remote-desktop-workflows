name: RealVNC-Env-Var-Fix
on: workflow_dispatch

jobs:
  vnc-job:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. 防止黑屏
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "✅ 已禁止休眠"

      # 2. 启动 VNC (密码 123456)
      - name: Start VNC Server
        run: |
          # 开启权限
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # 设置 VNC 密码 (跳过系统密码)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw 123456
          
          echo "✅ VNC 启动成功，密码: 123456"

      # 3. 启动 Ngrok (变量方式)
      - name: Start Ngrok Tunnel
        env:
          # 关键修改：左边必须写 NGROK_AUTHTOKEN (没有下划线)，右边是你 GitHub 的 Secret
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          brew install ngrok/ngrok/ngrok
          
          # 直接启动，它会自动读取上面的 NGROK_AUTHTOKEN 变量
          ngrok tcp 5900 --log=stdout > ngrok.log &
          
          echo "正在连接..."
          sleep 10
          
          echo "========================================================"
          echo "🚀 连接成功！RealVNC Viewer 地址："
          echo "--------------------------------------------------------"
          grep -o "tcp://.*:[0-9]*" ngrok.log
          echo "--------------------------------------------------------"
          echo "🔑 密码: 123456"
          echo "👤 用户名: (一定要留空！！)"
          echo "========================================================"

      - name: Keep Alive
        run: sleep 21600
