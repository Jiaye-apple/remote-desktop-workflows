name: Run-From-Git
on: workflow_dispatch

jobs:
  debug-job:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      # 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç›´æ¥æ‹‰å–åˆ«äººçš„ä»“åº“
      # è¿™ä¸€æ­¥ä¼šæŠŠä½ æŒ‡å®šçš„ä»“åº“ä»£ç å…¨éƒ¨ä¸‹è½½åˆ°äº‘ç«¯ Mac ä¸Š
      - name: Checkout Target Repository
        uses: actions/checkout@v3
        with:
          repository: Jiaye-apple/wf--my-electron-app
          # å¦‚æœæ˜¯ç§æœ‰ä»“åº“ï¼Œè¿˜éœ€è¦ tokenï¼Œä½†å…¬å…±ä»“åº“ç›´æ¥å¡«åå­—å°±è¡Œ

      # 2. ç¦æ­¢ä¼‘çœ  (é˜²æ­¢é»‘å±)
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 3. å¯åŠ¨æˆªå±ç›‘æ§ (è®©ä½ èƒ½çœ‹åˆ°ç”»é¢)
      - name: Start Screenshot Server
        run: |
          # å®‰è£… Flask (å¼ºåˆ¶å¿½ç•¥ç³»ç»Ÿé™åˆ¶)
          pip3 install flask --break-system-packages
          
          # åˆ›å»ºç›‘æ§è„šæœ¬
          cat << 'EOF' > screen_server.py
          from flask import Flask, send_file
          import subprocess
          
          app = Flask(__name__)
          
          @app.route('/')
          def index():
              return '''
              <html>
                <head><meta http-equiv="refresh" content="2"></head>
                <body style="background:#222;color:#fff;text-align:center;">
                  <h1>wf--my-electron-app è¿è¡Œç›‘æ§</h1>
                  <p>ğŸ‘‡ ä½ çš„è½¯ä»¶çª—å£åº”è¯¥æ˜¾ç¤ºåœ¨ä¸‹é¢ ğŸ‘‡</p>
                  <img src="/shot" style="max-width:95%; border:2px solid #fff;">
                </body>
              </html>
              '''
          
          @app.route('/shot')
          def shot():
              # æˆªå–å±å¹•
              subprocess.run(['screencapture', '-x', 'screen.png'])
              return send_file('screen.png')
          
          if __name__ == '__main__':
              app.run(host='0.0.0.0', port=8080)
          EOF
          
          # åå°å¯åŠ¨ç›‘æ§
          python3 screen_server.py &

      # 4. å¯åŠ¨ Cloudflare (ç”Ÿæˆè§‚çœ‹é“¾æ¥)
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 10
          echo "========================================================"
          echo "ğŸ‰ è§‚çœ‹é“¾æ¥ï¼š"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "========================================================"

      # 5. ã€è‡ªåŠ¨è¿è¡Œã€‘å®‰è£…ä¾èµ–å¹¶å¯åŠ¨ Electron
      - name: Install & Run Electron
        run: |
          echo "ğŸ“‚ å½“å‰ç›®å½•æ–‡ä»¶æ£€æŸ¥ï¼š"
          ls -la
          
          echo "ğŸš€ æ­£åœ¨å®‰è£…ä¾èµ– (npm install)..."
          npm install
          
          echo "ğŸš€ æ­£åœ¨å¯åŠ¨ Electron..."
          # ä½¿ç”¨ & è®©å®ƒåœ¨åå°è¿è¡Œ
          npm start &

      # 6. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: sleep 21600
