name: Electron-Debug-Mac
on: workflow_dispatch

jobs:
  debug-job:
    runs-on: macos-latest
    timeout-minutes: 360 # ç»™è¶³6å°æ—¶è°ƒè¯•æ—¶é—´
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. å¼ºåˆ¶ç¦æ­¢ç¡çœ  (é˜²æ­¢è¿æ¥åé»‘å±)
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          echo "âœ… å·²ç¦æ­¢è‡ªåŠ¨é»‘å±"

      # 2. å¯åŠ¨ VNC æœåŠ¡ (åªè®¾ç½®è¿æ¥å¯†ç  123456)
      - name: Start VNC Server
        run: |
          # å¼€å¯æƒé™
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # è®¾ç½® VNC å¯†ç ä¸º 123456 (ç®€å•ç²—æš´)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw 123456
          
          echo "âœ… VNC å¯åŠ¨æˆåŠŸ"

      # 3. å®‰è£… noVNC (æŠŠæ¡Œé¢è½¬æˆç½‘é¡µè§†é¢‘æµï¼Œç»•è¿‡ Ngrok é™åˆ¶)
      - name: Install noVNC
        run: |
          git clone --depth 1 https://github.com/novnc/noVNC.git
          git clone --depth 1 https://github.com/novnc/websockify noVNC/utils/websockify
          
          # å¯åŠ¨è½¬æ¢å™¨ï¼šæŠŠ 5900 è½¬åˆ° 6080
          ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

      # 4. å¯åŠ¨ Cloudflare (å…è´¹é€šé“ï¼Œä¸éœ€ç»‘å¡)
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          
          # ç©¿é€ç½‘é¡µç«¯å£ 6080
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "æ­£åœ¨ç”Ÿæˆé“¾æ¥..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸ‰ è°ƒè¯•ç¯å¢ƒå°±ç»ªï¼è¯·å¤åˆ¶ä¸‹é¢çš„é“¾æ¥åˆ°æµè§ˆå™¨æ‰“å¼€ï¼š"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "ğŸ”‘ å¯†ç : 123456"
          echo "ğŸ‘¤ ç”¨æˆ·å: (ç•™ç©ºä¸å¡«)"
          echo "========================================================"

      - name: Keep Alive
        run: sleep 21600
