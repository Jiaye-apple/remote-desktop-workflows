name: Mac-Debug-Fix
on: workflow_dispatch

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. å¼€å¯ Mac VNC æœåŠ¡
      - name: Start VNC Server
        run: |
          echo "æ­£åœ¨å¼€å¯ VNC..."
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # è®¾ç½®å¯†ç 
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw secret
          echo "âœ… VNC å¯åŠ¨å®Œæ¯•"

      # 2. æ‰‹åŠ¨å®‰è£… noVNC (ä¿®å¤æŠ¥é”™çš„å…³é”®æ­¥éª¤)
      - name: Install & Start noVNC
        run: |
          # ç›´æ¥å…‹éš†å®˜æ–¹ä»“åº“ï¼Œä¸ä¾èµ– brew
          git clone https://github.com/novnc/noVNC.git
          
          # noVNC éœ€è¦ websockify æ‰èƒ½å·¥ä½œï¼Œæˆ‘ä»¬æ‰‹åŠ¨å…‹éš†è¿›å»
          git clone https://github.com/novnc/websockify noVNC/utils/websockify
          
          # å¯åŠ¨ä»£ç†ï¼šæŠŠ 5900 (VNC) è½¬æˆ 6080 (Web)
          # ä½¿ç”¨ & ç¬¦å·è®©å®ƒåœ¨åå°è¿è¡Œ
          ./noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
          
          echo "âœ… noVNC (æºç ç‰ˆ) å·²å¯åŠ¨"

      # 3. å¯åŠ¨ Cloudflare éš§é“ (æ— éœ€ Token)
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          # ç©¿é€ç½‘é¡µç«¯å£ 6080
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          echo "æ­£åœ¨ç”Ÿæˆé“¾æ¥..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸ‰ è°ƒè¯•é“¾æ¥å·²ç”Ÿæˆï¼å¤åˆ¶ä¸‹æ–¹é“¾æ¥åˆ°æµè§ˆå™¨ï¼š"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "ğŸ”‘ å¯†ç : secret"
          echo "========================================================"

      # 4. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: sleep 21600
