name: RealVNC-NoSystemPass
on: workflow_dispatch

jobs:
  vnc-job:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ç¦æ­¢ç¡çœ å’Œå±ä¿ (è¿™æ˜¯é˜²æ­¢é»‘å±çš„å…³é”®ï¼Œå¿…é¡»æ”¾åœ¨æœ€å‰é¢)
      - name: Disable Sleep & Screensaver
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime 0
          echo "âœ… å·²å¼ºåˆ¶ç¦æ­¢ä¼‘çœ "

      # 2. å¯åŠ¨ VNC æœåŠ¡ (åªè®¾è¿æ¥å¯†ç ï¼Œä¸ç¢°ç³»ç»Ÿå¯†ç )
      - name: Start VNC Server
        run: |
          echo "æ­£åœ¨å¯åŠ¨ VNC..."
          
          # å¼€å¯è¿œç¨‹ç®¡ç†æƒé™
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # è®¾ç½® VNC ä¸“ç”¨è¿æ¥å¯†ç ä¸º MyStrongPass123!
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬é¿å¼€äº†ä¿®æ”¹ç³»ç»Ÿç”¨æˆ·å¯†ç ï¼Œåªæ”¹ VNC å¯†ç ï¼Œç»å¯¹ä¸ä¼šæŠ¥é”™
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw MyStrongPass123!
          
          echo "âœ… VNC æœåŠ¡å·²å¯åŠ¨ï¼Œå¯†ç è®¾ä¸º: MyStrongPass123!"

      # 3. å¯åŠ¨ Ngrok (è®© RealVNC è½¯ä»¶èƒ½è¿ä¸Š)
      - name: Start Ngrok Tunnel
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          brew install ngrok/ngrok/ngrok
          
          # è½¬å‘ 5900 ç«¯å£
          ngrok tcp 5900 --log=stdout > ngrok.log &
          
          echo "æ­£åœ¨å»ºç«‹è¿æ¥..."
          sleep 10
          
          echo "========================================================"
          echo "ğŸš€ è¿æ¥æˆåŠŸï¼è¯·åœ¨ RealVNC Viewer é¡¶éƒ¨æ¡†è¾“å…¥ï¼š"
          echo "--------------------------------------------------------"
          grep -o "tcp://.*:[0-9]*" ngrok.log
          echo "--------------------------------------------------------"
          echo "ğŸ”‘ å¯†ç  (Password): MyStrongPass123!"
          echo "ğŸ‘¤ ç”¨æˆ·å (Username): (å¦‚æœä¸€å®šè¦å¡«ï¼Œè¯•è¯• runnerï¼Œæˆ–è€…ç•™ç©º)"
          echo "========================================================"

      - name: Keep Alive
        run: sleep 21600
