name: Fix-Black-Screen
on: workflow_dispatch

jobs:
  debug:
    runs-on: macos-latest
    timeout-minutes: 360
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. é‡ç½®å¯†ç 
      - name: Reset Runner Password
        run: |
          echo "æ­£åœ¨é‡ç½® runner å¯†ç ..."
          sudo dscl . -passwd /Users/runner "MyStrongPass123!"
          echo "âœ… å¯†ç é‡ç½®å®Œæˆ"

      # 2. ç¦æ­¢ç¡çœ 
      - name: Disable Sleep
        run: |
          sudo systemsetup -setcomputersleep Never
          sudo systemsetup -setdisplaysleep Never
          sudo defaults write /Library/Preferences/com.apple.screensaver loginWindowIdleTime 0
          echo "âœ… å·²ç¦æ­¢ä¼‘çœ "

      # 3. å¯åŠ¨ VNCï¼ˆå…³é”®ä¿®å¤ï¼‰
      - name: Start VNC Server
        run: |
          # æ¿€æ´»è¿œç¨‹ç®¡ç†
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -restart -agent -privs -all -allowAccessFor -allUsers
          
          # è®¾ç½® VNC å¯†ç ï¼ˆæ­£ç¡®æ–¹å¼ï¼‰
          echo "MyStrongPass123!" | sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw
          
          # é‡å¯æœåŠ¡
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent
          
          echo "âœ… VNC æœåŠ¡å¯åŠ¨å®Œæˆ"
          sleep 5
          
          # éªŒè¯ VNC æ˜¯å¦åœ¨ç›‘å¬
          netstat -an | grep 5900 || echo "âš ï¸  è­¦å‘Š: VNC ç«¯å£ 5900 æœªæ£€æµ‹åˆ°"

      # 4. å®‰è£…å¹¶å¯åŠ¨ noVNC
      - name: Setup noVNC
        run: |
          # å…‹éš† noVNC
          git clone --depth 1 https://github.com/novnc/noVNC.git
          git clone --depth 1 https://github.com/novnc/websockify.git noVNC/utils/websockify
          
          # å®‰è£…ä¾èµ–
          pip3 install numpy
          
          echo "âœ… noVNC å®‰è£…å®Œæˆ"

      - name: Start noVNC
        run: |
          cd noVNC
          # å¯åŠ¨ noVNCï¼ˆåå°è¿è¡Œï¼‰
          ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 > ../novnc.log 2>&1 &
          
          sleep 5
          
          # æ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆåŠŸ
          if lsof -i :6080 > /dev/null; then
            echo "âœ… noVNC å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£ 6080"
          else
            echo "âŒ noVNC å¯åŠ¨å¤±è´¥"
            cat ../novnc.log
            exit 1
          fi

      # 5. å¯åŠ¨ Cloudflare Tunnel
      - name: Start Cloudflare Tunnel
        run: |
          brew install cloudflared
          
          # å¯åŠ¨éš§é“
          cloudflared tunnel --url http://localhost:6080 > tunnel.log 2>&1 &
          
          # ç­‰å¾…éš§é“å»ºç«‹
          echo "ç­‰å¾… Cloudflare éš§é“å»ºç«‹..."
          sleep 15
          
          # æå–å¹¶æ˜¾ç¤ºè®¿é—®é“¾æ¥
          echo "========================================================"
          echo "ğŸŒ è¿œç¨‹æ¡Œé¢è®¿é—®é“¾æ¥ï¼š"
          echo "--------------------------------------------------------"
          grep -o 'https://.*\.trycloudflare.com' tunnel.log | head -n 1
          echo "--------------------------------------------------------"
          echo "ğŸ‘¤ VNC å¯†ç : MyStrongPass123!"
          echo "========================================================"
          
          # æ˜¾ç¤ºå®Œæ•´æ—¥å¿—ä»¥ä¾¿è°ƒè¯•
          echo ""
          echo "ğŸ“‹ Cloudflare éš§é“æ—¥å¿—:"
          cat tunnel.log

      # 6. ä¿æŒè¿è¡Œ
      - name: Keep Alive
        run: |
          echo "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨ï¼Œä¿æŒè¿è¡Œ 6 å°æ—¶..."
          sleep 21600
